<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- OGP (Open Graph Protocol) -->
    <meta property="og:title" content="ãƒªã‚¢ãƒ«ã‚¹ã‚¯ãƒ©ãƒƒãƒãã˜ - æœ¬ç‰©ã®ã‚ˆã†ãªè§¦æ„Ÿã®ãƒ‡ã‚¸ã‚¿ãƒ«ãã˜ä½“é¨“" />
    <meta property="og:description" content="æŒ‡ã‚„ãƒã‚¦ã‚¹ã§ã“ã™ã£ã¦æœ¬ç‰©ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒãã˜ä½“é¨“ï¼ã‚·ãƒ³ãƒœãƒ«ã‚’æƒãˆã¦æœ€å¤§10,000å††ç²å¾—ã€‚2ã¤æƒã£ã¦ã‚‚å½“ãŸã‚‹è¦ªåˆ‡è¨­è¨ˆã§èª°ã§ã‚‚æ¥½ã—ã‚ã‚‹ã€‚" />
    <meta property="og:image" content="https://hiroe28.github.io/llm-100days-challenge/day045-real-scratch-lottery/screenshot.png" />
    <meta property="og:url" content="https://hiroe28.github.io/llm-100days-challenge/day045-real-scratch-lottery/index.html" />
    <meta property="og:type" content="website" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="ãƒªã‚¢ãƒ«ã‚¹ã‚¯ãƒ©ãƒƒãƒãã˜" />
    <meta name="twitter:description" content="æŒ‡ã‚„ãƒã‚¦ã‚¹ã§ã“ã™ã£ã¦æœ¬ç‰©ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒãã˜ä½“é¨“ï¼ã‚·ãƒ³ãƒœãƒ«ã‚’æƒãˆã¦æœ€å¤§10,000å††ç²å¾—ã€‚2ã¤æƒã£ã¦ã‚‚å½“ãŸã‚‹è¦ªåˆ‡è¨­è¨ˆã§å­ä¾›ã‹ã‚‰å¤§äººã¾ã§æ¥½ã—ã‚ã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«ãã˜ã‚²ãƒ¼ãƒ ã€‚" />
    <meta name="twitter:image" content="https://hiroe28.github.io/llm-100days-challenge/day045-real-scratch-lottery/screenshot.png" />
    <title>ãƒªã‚¢ãƒ«ã‚¹ã‚¯ãƒ©ãƒƒãƒãã˜</title>
    <style>
        body {
            font-family: 'Arial', 'Hiragino Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #2c3e50, #4a6572);
            padding: 20px;
            color: white;
            transition: background 0.5s ease;
        }
        
        body.win-bg {
            background: linear-gradient(135deg, #2c5e50, #4a9572);
        }
        
        .game-container {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .game-container.win-effect {
            box-shadow: 0 15px 35px rgba(255, 215, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.4);
        }
        
        .header {
            margin-bottom: 10px;
            font-size: 28px;
            color: #ffd700;
            text-align: center;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }
        
        .instructions {
            margin-bottom: 15px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            line-height: 1.5;
            padding: 0 10px;
        }
        
        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .balance {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .price {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .card-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        .card-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #e0e0e0, #ffffff);
            z-index: 1;
        }
        
        .card-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            padding: 8px;
            box-sizing: border-box;
            z-index: 2;
        }
        
        .symbol-box {
            position: relative;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            color: #333;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        
        .symbol-box.revealed {
            animation: revealPulse 0.5s ease;
        }
        
        @keyframes revealPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .result-panel {
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            opacity: 0;
            transition: all 0.5s ease;
            transform: translateY(20px);
        }
        
        .result-panel.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .result-message {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .result-detail {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .win-message {
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
        }
        
        .lose-message {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        .action-button {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            outline: none;
        }
        
        .btn:hover {
            background: linear-gradient(45deg, #27ae60, #219653);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .scratch-counter {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 8px 15px;
            min-width: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 10;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .scratch-counter.warning {
            background-color: rgba(255, 87, 51, 0.8);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%   { transform: translateX(-50%) scale(1);   }
            50%  { transform: translateX(-50%) scale(1.1); }
            100% { transform: translateX(-50%) scale(1);   }
        }
        
        /* ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .loading-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .loading-text {
            color: #ffd700;
            font-size: 16px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #ffd700;
            opacity: 0;
            z-index: 90;
            transform-origin: center;
        }
        
        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .scratch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #b0b0b0, #d8d8d8);
            border-radius: 8px;
            z-index: 5;
            cursor: pointer;
            background-size: 20px 20px;
            background-image: linear-gradient(45deg, rgba(255,255,255,.3) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.3) 50%, rgba(255,255,255,.3) 75%, transparent 75%, transparent);
            transition: opacity 0.3s ease;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        .scratch-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            pointer-events: none;
            z-index: 6;
            filter: blur(5px);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .scratch-sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 6;
            opacity: 0;
        }
        
        @keyframes sparkle {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        /* æ®‹ã‚Šã‚¹ã‚¯ãƒ©ãƒƒãƒå›æ•°ã®è­¦å‘Šè¡¨ç¤º */
        .scratch-limit-warning {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background-color: rgba(255, 87, 51, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 20;
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s ease;
        }
        
        .scratch-limit-warning.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .win-pattern-highlight {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 9;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .win-pattern-highlight.show {
            opacity: 1;
        }
        
        .win-pattern-line {
            position: absolute;
            background-color: rgba(255, 215, 0, 0.6);
            z-index: 4;
            transform: scale(0);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }
        
        .win-pattern-line.show {
            transform: scale(1);
        }

        /* æ”¹å–„ï¼šãƒ«ãƒ¼ãƒ«è¡¨ç¤º - å¸¸ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ */
        .rules-panel {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        .rules-header {
            color: #ffd700;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        /* ä¿®æ­£ï¼šå½“é¸ãƒ«ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ« */
        .rules-table {
            width: 100%;
            margin: 10px 0;
            border-collapse: collapse;
        }
        
        .rules-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            vertical-align: middle;
        }
        
        .rules-table td:first-child {
            font-size: 22px;
            width: 60px;
            text-align: center;
        }
        
        .rules-table td:last-child {
            font-size: 16px;
            font-weight: bold;
            text-align: right;
            color: #ffd700;
        }
        
        .symbol-star {
            color: #FFEB3B;
        }
        
        .symbol-money {
            color: #FFD700;
        }
        
        .symbol-diamond {
            color: #40C4FF;
        }
        
        .symbol-spade {
            color: #FFFFFF;
        }
        
        .symbol-others {
            color: #FF9E80;
        }
        
        .symbol-clover {
            color: #76FF03;
        }

        /* å°å½“ãŸã‚Šé€šçŸ¥ */
        .bonus-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background-color: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 25;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .bonus-notification.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        /* ç„¡æ–™åˆ¸è¡¨ç¤º */
        .free-ticket-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #ff6b6b;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 20;
            transform: rotate(15deg);
            animation: pulse 1.5s infinite;
            display: none;
        }

        /* ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ãƒãƒƒã‚¸ - ä½ç½®ä¿®æ­£ */
        .gold-member-badge {
            position: absolute;
            top: -10px; 
            left: -10px;
            background: linear-gradient(45deg, #ffd700, #ffb700);
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 20;
            transform: rotate(-15deg);
            display: none;
        }
        
        /* è£œè¶³æƒ…å ±ã‚¹ã‚¿ã‚¤ãƒ« */
        .info-text {
            font-size: 14px;
            margin-top: 10px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">ãƒªã‚¢ãƒ«ã‚¹ã‚¯ãƒ©ãƒƒãƒãã˜</div>
        <div class="instructions">
            3ã¤ã¾ã§ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚’å‰Šã£ã¦ã€ã‚·ãƒ³ãƒœãƒ«ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼<br>
            åŒã˜ã‚·ãƒ³ãƒœãƒ«ãŒ3ã¤æƒã†ã¨å½“ãŸã‚Šé‡‘é¡ãŒç²å¾—ã§ãã‚‹ã‚ˆï¼
        </div>
        
        <div class="wallet-info">
            <div class="balance">æ‰€æŒé‡‘: <span id="balanceAmount">2000</span>å††</div>
            <div class="price">ãã˜1æš: <span id="ticketPrice">500</span>å††</div>
            <!-- ç„¡æ–™åˆ¸ãƒãƒƒã‚¸ã‚’æ‰€æŒé‡‘è¡¨ç¤ºã®ä¸Šã«ç§»å‹• -->
            <div class="free-ticket-badge" id="freeTicketBadge">ç„¡æ–™åˆ¸</div>
            <!-- ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ãƒãƒƒã‚¸ã‚’æ‰€æŒé‡‘è¡¨ç¤ºã®ä¸Šã«ç§»å‹• -->
            <div class="gold-member-badge" id="goldMemberBadge">ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡</div>
        </div>
        
        <div class="scratch-counter" id="scratchCounter">æ®‹ã‚Š: 3</div>
        <div class="card-container" id="cardContainer">
            <div class="card-background"></div>
            <div class="card-grid" id="symbolGrid"></div>
            <div class="win-pattern-highlight" id="winPatternHighlight"></div>
            <div class="scratch-limit-warning" id="scratchLimitWarning">æ®‹ã‚Š1å›ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒï¼</div>
            <div class="bonus-notification" id="bonusNotification">+100å††!</div>
        </div>
        
        <!-- ä¿®æ­£ï¼šçµæœãƒ‘ãƒãƒ«ã¨æ¬¡ã®ãã˜ãƒœã‚¿ãƒ³ã‚’å…ˆã«è¡¨ç¤º -->
        <div class="result-panel" id="resultPanel">
            <div class="result-message" id="resultMessage"></div>
            <div class="result-detail" id="resultDetail"></div>
        </div>
        
        <div class="action-button">
            <button class="btn" id="nextGameBtn">æ¬¡ã®ãã˜ã‚’è²·ã†</button>
        </div>
        
        <!-- ä¿®æ­£ï¼šãƒ«ãƒ¼ãƒ«è¡¨ç¤ºã‚’æœ€å¾Œã«ç§»å‹• -->
        <div class="rules-panel">
            <div class="rules-header">å½“é¸ãƒ«ãƒ¼ãƒ«</div>
            <table class="rules-table">
                <tr>
                    <td class="symbol-star">â˜…</td>
                    <td>3ã¤æƒã†ã¨</td>
                    <td>10,000å††</td>
                </tr>
                <tr>
                    <td class="symbol-money">ğŸ’°</td>
                    <td>3ã¤æƒã†ã¨</td>
                    <td>5,000å††</td>
                </tr>
                <tr>
                    <td class="symbol-diamond">ğŸ’</td>
                    <td>3ã¤æƒã†ã¨</td>
                    <td>3,000å††</td>
                </tr>
                <tr>
                    <td class="symbol-spade">â™ </td>
                    <td>3ã¤æƒã†ã¨</td>
                    <td>1,000å††</td>
                </tr>
                <tr>
                    <td class="symbol-clover">ğŸ€</td>
                    <td>1æšã§ã‚‚å‡ºã‚‹ã¨100å††ç²å¾—ï¼<br>3ã¤æƒã†ã¨</td>
                    <td>1,000å††</td>
                </tr>
                <!-- è¿½åŠ ï¼š2ã¤æƒã£ãŸå ´åˆã®ãƒ«ãƒ¼ãƒ« -->
                <tr>
                    <td>å…¨ã¦</td>
                    <td>2ã¤æƒã†ã¨</td>
                    <td>500å††</td>
                </tr>
            </table>
            <div class="info-text">
                ãƒ»æ‰€æŒé‡‘ãŒ5,000å††ã‚’è¶…ãˆã‚‹ã¨ã€ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã«ãªã‚Šå½“é¸ç¢ºç‡ã‚¢ãƒƒãƒ—ï¼<br>
                ãƒ»æ‰€æŒé‡‘ãŒ500å††æœªæº€ã§ãƒã‚ºãƒ¬ã‚‹ã¨ã€1å›ç„¡æ–™ã§ãã˜ãŒå¼•ã‘ã¾ã™
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">ãã˜ã‚’æº–å‚™ä¸­...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMè¦ç´ ã®å–å¾—
            const cardContainer = document.getElementById('cardContainer');
            const symbolGrid = document.getElementById('symbolGrid');
            const resultPanel = document.getElementById('resultPanel');
            const resultMessage = document.getElementById('resultMessage');
            const resultDetail = document.getElementById('resultDetail');
            const nextGameBtn = document.getElementById('nextGameBtn');
            const balanceAmount = document.getElementById('balanceAmount');
            const ticketPrice = document.getElementById('ticketPrice');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const scratchCounter = document.getElementById('scratchCounter');
            const scratchLimitWarning = document.getElementById('scratchLimitWarning');
            const winPatternHighlight = document.getElementById('winPatternHighlight');
            const bonusNotification = document.getElementById('bonusNotification');
            const freeTicketBadge = document.getElementById('freeTicketBadge');
            const goldMemberBadge = document.getElementById('goldMemberBadge');
            
            // å®šæ•°
            const TICKET_PRICE = 500;
            const INITIAL_BALANCE = 2000;
            const GRID_SIZE = 9; // 3x3ã®ã‚°ãƒªãƒƒãƒ‰
            const SCRATCH_THRESHOLD = 60; // ã“ã®%ä»¥ä¸Šã“ã™ã‚‹ã¨å®Œå…¨ã«å‰Šã‚ŒãŸã¨åˆ¤å®š
            const MAX_SCRATCHES = 3; // æœ€å¤§ã‚¹ã‚¯ãƒ©ãƒƒãƒå›æ•°
            
            // ä¿®æ­£: å°å½“ãŸã‚Šã‚·ãƒ³ãƒœãƒ«
            const BONUS_SYMBOL = 'ğŸ€';
            const BONUS_PAYOUT = 100; // 1æšã‚ãŸã‚Šã®æ‰•ã„æˆ»ã—
            const TWO_MATCH_PAYOUT = 500; // è¿½åŠ ï¼š2ã¤æƒã„ã®æ‰•ã„æˆ»ã—
            
            // éŸ³å£°åŠ¹æœ
            const SOUNDS = {
                scratch: new Audio('scratch_sound.mp3'),
                win: new Audio('win_sound.mp3'),
                jackpot: new Audio('jackpot_sound.mp3'),
                lose: new Audio('lose_sound.mp3'),
                reveal: new Audio('reveal_sound.mp3'),
                purchase: new Audio('purchase_sound.mp3'),
                hover: new Audio('hover_sound.mp3'),
                lastChance: new Audio('last_chance_sound.mp3'),
                bonus: new Audio('bonus_sound.mp3') // å°å½“ãŸã‚Šç”¨
            };
            
            // å„éŸ³é‡ã®è¨­å®š
            Object.values(SOUNDS).forEach(sound => {
                sound.volume = 0.7;
            });
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
            let balance = INITIAL_BALANCE;
            let gameActive = false;
            let gameResult = null;
            let symbols = [];
            let scratchedCells = Array(GRID_SIZE).fill(false);
            let scratchPercentages = Array(GRID_SIZE).fill(0);
            let canvasList = [];
            let ctxList = [];
            let remainingScratches = MAX_SCRATCHES;
            let revealedCells = [];
            let scratchableIndices = new Set(); // ã‚¹ã‚¯ãƒ©ãƒƒãƒå¯èƒ½ãªã‚»ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
            let winPatternShown = false;
            let selectedCells = new Set(); // é¸æŠã•ã‚ŒãŸã‚»ãƒ«ã‚’è¿½è·¡ã™ã‚‹æ–°ã—ã„å¤‰æ•°
            
            // ä¿®æ­£: ç„¡æ–™åˆ¸ãƒ•ãƒ©ã‚°
            let hasFreeTicket = false;
            
            // ä¿®æ­£: ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ãƒ•ãƒ©ã‚°
            let isGoldMember = false;
            
            // ä¿®æ­£: ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ³ãƒœãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆã¨æ”¯æ‰•ã„çŠ¶æ³ã®è¿½è·¡
            let bonusSymbolsRevealed = 0;
            let bonusSymbolsPaid = 0;
            
            // åˆæœŸåŒ–
            function init() {
                // é‡‘é¡ã®åˆæœŸè¡¨ç¤º
                balanceAmount.textContent = balance;
                ticketPrice.textContent = TICKET_PRICE;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                nextGameBtn.addEventListener('click', startNewGame);
                nextGameBtn.addEventListener('mouseover', () => playSound('hover'));
                
                // ã™ãã«æœ€åˆã®ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
                startNewGame();
            }
            
            // éŸ³ã‚’å†ç”Ÿ
            function playSound(type) {
                if (SOUNDS[type]) {
                    try {
                        SOUNDS[type].currentTime = 0;
                        SOUNDS[type].play().catch(e => console.log('Audio error:', e));
                    } catch (e) {
                        console.log('Audio error:', e);
                    }
                }
            }
            
            // ä¿®æ­£: ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
            function checkGoldUpgrade() {
                if (!isGoldMember && balance >= 5000) {
                    isGoldMember = true;
                    alert('ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã«ãªã‚Šã¾ã—ãŸï¼å½“é¸ç¢ºç‡ã‚¢ãƒƒãƒ—ï¼');
                    goldMemberBadge.style.display = 'block';
                }
            }
            
            // ç„¡æ–™åˆ¸ãƒã‚§ãƒƒã‚¯ãƒ»ä»˜ä¸æ©Ÿèƒ½
            function checkAndGrantFreeTicket() {
                // æ‰€æŒé‡‘ãŒè¶³ã‚Šãªã„ã‹ã¤ç„¡æ–™åˆ¸ã‚’æŒã£ã¦ã„ãªã„å ´åˆ
                if (balance < TICKET_PRICE && !hasFreeTicket) {
                    // ç„¡æ–™åˆ¸ã‚’ä»˜ä¸
                    hasFreeTicket = true;
                    freeTicketBadge.style.display = 'block';
                    console.log("æ‰€æŒé‡‘ä¸è¶³: ç„¡æ–™åˆ¸ã‚’ä»˜ä¸ã—ã¾ã—ãŸ");
                    return true;
                }
                return false;
            }
            
            // ç„¡æ–™åˆ¸ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆé–‹ç™ºç”¨ï¼‰
            function debugFreeTicket() {
                console.log(`ç„¡æ–™åˆ¸çŠ¶æ…‹: ${hasFreeTicket ? "ã‚ã‚Š" : "ãªã—"}`);
                console.log(`æ®‹é«˜: ${balance}å††`);
            }
            
            // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
            function startNewGame() {
                // ã‚²ãƒ¼ãƒ ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯é–‹å§‹ã—ãªã„
                if (gameActive) {
                    return;
                }
                
                // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
                debugFreeTicket();
                
                // æ‰€æŒé‡‘ãƒã‚§ãƒƒã‚¯ã¨ç„¡æ–™åˆ¸ä»˜ä¸ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
                if (balance < TICKET_PRICE && !hasFreeTicket) {
                    // æœ€åˆã®ç„¡æ–™åˆ¸ã‚’ä»˜ä¸
                    checkAndGrantFreeTicket();
                    alert('æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ãŒã€ç„¡æ–™åˆ¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼');
                }
                
                // æ”¹ã‚ã¦æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                if (balance < TICKET_PRICE && !hasFreeTicket) {
                    alert('æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ç„¡æ–™åˆ¸ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                
                // è³¼å…¥éŸ³ã‚’å†ç”Ÿ
                playSound('purchase');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                loadingOverlay.classList.add('show');
                
                // éåŒæœŸå‡¦ç†ã¨ã—ã¦å®Ÿè¡Œï¼ˆãƒªã‚¢ãƒ«ãªé…å»¶æ„Ÿã‚’å‡ºã™ï¼‰
                setTimeout(() => {
                    // ç„¡æ–™åˆ¸ãŒãªã‘ã‚Œã°æ‰€æŒé‡‘ã‚’æ¸›ã‚‰ã™
                    if (!hasFreeTicket) {
                        balance -= TICKET_PRICE;
                        balanceAmount.textContent = balance;
                    } else {
                        // ç„¡æ–™åˆ¸ã‚’ä½¿ç”¨
                        hasFreeTicket = false;
                        freeTicketBadge.style.display = 'none';
                    }
                    
                    // ã‚²ãƒ¼ãƒ ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                    gameActive = true;
                    
                    // ã‚¹ã‚¯ãƒ©ãƒƒãƒå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    remainingScratches = MAX_SCRATCHES;
                    scratchCounter.textContent = `æ®‹ã‚Š: ${remainingScratches}`;
                    scratchCounter.classList.remove('warning');
                    
                    // çµæœãƒ‘ãƒãƒ«ã‚’éš ã™
                    resultPanel.classList.remove('show');
                    
                    // ã‚·ãƒ³ãƒœãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ
                    generateSymbols();
                    
                    // ã‚·ãƒ³ãƒœãƒ«ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ
                    createSymbolGrid();
                    
                    // è¿½è·¡å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    revealedCells = [];
                    scratchableIndices = new Set(Array.from({length: GRID_SIZE}, (_, i) => i));
                    winPatternShown = false;
                    selectedCells.clear(); // é¸æŠæ¸ˆã¿ã‚»ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                    
                    // Winé–¢é€£ã®è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.body.classList.remove('win-bg');
                    document.querySelector('.game-container').classList.remove('win-effect');
                    winPatternHighlight.innerHTML = '';
                    winPatternHighlight.classList.remove('show');
                    
                    // ã‚¹ã‚¯ãƒ©ãƒƒãƒè­¦å‘Šè¡¨ç¤ºã‚’éš ã™
                    scratchLimitWarning.classList.remove('show');
                    
                    // ãƒœãƒ¼ãƒŠã‚¹é€šçŸ¥ã‚’ãƒªã‚»ãƒƒãƒˆ
                    bonusNotification.classList.remove('show');
                    
                    // æ¬¡ã®ã‚²ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                    nextGameBtn.style.display = 'none';
                    
                    // ä¿®æ­£: ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ³ãƒœãƒ«ã®è¿½è·¡ã‚’ãƒªã‚»ãƒƒãƒˆ
                    bonusSymbolsRevealed = 0;
                    bonusSymbolsPaid = 0;
                    
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
                    loadingOverlay.classList.remove('show');
                    
                    // ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                    checkGoldUpgrade();
                }, 800);
            }
            
            // ä¿®æ­£: ã‚·ãƒ³ãƒœãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ
            function generateSymbols() {
                // ä¿®æ­£: ã‚·ãƒ³ãƒœãƒ«ç¨®é¡ã‚’å‰Šæ¸›ã—ã¦å½“ãŸã‚Šã‚„ã™ã
                const possibleSymbols = ['â˜…', 'ğŸ’°', 'ğŸ’', 'â™ ', BONUS_SYMBOL];
                symbols = [];
                scratchedCells = Array(GRID_SIZE).fill(false);
                scratchPercentages = Array(GRID_SIZE).fill(0);
                
                // çµæœã‚’æ±ºå®šï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã¯å½“é¸ç¢ºç‡ã‚¢ãƒƒãƒ—ï¼‰
                const baseWinRate = isGoldMember ? 0.40 : 0.35;  // ã•ã‚‰ã«å‹ç‡ã‚¢ãƒƒãƒ—
                const isWinning = Math.random() < baseWinRate;
                
                if (isWinning) {
                    // å½“ãŸã‚Šã®å ´åˆã€ã©ã®ã‚·ãƒ³ãƒœãƒ«ãŒ3ã¤æƒã†ã‹ã‚’æ±ºå®š
                    const winningSymbol = possibleSymbols[Math.floor(Math.random() * possibleSymbols.length)];
                    
                    // å½“ãŸã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                    const winPatterns = [
                        [0, 1, 2], // ä¸Šæ¨ªä¸€åˆ—
                        [3, 4, 5], // ä¸­æ¨ªä¸€åˆ—
                        [6, 7, 8], // ä¸‹æ¨ªä¸€åˆ—
                        [0, 3, 6], // å·¦ç¸¦ä¸€åˆ—
                        [1, 4, 7], // ä¸­ç¸¦ä¸€åˆ—
                        [2, 5, 8], // å³ç¸¦ä¸€åˆ—
                        [0, 4, 8], // å·¦ä¸Šã‹ã‚‰å³ä¸‹
                        [2, 4, 6]  // å³ä¸Šã‹ã‚‰å·¦ä¸‹
                    ];
                    
                    const winningPattern = winPatterns[Math.floor(Math.random() * winPatterns.length)];
                    
                    // ã‚·ãƒ³ãƒœãƒ«ã‚’é…ç½®
                    for (let i = 0; i < GRID_SIZE; i++) {
                        if (winningPattern.includes(i)) {
                            symbols.push(winningSymbol);
                        } else {
                            // å½“ãŸã‚Šã‚·ãƒ³ãƒœãƒ«ä»¥å¤–ã®ãƒ©ãƒ³ãƒ€ãƒ ãªã‚·ãƒ³ãƒœãƒ«ã‚’é…ç½®
                            let otherSymbol;
                            do {
                                otherSymbol = possibleSymbols[Math.floor(Math.random() * possibleSymbols.length)];
                            } while (otherSymbol === winningSymbol && countSymbolOccurrences(symbols, otherSymbol) >= 2);
                            symbols.push(otherSymbol);
                        }
                    }
                    
                    // è³é‡‘é¡ã‚’æ±ºå®š
                    let prize = 500; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    
                    if (winningSymbol === 'â˜…') {
                        prize = 10000;
                    } else if (winningSymbol === 'ğŸ’°') {
                        prize = 5000;
                    } else if (winningSymbol === 'ğŸ’') {
                        prize = 3000;
                    } else if (winningSymbol === 'â™ ' || winningSymbol === BONUS_SYMBOL) {
                        prize = 1000;
                    }
                    
                    gameResult = {
                        isWin: true,
                        winningSymbol: winningSymbol,
                        prize: prize,
                        positions: winningPattern,
                        patternType: getPatternType(winningPattern)
                    };
                    
                } else {
                    // ãƒã‚ºãƒ¬ã®å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ãªã‚·ãƒ³ãƒœãƒ«ã‚’é…ç½®ï¼ˆæƒã‚ãªã„ã‚ˆã†ã«ï¼‰
                    const usedCounts = {};
                    
                    for (let i = 0; i < GRID_SIZE; i++) {
                        // ä¿®æ­£: å„ã‚·ãƒ³ãƒœãƒ«ãŒæœ€å¤§2å›ã—ã‹ç™»å ´ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                        let symbol;
                        let attempts = 0;
                        
                        do {
                            symbol = possibleSymbols[Math.floor(Math.random() * possibleSymbols.length)];
                            attempts++;
                            
                            // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
                            if (attempts > 50) {
                                break;
                            }
                        } while ((usedCounts[symbol] || 0) >= 2);
                        
                        usedCounts[symbol] = (usedCounts[symbol] || 0) + 1;
                        symbols.push(symbol);
                    }
                    
                    // æƒã‚ãªã„ã“ã¨ã‚’ç¢ºèª
                    ensureNoWinningPatterns();
                    
                    gameResult = {
                        isWin: false
                    };
                }
            }
            
            // ã‚·ãƒ³ãƒœãƒ«ã®å‡ºç¾å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            function countSymbolOccurrences(arr, symbol) {
                return arr.filter(s => s === symbol).length;
            }
            
            // å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãªã„ã“ã¨ã‚’ç¢ºèª
            function ensureNoWinningPatterns() {
                const winPatterns = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8], // æ¨ª
                    [0, 3, 6], [1, 4, 7], [2, 5, 8], // ç¸¦
                    [0, 4, 8], [2, 4, 6] // å¯¾è§’ç·š
                ];
                
                // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                for (const pattern of winPatterns) {
                    const [a, b, c] = pattern;
                    if (symbols[a] && symbols[a] === symbols[b] && symbols[b] === symbols[c]) {
                        // å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã®ã‚·ãƒ³ãƒœãƒ«ã‚’å¤‰æ›´
                        const possibleSymbols = ['â˜…', 'ğŸ’°', 'ğŸ’', 'â™ ', BONUS_SYMBOL];
                        let newSymbol;
                        
                        do {
                            newSymbol = possibleSymbols[Math.floor(Math.random() * possibleSymbols.length)];
                        } while (newSymbol === symbols[a]);
                        
                        // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ã®ã‚·ãƒ³ãƒœãƒ«ã‚’å¤‰æ›´
                        const posToChange = pattern[Math.floor(Math.random() * pattern.length)];
                        symbols[posToChange] = newSymbol;
                    }
                }
            }
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
            function getPatternType(pattern) {
                // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†é¡
                if (arraysEqual(pattern, [0, 1, 2])) return { type: 'row', position: 'top' };
                if (arraysEqual(pattern, [3, 4, 5])) return { type: 'row', position: 'middle' };
                if (arraysEqual(pattern, [6, 7, 8])) return { type: 'row', position: 'bottom' };
                
                if (arraysEqual(pattern, [0, 3, 6])) return { type: 'column', position: 'left' };
                if (arraysEqual(pattern, [1, 4, 7])) return { type: 'column', position: 'middle' };
                if (arraysEqual(pattern, [2, 5, 8])) return { type: 'column', position: 'right' };
                
                if (arraysEqual(pattern, [0, 4, 8])) return { type: 'diagonal', position: 'main' };
                if (arraysEqual(pattern, [2, 4, 6])) return { type: 'diagonal', position: 'counter' };
                
                return { type: 'unknown', position: '' };
            }
            
            // é…åˆ—ã®æ¯”è¼ƒ
            function arraysEqual(a, b) {
                if (a.length !== b.length) return false;
                for (let i = 0; i < a.length; i++) {
                    if (a[i] !== b[i]) return false;
                }
                return true;
            }

            // ä¸­å¤®ãŒå‰Šã‚‰ã‚ŒãŸã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
            function isCenterCleared(index) {
                const canvas = canvasList[index];
                const ctx = ctxList[index];
                if (!canvas || !ctx) return false;

                // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤® 5Ã—5 ãƒ”ã‚¯ã‚»ãƒ«ã® Î± ã‚’èª¿ã¹ã‚‹
                const cx = Math.floor(canvas.width / 2) - 2;
                const cy = Math.floor(canvas.height / 2) - 2;
                const data = ctx.getImageData(cx, cy, 5, 5).data;

                for (let i = 3; i < data.length; i += 4) {
                    if (data[i] === 0) return true; // é€æ˜ãŒï¼‘ã¤ã§ã‚‚ã‚ã‚Œã°ä¸­å¤®ãŒè¦‹ãˆãŸ
                }
                return false;
            }
            
            // ã‚·ãƒ³ãƒœãƒ«ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ
            function createSymbolGrid() {
                symbolGrid.innerHTML = '';
                canvasList = [];
                ctxList = [];
                
                for (let i = 0; i < GRID_SIZE; i++) {
                    const box = document.createElement('div');
                    box.className = 'symbol-box';
                    box.dataset.index = i;
                    
                    // ã‚·ãƒ³ãƒœãƒ«
                    box.innerHTML = symbols[i];
                    
                    // å½“ãŸã‚Šã®å ´åˆã€ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®è¦ç´ ã‚’è¿½åŠ 
                    if (gameResult.isWin && gameResult.positions.includes(i)) {
                        const highlight = document.createElement('div');
                        highlight.className = 'symbol-highlight';
                        highlight.style.backgroundColor = 'rgba(255, 215, 0, 0.3)';
                        highlight.style.position = 'absolute';
                        highlight.style.width = '100%';
                        highlight.style.height = '100%';
                        highlight.style.borderRadius = '8px';
                        highlight.style.opacity = '0';
                        highlight.style.top = '0';
                        highlight.style.left = '0';
                        highlight.style.zIndex = '4';
                        highlight.style.transition = 'opacity 0.3s ease';
                        box.appendChild(highlight);
                    }
                    
                    // ã‚¹ã‚¯ãƒ©ãƒƒãƒç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¿½åŠ 
                    const overlay = document.createElement('div');
                    overlay.className = 'scratch-overlay';
                    overlay.dataset.index = i;
                    
                    // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã®è¦ç´ 
                    const scratchEffect = document.createElement('div');
                    scratchEffect.className = 'scratch-effect';
                    overlay.appendChild(scratchEffect);
                    
                    // Canvasã‚’ä½œæˆ
                    const canvas = document.createElement('canvas');
                    canvas.style.position = 'absolute';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.zIndex = '20';
                    canvas.dataset.index = i;
                    
                    overlay.appendChild(canvas);
                    box.appendChild(overlay);
                    symbolGrid.appendChild(box);
                    
                    // Canvasã‚’åˆæœŸåŒ–
                    canvasList.push(canvas);
                    initCanvas(canvas, i);
                }
                
                // å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæº–å‚™
                if (gameResult.isWin) {
                    createWinPatternHighlight(gameResult.patternType, gameResult.positions);
                }
            }
            
            // å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä½œæˆ
            function createWinPatternHighlight(patternType, positions) {
                if (!patternType) return;
                
                const container = document.createElement('div');
                container.className = 'win-pattern-container';
                container.style.position = 'absolute';
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.zIndex = '4';
                container.style.pointerEvents = 'none';
                
                // å‹åˆ©ãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ç·šã‚’æç”»
                const line = document.createElement('div');
                line.className = 'win-pattern-line';
                line.style.position = 'absolute';
                line.style.backgroundColor = 'rgba(255, 215, 0, 0.6)';
                line.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.8)';
                line.style.zIndex = '8';
                line.style.transformOrigin = 'center';
                line.style.borderRadius = '3px';
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
                if (patternType.type === 'row') {
                    let top;
                    if (patternType.position === 'top') top = '16.7%';
                    else if (patternType.position === 'middle') top = '50%';
                    else top = '83.3%';
                    
                    line.style.width = '90%';
                    line.style.height = '6px';
                    line.style.top = `calc(${top} - 3px)`;
                    line.style.left = '5%';
                    
                } else if (patternType.type === 'column') {
                    let left;
                    if (patternType.position === 'left') left = '16.7%';
                    else if (patternType.position === 'middle') left = '50%';
                    else left = '83.3%';
                    
                    line.style.width = '6px';
                    line.style.height = '90%';
                    line.style.left = `calc(${left} - 3px)`;
                    line.style.top = '5%';
                    
                } else if (patternType.type === 'diagonal') {
                    line.style.width = '125%';
                    line.style.height = '6px';
                    line.style.top = 'calc(50% - 3px)';
                    line.style.left = '-12.5%';
                    
                    if (patternType.position === 'main') {
                        line.style.transform = 'rotate(45deg) scale(0)';
                    } else {
                        line.style.transform = 'rotate(-45deg) scale(0)';
                    }
                }
                
                container.appendChild(line);
                winPatternHighlight.innerHTML = '';
                winPatternHighlight.appendChild(container);
            }
            
            // å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¤º
            function showWinPattern() {
                if (winPatternShown) return;
                winPatternShown = true;
                
                const line = document.querySelector('.win-pattern-line');
                if (line) {
                    // å¯¾è§’ç·šã®å ´åˆã¯ç‰¹åˆ¥ãªå‡¦ç†
                    if (line.style.transform.includes('rotate')) {
                        if (line.style.transform.includes('45deg')) {
                            line.style.transform = 'rotate(45deg) scale(1)';
                        } else {
                            line.style.transform = 'rotate(-45deg) scale(1)';
                        }
                    } else {
                        line.style.transform = 'scale(1)';
                    }
                    
                    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¡¨ç¤º
                    winPatternHighlight.classList.add('show');
                    
                    // å‹åˆ©ã‚·ãƒ³ãƒœãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    highlightWinningSymbols();
                }
            }
            
            // å‹åˆ©ã‚·ãƒ³ãƒœãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            function highlightWinningSymbols() {
                if (gameResult.isWin) {
                    gameResult.positions.forEach(index => {
                        const box = document.querySelector(`.symbol-box[data-index="${index}"]`);
                        const highlight = box.querySelector('.symbol-highlight');
                        if (highlight) {
                            highlight.style.opacity = '1';
                        }
                    });
                }
            }
            
            // CanvasåˆæœŸåŒ–
            function initCanvas(canvas, index) {
                // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                canvas.addEventListener('mousedown', startScratch);
                canvas.addEventListener('mousemove', scratchMove);
                canvas.addEventListener('mouseup', endScratch);
                canvas.addEventListener('mouseleave', endScratch);
                
                canvas.addEventListener('touchstart', handleTouchStart);
                canvas.addEventListener('touchmove', handleTouchMove);
                canvas.addEventListener('touchend', handleTouchEnd);
                
                // Canvasã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
                updateCanvasSize(canvas);
                
                // æç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
                const ctx = canvas.getContext('2d');
                ctxList[index] = ctx;
                
                // éŠ€è‰²ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æç”»
                drawScratchLayer(ctx, canvas.width, canvas.height);
            }
            
            // Canvasã‚µã‚¤ã‚ºã‚’æ›´æ–°
            function updateCanvasSize(canvas) {
                const index = parseInt(canvas.dataset.index);
                const box = document.querySelector(`.symbol-box[data-index="${index}"]`);
                if (!box) return;
                
                const boxRect = box.getBoundingClientRect();
                canvas.width = boxRect.width;
                canvas.height = boxRect.height;
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æç”»
            function drawScratchLayer(ctx, width, height) {
                // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
                const gradient = ctx.createLinearGradient(0, 0, width, height);
                gradient.addColorStop(0, '#a0a0a0');
                gradient.addColorStop(0.5, '#d0d0d0');
                gradient.addColorStop(1, '#a0a0a0');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
                ctx.save();
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç·šã‚’æç”»
                for (let i = 0; i < width + height; i += 15) {
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.lineWidth = 1;
                    ctx.moveTo(0, i);
                    ctx.lineTo(i, 0);
                    ctx.stroke();
                }
                
                for (let i = 0; i < width + height; i += 25) {
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.lineWidth = 1;
                    ctx.moveTo(width, i);
                    ctx.lineTo(i, height);
                    ctx.stroke();
                }
                
                ctx.restore();
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒé–‹å§‹
            function startScratch(e) {
                if (!gameActive) return;
                
                e.preventDefault();
                
                // ã‚»ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
                const index = parseInt(e.target.dataset.index);
                if (isNaN(index)) return;
                
                // æ—¢ã«ã‚¹ã‚¯ãƒ©ãƒƒãƒã•ã‚ŒãŸã‚»ãƒ«ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (scratchedCells[index]) return;
                
                // ã¾ã é¸æŠã•ã‚Œã¦ã„ãªã„ã‚»ãƒ«ã‹ã¤æ—¢ã«æœ€å¤§æ•°é¸æŠæ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (!selectedCells.has(index)) {
                    if (selectedCells.size >= MAX_SCRATCHES) {
                        // 3ãƒã‚¹é¸æŠæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã•ã›ãªã„
                        playSound('lastChance'); // è­¦å‘ŠéŸ³
                        return;
                    }
                    selectedCells.add(index); // æ–°è¦ã«é¸ã‚“ã ãƒã‚¹ã‚’ç™»éŒ²
                }
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒæƒ…å ±ã‚’åˆæœŸåŒ–
                const scratchInfo = {
                    index: index,
                    isDrawing: true,
                    lastX: e.offsetX,
                    lastY: e.offsetY
                };
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’eventã«è¿½åŠ 
                e.target.scratchInfo = scratchInfo;
                
                // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
                playSound('scratch');
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒå‡¦ç†
                doScratch(e.target, e.offsetX, e.offsetY);
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                showScratchEffect(index, e.offsetX, e.offsetY);
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒä¸­
            function scratchMove(e) {
                if (!gameActive || !e.target.scratchInfo || !e.target.scratchInfo.isDrawing) return;
                
                e.preventDefault();
                
                const index = e.target.scratchInfo.index;
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒå‡¦ç†
                doScratch(e.target, e.offsetX, e.offsetY);
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                showScratchEffect(index, e.offsetX, e.offsetY);
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒçµ‚äº†
            function endScratch(e) {
                if (!e.target.scratchInfo) return;
                
                e.target.scratchInfo.isDrawing = false;
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’éè¡¨ç¤º
                hideScratchEffect(e.target.scratchInfo.index);
            }
            
            // ã‚¿ãƒƒãƒé–‹å§‹
            function handleTouchStart(e) {
                if (!gameActive) return;
                
                e.preventDefault();
                
                const touch = e.touches[0];
                const canvas = e.target;
                const rect = canvas.getBoundingClientRect();
                
                // ã‚»ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
                const index = parseInt(canvas.dataset.index);
                if (isNaN(index)) return;
                
                // æ—¢ã«ã‚¹ã‚¯ãƒ©ãƒƒãƒã•ã‚ŒãŸã‚»ãƒ«ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (scratchedCells[index]) return;
                
                // ã¾ã é¸æŠã•ã‚Œã¦ã„ãªã„ã‚»ãƒ«ã‹ã¤æ—¢ã«æœ€å¤§æ•°é¸æŠæ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (!selectedCells.has(index)) {
                    if (selectedCells.size >= MAX_SCRATCHES) {
                        // 3ãƒã‚¹é¸æŠæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã•ã›ãªã„
                        playSound('lastChance'); // è­¦å‘ŠéŸ³
                        return;
                    }
                    selectedCells.add(index); // æ–°è¦ã«é¸ã‚“ã ãƒã‚¹ã‚’ç™»éŒ²
                }
                
                // ã‚¿ãƒƒãƒä½ç½®ã®ç›¸å¯¾åº§æ¨™ã‚’è¨ˆç®—
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒæƒ…å ±ã‚’åˆæœŸåŒ–
                const scratchInfo = {
                    index: index,
                    isDrawing: true,
                    lastX: offsetX,
                    lastY: offsetY
                };
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’eventã«è¿½åŠ 
                canvas.scratchInfo = scratchInfo;
                
                // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
                playSound('scratch');
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒå‡¦ç†
                doScratch(canvas, offsetX, offsetY);
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                showScratchEffect(index, offsetX, offsetY);
            }
            
            // ã‚¿ãƒƒãƒç§»å‹•
            function handleTouchMove(e) {
                if (!gameActive || !e.target.scratchInfo || !e.target.scratchInfo.isDrawing) return;
                
                e.preventDefault();
                
                const touch = e.touches[0];
                const canvas = e.target;
                const rect = canvas.getBoundingClientRect();
                const index = e.target.scratchInfo.index;
                
                // ã‚¿ãƒƒãƒä½ç½®ã®ç›¸å¯¾åº§æ¨™ã‚’è¨ˆç®—
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒå‡¦ç†
                doScratch(canvas, offsetX, offsetY);
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                showScratchEffect(index, offsetX, offsetY);
            }
            
            // ã‚¿ãƒƒãƒçµ‚äº†
            function handleTouchEnd(e) {
                if (!e.target.scratchInfo) return;
                
                const index = e.target.scratchInfo.index;
                e.target.scratchInfo.isDrawing = false;
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’éè¡¨ç¤º
                hideScratchEffect(index);
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
            function showScratchEffect(index, x, y) {
                const box = document.querySelector(`.symbol-box[data-index="${index}"]`);
                if (!box) return;
                
                const effect = box.querySelector('.scratch-effect');
                if (!effect) return;
                
                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ä½ç½®ã‚’è¨­å®š
                effect.style.left = `${x - 15}px`;
                effect.style.top = `${y - 15}px`;
                effect.style.opacity = '1';
                
                // ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
                createSparkles(box, x, y);
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’éè¡¨ç¤º
            function hideScratchEffect(index) {
                const box = document.querySelector(`.symbol-box[data-index="${index}"]`);
                if (!box) return;
                
                const effect = box.querySelector('.scratch-effect');
                if (!effect) return;
                
                effect.style.opacity = '0';
            }
            
            // ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            function createSparkles(box, x, y) {
                for (let i = 0; i < 4; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'scratch-sparkle';
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 15 + 10;
                    const sparkleX = x + Math.cos(angle) * distance;
                    const sparkleY = y + Math.sin(angle) * distance;
                    
                    sparkle.style.left = `${sparkleX}px`;
                    sparkle.style.top = `${sparkleY}px`;
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    sparkle.style.animation = `sparkle ${Math.random() * 0.5 + 0.2}s ease-out`;
                    
                    box.appendChild(sparkle);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å‰Šé™¤
                    setTimeout(() => {
                        sparkle.remove();
                    }, 700);
                }
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒå‡¦ç†
            function doScratch(canvas, x, y) {
                const info = canvas.scratchInfo;
                const index = info.index;
                const ctx = ctxList[index];
                
                if (!ctx) return;
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã®ç·šã‚’æç”»
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 30;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(info.lastX, info.lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // æœ€å¾Œã®ä½ç½®ã‚’æ›´æ–°
                info.lastX = x;
                info.lastY = y;
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒå‰²åˆã‚’è¨ˆç®—
                calculateScratchPercentage(index);
                
                // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚»ãƒ«ã‚’æ›´æ–°
                updateScratchedCell(index);
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒå‰²åˆã®è¨ˆç®—
            function calculateScratchPercentage(index) {
                const canvas = canvasList[index];
                const ctx = ctxList[index];
                
                if (!canvas || !ctx) return;
                
                // ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // é€æ˜ãƒ”ã‚¯ã‚»ãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                let transparentPixels = 0;
                for (let i = 3; i < data.length; i += 4) {
                    if (data[i] === 0) { // å®Œå…¨ã«é€æ˜
                        transparentPixels++;
                    }
                }
                
                // å‰²åˆã‚’è¨ˆç®—ï¼ˆ%ï¼‰
                const totalPixels = data.length / 4;
                const percentage = (transparentPixels / totalPixels) * 100;
                
                // çŠ¶æ…‹ã‚’æ›´æ–°
                scratchPercentages[index] = percentage;
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒã‚»ãƒ«ã‚’æ›´æ–°
            function updateScratchedCell(index) {
                // é€šå¸¸ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒã—ãã„å€¤ã¾ãŸã¯ä¸­å¤®ãŒã‚¹ã‚¯ãƒ©ãƒƒãƒã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
                const percentage = scratchPercentages[index];
                const cleared = percentage >= SCRATCH_THRESHOLD || isCenterCleared(index);
                
                if (cleared && !scratchedCells[index]) {
                    // å®Œå…¨ã«å‰Šã‚‰ã‚ŒãŸå ´åˆ
                    scratchedCells[index] = true;
                    
                    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å®Œå…¨ã«å‰Šé™¤
                    const overlay = document.querySelector(`.symbol-box[data-index="${index}"] .scratch-overlay`);
                    if (overlay) overlay.style.opacity = '0';
                    
                    // å‰Šã‚ŒãŸã‚»ãƒ«ã‚’è¿½è·¡
                    if (!revealedCells.includes(index)) {
                        revealedCells.push(index);
                        
                        // ã‚¹ã‚¯ãƒ©ãƒƒãƒå¯èƒ½ãªã‚»ãƒ«ã‹ã‚‰å‰Šé™¤
                        scratchableIndices.delete(index);
                        
                        // æ®‹ã‚Šã‚¹ã‚¯ãƒ©ãƒƒãƒå›æ•°ã‚’æ¸›ã‚‰ã™
                        decrementScratches();
                        
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
                        const box = document.querySelector(`.symbol-box[data-index="${index}"]`);
                        if (box) box.classList.add('revealed');
                        setTimeout(() => {
                            if (box) box.classList.remove('revealed');
                        }, 500);
                        
                        // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
                        playSound('reveal');
                        
                        // ä¿®æ­£: ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ³ãƒœãƒ«ãƒã‚§ãƒƒã‚¯
                        if (symbols[index] === BONUS_SYMBOL) {
                            bonusSymbolsRevealed++;
                            checkBonusPayout(index);
                        }
                    }
                    
                    // å‹åˆ©æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                    checkWinCondition();
                }
            }
            
            // ä¿®æ­£: ãƒœãƒ¼ãƒŠã‚¹æ”¯æ‰•ã„ãƒã‚§ãƒƒã‚¯
            function checkBonusPayout(index) {
                if (!gameActive) return;
                
                // æ—¢ã«æ”¯æ‰•ã„æ¸ˆã¿ã®ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ³ãƒœãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (bonusSymbolsPaid >= bonusSymbolsRevealed) return;
                
                // ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ³ãƒœãƒ«ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€æ”¯æ‰•ã„
                balance += BONUS_PAYOUT;
                balanceAmount.textContent = balance;
                bonusSymbolsPaid++;
                
                // ãƒœãƒ¼ãƒŠã‚¹é€šçŸ¥ã‚’è¡¨ç¤º
                bonusNotification.textContent = `+${BONUS_PAYOUT}å††!`;
                bonusNotification.classList.add('show');
                
                // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
                playSound('bonus');
                
                // é€šçŸ¥ã‚’è‡ªå‹•çš„ã«éè¡¨ç¤º
                setTimeout(() => {
                    bonusNotification.classList.remove('show');
                }, 1500);
                
                // ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                checkGoldUpgrade();
            }
            
            // ã‚¹ã‚¯ãƒ©ãƒƒãƒå›æ•°ã‚’æ¸›ã‚‰ã™
            function decrementScratches() {
                if (remainingScratches > 0) {
                    remainingScratches--;
                    scratchCounter.textContent = `æ®‹ã‚Š: ${remainingScratches}`;
                    
                    // æ®‹ã‚Š1å›ã®å ´åˆã¯è­¦å‘Šè¡¨ç¤º
                    if (remainingScratches === 1) {
                        scratchCounter.classList.add('warning');
                        playSound('lastChance');
                        scratchLimitWarning.classList.add('show');
                        
                        // 2ç§’å¾Œã«è­¦å‘Šã‚’éè¡¨ç¤º
                        setTimeout(() => {
                            scratchLimitWarning.classList.remove('show');
                        }, 2000);
                    }
                    
                    // ã‚¹ã‚¯ãƒ©ãƒƒãƒãŒå°½ããŸå ´åˆ
                    if (remainingScratches === 0) {
                        // çµæœã‚’è¡¨ç¤ºï¼ˆå°‘ã—é…å»¶ï¼‰
                        setTimeout(checkWinCondition, 500);
                    }
                }
            }
            
            // è¿½åŠ : 2ã¤æƒã„ãƒã‚§ãƒƒã‚¯
            function checkTwoMatches() {
                // å…¨ã‚·ãƒ³ãƒœãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
                const symbolCounts = {};
                
                // è¦‹ã¤ã‹ã£ãŸã‚·ãƒ³ãƒœãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                revealedCells.forEach(index => {
                    const symbol = symbols[index];
                    symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
                });
                
                // 2ã¤æƒã„ã®ã‚·ãƒ³ãƒœãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª
                let twoMatchSymbol = null;
                for (const symbol in symbolCounts) {
                    if (symbolCounts[symbol] === 2) {
                        twoMatchSymbol = symbol;
                        break;
                    }
                }
                
                return twoMatchSymbol;
            }
            
            // å‹åˆ©æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
            function checkWinCondition() {
                if (!gameActive) return;
                
                let shouldShowResult = false;
                
                // ä¿®æ­£: ã‚¯ãƒ­ãƒ¼ãƒãƒ¼3ã¤æƒã„ã®ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
                if (bonusSymbolsRevealed === 3 && !winPatternShown) {
                    // ã‚¯ãƒ­ãƒ¼ãƒãƒ¼ãŒ3ã¤æƒã£ãŸå ´åˆã¯ç‰¹åˆ¥ã«å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆ
                    const cloverIndices = [];
                    for (let i = 0; i < symbols.length; i++) {
                        if (symbols[i] === BONUS_SYMBOL && revealedCells.includes(i)) {
                            cloverIndices.push(i);
                        }
                    }
                    
                    if (cloverIndices.length === 3) {
                        // ã‚¯ãƒ­ãƒ¼ãƒãƒ¼3ã¤æƒã„ã®å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š
                        gameResult = {
                            isWin: true,
                            winningSymbol: BONUS_SYMBOL,
                            prize: 1000,
                            positions: cloverIndices,
                            patternType: { type: 'special', position: 'clover' }
                        };
                        
                        // å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¤º
                        showWinPattern();
                        shouldShowResult = true;
                    }
                }
                else if (gameResult.isWin) {
                    // å½“ãŸã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚·ãƒ³ãƒœãƒ«ãŒå…¨ã¦è¦‹ã¤ã‹ã£ãŸã‹ç¢ºèª
                    const winningRevealed = gameResult.positions.filter(pos => revealedCells.includes(pos));
                    
                    if (winningRevealed.length === 3) {
                        // å½“ãŸã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå…¨ã¦è¦‹ã¤ã‹ã£ãŸ
                        shouldShowResult = true;
                        // å‹åˆ©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¤º
                        showWinPattern();
                    } else if (remainingScratches === 0) {
                        // ã‚¹ã‚¯ãƒ©ãƒƒãƒãŒå°½ããŸå ´åˆ
                        shouldShowResult = true;
                    }
                } else if (remainingScratches === 0) {
                    // ãƒã‚ºãƒ¬ã®å ´åˆã€ã‚¹ã‚¯ãƒ©ãƒƒãƒãŒå°½ããŸã‚‰çµæœè¡¨ç¤º
                    shouldShowResult = true;
                }
                
                // çµæœè¡¨ç¤º
                if (shouldShowResult) {
                    showResult();
                }
            }
            
            // çµæœã‚’è¡¨ç¤º
            function showResult() {
                gameActive = false;
                
                // çµæœãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                resultPanel.classList.add('show');
                
                if (gameResult.isWin && gameResult.positions.every(pos => revealedCells.includes(pos))) {
                    // å½“ãŸã‚Šã®å ´åˆ
                    document.body.classList.add('win-bg');
                    document.querySelector('.game-container').classList.add('win-effect');
                    
                    resultMessage.textContent = `ãŠã‚ã§ã¨ã†ï¼${gameResult.prize}å††ã®å½“ãŸã‚Šï¼`;
                    resultMessage.className = 'result-message win-message';
                    resultDetail.textContent = `${gameResult.winningSymbol} ãŒ3ã¤æƒã„ã¾ã—ãŸï¼`;
                    
                    // æ‰€æŒé‡‘ã‚’å¢—ã‚„ã™
                    balance += gameResult.prize;
                    balanceAmount.textContent = balance;
                    
                    // ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                    checkGoldUpgrade();
                    
                    // å‹åˆ©éŸ³ã‚’å†ç”Ÿ
                    if (gameResult.prize >= 5000) {
                        playSound('jackpot');
                    } else {
                        playSound('win');
                    }
                    
                    // å¤§ããªå½“ãŸã‚Šã®å ´åˆã¯ã‚³ãƒ³ãƒ•ã‚§ãƒ†ã‚£ã‚’è¡¨ç¤º
                    if (gameResult.prize >= 3000) {
                        createConfetti();
                    }
                } else {
                    // è¿½åŠ : 2ã¤æƒã„ã®ãƒã‚§ãƒƒã‚¯
                    const twoMatchSymbol = checkTwoMatches();
                    
                    if (twoMatchSymbol) {
                        // 2ã¤æƒã„ã®å ´åˆã¯å°å½“ãŸã‚Š
                        document.body.classList.add('win-bg');
                        document.querySelector('.game-container').classList.add('win-effect');
                        
                        resultMessage.textContent = `ãŠã‚ã§ã¨ã†ï¼${TWO_MATCH_PAYOUT}å††ã®å½“ãŸã‚Šï¼`;
                        resultMessage.className = 'result-message win-message';
                        resultDetail.textContent = `${twoMatchSymbol} ãŒ2ã¤æƒã„ã¾ã—ãŸï¼`;
                        
                        // æ‰€æŒé‡‘ã‚’å¢—ã‚„ã™
                        balance += TWO_MATCH_PAYOUT;
                        balanceAmount.textContent = balance;
                        
                        // ã‚´ãƒ¼ãƒ«ãƒ‰ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                        checkGoldUpgrade();
                        
                        // å‹åˆ©éŸ³ã‚’å†ç”Ÿ
                        playSound('win');
                    } else {
                        // å®Œå…¨ãªãƒã‚ºãƒ¬ã®å ´åˆï¼ˆãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ³ãƒœãƒ«ãŒã‚ã‚‹å ´åˆã¯é™¤ãï¼‰
                        if (bonusSymbolsRevealed === 0) {
                            resultMessage.textContent = 'ãƒã‚ºãƒ¬ï¼æ¬¡å›ã«æŒ‘æˆ¦ã—ã‚ˆã†ï¼';
                            resultMessage.className = 'result-message lose-message';
                            
                            if (gameResult.isWin && !gameResult.positions.every(pos => revealedCells.includes(pos))) {
                                resultDetail.textContent = 'æƒœã—ã„ï¼å½“ãŸã‚Šã‚’è¦‹é€ƒã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚';
                            } else {
                                resultDetail.textContent = 'æƒã†ã‚·ãƒ³ãƒœãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                            }
                            
                            // ãƒã‚ºãƒ¬éŸ³ã‚’å†ç”Ÿ
                            playSound('lose');
                            
                            // ä¿®æ­£: æ®‹é«˜ãŒå°‘ãªã„å ´åˆã«ç„¡æ–™åˆ¸ã‚’ä»˜ä¸
                            if (balance < TICKET_PRICE && !hasFreeTicket) {
                                hasFreeTicket = true;
                                freeTicketBadge.style.display = 'block';
                                
                                // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
                                console.log("ç„¡æ–™åˆ¸ä»˜ä¸!");
                                debugFreeTicket();
                                
                                // è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ 
                                resultDetail.textContent += ' ç„¡æ–™åˆ¸ã‚’ã‚²ãƒƒãƒˆã—ã¾ã—ãŸï¼';
                            }
                        } else {
                            // ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ³ãƒœãƒ«ãŒã‚ã£ãŸå ´åˆ
                            resultMessage.textContent = `${bonusSymbolsRevealed * BONUS_PAYOUT}å††ç²å¾—ï¼`;
                            resultMessage.className = 'result-message win-message';
                            resultDetail.textContent = `${BONUS_SYMBOL} ãŒ${bonusSymbolsRevealed}ã¤è¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼`;
                            
                            // å‹åˆ©éŸ³ã‚’å†ç”Ÿ
                            playSound('win');
                        }
                    }
                }
                
                // æ¬¡ã®ã‚²ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                nextGameBtn.style.display = 'block';
                
                // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
                debugFreeTicket();
            }
            
            // ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£åŠ¹æœ
            function createConfetti() {
                const confettiCount = 100;
                const colors = ['#ffd700', '#ff0000', '#00ff00', '#0000ff', '#ff00ff', '#00ffff', '#ff8c00', '#ffffff'];
                
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = -10 + 'px';
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = Math.random() * 8 + 4 + 'px';
                    
                    // æ§˜ã€…ãªå½¢çŠ¶
                    if (Math.random() > 0.5) {
                        confetti.style.borderRadius = '50%';
                    } else if (Math.random() > 0.5) {
                        confetti.style.borderRadius = '5px';
                    }
                    
                    confetti.style.opacity = '1';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    confetti.style.animation = `fall ${Math.random() * 3 + 2}s ease-in forwards ${Math.random() * 1.5}s`;
                    
                    document.body.appendChild(confetti);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
            
            // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
            window.addEventListener('resize', function() {
                if (gameActive) {
                    canvasList.forEach(canvas => {
                        updateCanvasSize(canvas);
                        
                        const index = parseInt(canvas.dataset.index);
                        if (!isNaN(index) && ctxList[index]) {
                            drawScratchLayer(ctxList[index], canvas.width, canvas.height);
                            
                            // ã™ã§ã«ã‚¹ã‚¯ãƒ©ãƒƒãƒã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
                            if (scratchPercentages[index] >= SCRATCH_THRESHOLD) {
                                ctxList[index].clearRect(0, 0, canvas.width, canvas.height);
                            }
                        }
                    });
                }
            });
            
            // åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
            init();
        });
    </script>
</body>
</html>