<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- OGP (Open Graph Protocol) -->
    <meta property="og:title" content="æ‰‹ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒãƒ«ãƒã‚²ãƒ¼ãƒ  - ãŠå­æ§˜å‘ã‘ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚²ãƒ¼ãƒ " />
    <meta property="og:description" content="ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã£ãŸæ‰‹ã®å‹•ãã‚„ã‚¿ãƒƒãƒã§éŠã¹ã‚‹3ã¤ã®ã‚²ãƒ¼ãƒ ï¼ˆå®æ¢ã—ã€è™¹è‰²ãŠçµµã‹ãã€éŸ³æ¥½ã‚²ãƒ¼ãƒ ï¼‰ã‚’æ­è¼‰ã€‚5æ­³ã®ãŠå­æ§˜ã§ã‚‚æ¥½ã—ãéŠã¹ã‚‹ç›´æ„Ÿçš„ãªæ“ä½œã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚²ãƒ¼ãƒ ã€‚" />
    <meta property="og:image" content="https://hiroe28.github.io/llm-100days-challenge/day036-gesture-multi-game/screenshot.png" />
    <meta property="og:url" content="https://hiroe28.github.io/llm-100days-challenge/day036-gesture-multi-game/index.html" />
    <meta property="og:type" content="website" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="æ‰‹ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒãƒ«ãƒã‚²ãƒ¼ãƒ " />
    <meta name="twitter:description" content="ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã£ãŸæ‰‹ã®å‹•ãã‚„ã‚¿ãƒƒãƒã§éŠã¹ã‚‹å®æ¢ã—ãƒ»è™¹è‰²ãŠçµµã‹ããƒ»éŸ³æ¥½ã‚²ãƒ¼ãƒ ã®3ç¨®é¡ã‚’æ­è¼‰ã€‚5æ­³ã®ãŠå­æ§˜ã§ã‚‚æ¥½ã—ã‚ã‚‹ç›´æ„Ÿçš„ãªæ“ä½œã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚²ãƒ¼ãƒ ä½“é¨“ã€‚" />
    <meta name="twitter:image" content="https://hiroe28.github.io/llm-100days-challenge/day036-gesture-multi-game/screenshot.png" />

    <title>æ‰‹ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒãƒ«ãƒã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Kosugi Maru', 'Arial', sans-serif;
            background-color: #000;
            color: white;
        }
        
        /* é¡åƒè¡¨ç¤ºã®ãŸã‚ã®å…±é€šã‚¯ãƒ©ã‚¹ */
        .mirror {
            transform: scaleX(-1);
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 10;
            opacity: 0.8; /* ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’å°‘ã—é€é */
        }
        
        #hand-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            pointer-events: none;
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            pointer-events: none;
        }
        
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            pointer-events: none;
            display: none;
        }
        
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            z-index: 30;
            font-size: 16px;
            max-width: 300px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        #score-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 30;
            font-size: 20px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        #target {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(255, 0, 0, 0.7);
            z-index: 25;
            pointer-events: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px red;
            display: none;
        }
        
        #countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px;
            color: white;
            z-index: 40;
            text-shadow: 0 0 20px rgba(0, 0, 255, 0.8);
            display: none;
        }
        
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 50;
            text-align: center;
            display: none;
            width: 300px;
            border: 3px solid #4CAF50;
        }
        
        #start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 30px;
            border-radius: 15px;
            z-index: 50;
            text-align: center;
            width: 80%;
            max-width: 500px;
            border: 3px solid #4CAF50;
        }
        
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 60;
            text-align: center;
            display: none;
            width: 300px;
            border: 3px solid #f44336;
        }
        
        #mode-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        button:hover {
            background-color: #45a049;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        .mode-button {
            width: 140px;
            height: 100px;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #2196F3;
            border: 2px solid #0b7dda;
        }
        
        .mode-button:nth-child(1) {
            background-color: #FF9800;
            border-color: #e68a00;
        }
        
        .mode-button:nth-child(2) {
            background-color: #9C27B0;
            border-color: #7B1FA2;
        }
        
        .mode-button:nth-child(3) {
            background-color: #F44336;
            border-color: #d32f2f;
        }
        
        .mode-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .animation {
            position: absolute;
            font-size: 30px;
            font-weight: bold;
            color: yellow;
            z-index: 35;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 10px black;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }

        #home-button {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            z-index: 40;
            padding: 0;
        }

        .home-icon {
            display: inline-block;
            transform: translate(2px, 1px); /* â† æ¨ª1pxãƒ»ç¸¦1pxã ã‘å¾®èª¿æ•´ */
        }
        
        /* ãƒˆãƒ¬ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .treasure {
            position: absolute;
            width: 50px;
            height: 50px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 25;
            pointer-events: none;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 0 10px gold);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,5 L60,40 L95,40 L65,60 L75,95 L50,75 L25,95 L35,60 L5,40 L40,40 Z" fill="gold" stroke="orange" stroke-width="2"/></svg>');
        }
        
        /* ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #color-palette {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 20px;
            z-index: 35;
            display: none;
            flex-wrap: wrap; /* æŠ˜ã‚Šè¿”ã—ã‚’å¯èƒ½ã« */
            justify-content: center; /* ä¸­å¤®å¯„ã› */
            max-width: 500px; /* æœ€å¤§å¹…ã‚’è¨­å®š */
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            margin: 3px; /* ã™ã¹ã¦ã®ç”»é¢ã‚µã‚¤ã‚ºã§ä½™ç™½ã‚’è¿½åŠ  */
        }
        
        /* æ–°ã—ãè¿½åŠ ã™ã‚‹è™¹è‰²ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .rainbow-option {
            background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
            color: white;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 16;
            animation: sparkleAnim 1s linear forwards;
        }
        
        @keyframes sparkleAnim {
            0% {
                opacity: 1;
                transform: scale(0);
            }
            50% {
                opacity: 0.8;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }
        
        #clear-drawing {
            position: absolute;
            right: 20px;
            bottom: 20px;
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 35;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        /* æ–°ã—ã„è‰²ã¨éŸ³ã®ãƒãƒƒãƒãƒ³ã‚°ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        #color-music-container {
            position: absolute;
            top: 25%; /* ä¸Šéƒ¨ã«é…ç½®ã™ã‚‹ã‚ˆã†å¤‰æ›´ */
            left: 0;
            right: 0;
            transform: none; /* Yæ–¹å‘ã®å¤‰æ›ã‚’å‰Šé™¤ */
            display: flex;
            justify-content: center;
            gap: 30px;
            z-index: 25;
            display: none;
        }
        
        .music-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
            cursor: pointer;
            border: 3px solid white;
        }
        
        .music-circle.active {
            transform: scale(1.2);
            box-shadow: 0 0 30px white;
        }
        
        .music-circle[data-note="C4"] {
            background-color: #ff4136; /* èµ¤ (ãƒ‰) */
        }
        
        .music-circle[data-note="D4"] {
            background-color: #ff851b; /* ã‚ªãƒ¬ãƒ³ã‚¸ (ãƒ¬) */
        }
        
        .music-circle[data-note="E4"] {
            background-color: #ffdc00; /* é»„è‰² (ãƒŸ) */
        }
        
        .music-circle[data-note="F4"] {
            background-color: #2ecc40; /* ç·‘ (ãƒ•ã‚¡) */
        }
        
        .music-circle[data-note="G4"] {
            background-color: #0074d9; /* é’ (ã‚½) */
        }
        
        .music-circle[data-note="A4"] {
            background-color: #b10dc9; /* ç´« (ãƒ©) */
        }
        
        .music-circle[data-note="B4"] {
            background-color: #f012be; /* ãƒ”ãƒ³ã‚¯ (ã‚·) */
        }
        
        /* éŸ³ç¬¦ã®è¡¨ç¤º */
        .circle-note {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            z-index: 26;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            transform: translate(-50%, -50%);
            animation: pulse 1s infinite alternate;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }
        
        .hit-result {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 10px black;
            z-index: 35;
            pointer-events: none;
            animation: fadeOut 1s forwards;
        }
        
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(1.5);
            }
        }
        
        /* ãƒã‚¤ãƒ³ã‚¿è¡¨ç¤º */
        #finger-pointer {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, 0.8);
            border: 2px solid white;
            border-radius: 50%;
            z-index: 40;
            pointer-events: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px red;
            display: none;
        }
        
        /* ã‚¹ãƒãƒ›å¯¾å¿œã®ãŸã‚ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        @media (max-width: 768px) {
            /* èª¬æ˜ãƒ‘ãƒãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            #info-panel {
                top: 5px;
                left: 5px;
                font-size: 12px;
                padding: 5px;
                max-width: 150px;
                opacity: 0.8;
            }
            
            #score-panel {
                font-size: 16px;
                padding: 8px 15px;
                top: 5px;
                right: 5px;
            }
            
            .mode-button {
                width: 120px;
                height: 80px;
                font-size: 16px;
            }
            
            .mode-icon {
                font-size: 24px;
            }
            
            #countdown {
                font-size: 100px;
            }
            
            .treasure {
                width: 60px;
                height: 60px;
            }
            
            /* éŸ³æ¥½ã‚²ãƒ¼ãƒ ã®ã‚µãƒ¼ã‚¯ãƒ«ã‚’å°ã•ãã€é–“éš”ã‚’ç‹­ã */
            .music-circle {
                width: 60px;
                height: 60px;
                font-size: 16px;
            }
            
            #color-music-container {
                gap: 15px;
                top: 20%; /* ã•ã‚‰ã«ä¸Šéƒ¨ã« */
            }
            
            /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆéè¡¨ç¤ºï¼‰ */
            #color-palette {
                padding: 8px;
                bottom: 65px;
                flex-wrap: wrap;
                justify-content: center;
                max-width: 90%;
                gap: 5px;
                display: none;
            }
            
            .color-option {
                width: 40px;  /* å¤§ãã */
                height: 40px; /* å¤§ãã */
                margin: 3px;
            }
            
            /* ã‚¹ãƒãƒ›ç”¨ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ */
            #clear-drawing {
                padding: 10px 15px;
                font-size: 16px;
                right: 15px;
                bottom: 15px;
                width: auto;
            }
            
            #home-button {
                width: 45px;
                height: 45px;
                font-size: 20px;
                bottom: 15px;
                left: 15px;
                display: flex !important; /* ã‚¹ãƒãƒ›ã§ã‚‚ç¢ºå®Ÿã«è¡¨ç¤º */
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
</head>
<body>
    <div id="game-container">
        <!-- åŸºæœ¬çš„ãªãƒ“ãƒ‡ã‚ªã¨ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´  -->
        <video id="video" class="mirror" playsinline autoplay></video>
        <canvas id="hand-canvas" class="mirror"></canvas>
        <canvas id="game-canvas"></canvas>
        <canvas id="drawing-canvas"></canvas>
        
        <!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div id="info-panel">
            <div id="status">æ‰‹ã‚’ç”»é¢ã«æ˜ ã—ã¦å§‹ã‚ã‚ˆã†ï¼</div>
            <div id="instructions"></div>
        </div>
        
        <!-- ã‚¹ã‚³ã‚¢ãƒ‘ãƒãƒ« -->
        <div id="score-panel">
            <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
            <div>æ®‹ã‚Šæ™‚é–“: <span id="timer">30</span></div>
        </div>
        
        <!-- ã‚²ãƒ¼ãƒ è¦ç´  -->
        <div id="finger-pointer"></div>
        <div id="target"></div>
        <div id="countdown">3</div>
        
        <!-- ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰ã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆéè¡¨ç¤ºï¼‰ -->
        <div id="color-palette" style="display: none;">
            <div class="color-option rainbow-option" style="background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);" data-color="rainbow">ğŸŒˆ</div>
            <div class="color-option" style="background-color: red;" data-color="red"></div>
            <div class="color-option" style="background-color: blue;" data-color="blue"></div>
            <div class="color-option" style="background-color: green;" data-color="green"></div>
            <div class="color-option" style="background-color: yellow;" data-color="yellow"></div>
            <div class="color-option" style="background-color: purple;" data-color="purple"></div>
            <div class="color-option" style="background-color: orange;" data-color="orange"></div>
            <div class="color-option" style="background-color: black;" data-color="black"></div>
            <div class="color-option" style="background-color: white;" data-color="white"></div>
        </div>
        
        <!-- ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰ç”¨ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼ˆå³ä¸‹ã«é…ç½®ï¼‰ -->
        <button id="clear-drawing">ã‚¯ãƒªã‚¢</button>
        
        <!-- è‰²ã¨éŸ³ã®ãƒãƒƒãƒãƒ³ã‚°ã‚²ãƒ¼ãƒ ç”¨ã®å†† -->
        <div id="color-music-container">
            <div class="music-circle" data-note="C4" data-label="ãƒ‰">ãƒ‰</div>
            <div class="music-circle" data-note="D4" data-label="ãƒ¬">ãƒ¬</div>
            <div class="music-circle" data-note="E4" data-label="ãƒŸ">ãƒŸ</div>
            <div class="music-circle" data-note="F4" data-label="ãƒ•ã‚¡">ãƒ•ã‚¡</div>
            <div class="music-circle" data-note="G4" data-label="ã‚½">ã‚½</div>
        </div>
        
        <!-- ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ -->
        <button id="home-button"><span class="home-icon">ğŸ </span></button>
        
        <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
        <div id="game-over">
            <h2>ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
            <p>ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <span id="final-score">0</span></p>
            <button id="restart-button">ã‚‚ã†ä¸€åº¦éŠã¶</button>
            <button id="back-to-menu-button">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
        
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen">
            <h1>æ‰‹ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒãƒ«ãƒã‚²ãƒ¼ãƒ </h1>
            <p>æ‰‹ã‚„ã‚¿ãƒƒãƒã§éŠã¹ã‚‹3ã¤ã®æ¥½ã—ã„ã‚²ãƒ¼ãƒ ãŒã‚ã‚‹ã‚ˆï¼</p>
            <p>éŠã³ãŸã„ã‚²ãƒ¼ãƒ ã‚’é¸ã‚“ã§ã­ï¼</p>
            
            <div id="mode-buttons">
                <button class="mode-button" id="treasure-mode">
                    <span class="mode-icon">ğŸ’</span>
                    å®æ¢ã—
                </button>
                <button class="mode-button" id="draw-mode">
                    <span class="mode-icon">ğŸ¨</span>
                    ãŠçµµã‹ã
                </button>
                <button class="mode-button" id="rhythm-mode">
                    <span class="mode-icon">ğŸµ</span>
                    éŸ³æ¥½ã‚²ãƒ¼ãƒ 
                </button>
            </div>
        </div>
        
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="error-message">
            <h3>ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“</h3>
            <p id="error-details">ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ã‚«ãƒ¡ãƒ©ãŒåˆ©ç”¨ã§ããªã„ã‹ã€è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
            <p>å¼•ãç¶šãã‚¿ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§ã‚²ãƒ¼ãƒ ã‚’ãŠæ¥½ã—ã¿ã„ãŸã ã‘ã¾ã™ã€‚</p>
            <button id="error-ok-button">OK</button>
        </div>
    </div>

    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // ã‚²ãƒ¼ãƒ å…±é€šã®å¤‰æ•°
        let score = 0;
        let gameTime = 30;
        let gameActive = false;
        let timer;
        let currentMode = null;
        let isMobileDevice = false;
        let useCamera = true; // ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹
        
        // MediaPipeé–¢é€£ã®å¤‰æ•°
        let video, hands, handCanvas, handCtx;
        let camera;
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹é–¢é€£ã®å¤‰æ•°
        let gameCanvas, gameCtx;
        let drawingCanvas, drawingCtx;
        
        // è¦ç´ ã®å‚ç…§
        let statusDisplay, scoreDisplay, timerDisplay;
        let countdown, gameOverScreen, finalScoreDisplay;
        let startScreen, homeButton, colorPalette;
        let instructionsDisplay, fingerPointer;
        let errorMessage, errorDetails, errorOkButton;
        let colorMusicContainer;
        
        // å®‰å…¨é ˜åŸŸã®è¨­å®šï¼ˆUIãƒ‘ãƒãƒ«ãŒã‚ã‚‹å ´æ‰€ã‚’é¿ã‘ã‚‹ï¼‰
        const safeArea = {
            top: 150, // ä¸Šéƒ¨ã®UIãƒ‘ãƒãƒ«ã®é«˜ã•
            left: 80, // å·¦å´ã®UIãƒ‘ãƒãƒ«ã®å¹…
            right: 150, // å³å´ã®UIãƒ‘ãƒãƒ«ã®å¹…
            bottom: 80 // ä¸‹éƒ¨ã®ä½™ç™½
        };
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆéŸ³ã‚’é³´ã‚‰ã™ãŸã‚ï¼‰
        let audioCtx;
        let currentSound = null;
        
        // éŸ³ç¬¦ã®å‘¨æ³¢æ•°ãƒãƒƒãƒ”ãƒ³ã‚°
        const noteFrequencies = {
            'C4': 261.63, // ãƒ‰
            'D4': 293.66, // ãƒ¬
            'E4': 329.63, // ãƒŸ
            'F4': 349.23, // ãƒ•ã‚¡
            'G4': 392.00, // ã‚½
            'A4': 440.00, // ãƒ©
            'B4': 493.88  // ã‚·
        };
        
        // è™¹è‰²ã®ãƒšãƒ³ç”¨ã®å¤‰æ•°
        let rainbowMode = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è™¹è‰²ãƒ¢ãƒ¼ãƒ‰
        let rainbowHue = 0; // è‰²ç›¸ï¼ˆ0-360ï¼‰
        
        // è™¹è‰²ç”¨ã®HSLã‚«ãƒ©ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function getRainbowColor(hue) {
            return `hsl(${hue}, 100%, 50%)`;
        }
        
        // éŸ³ã‚’é³´ã‚‰ã™é–¢æ•°
        function playSound(freq, duration, volume = 0.5) {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // å‰ã®éŸ³ãŒé³´ã£ã¦ã„ãŸã‚‰åœæ­¢
                if (currentSound) {
                    currentSound.stop();
                }
                
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.value = freq;
                gainNode.gain.value = volume;
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.start();
                
                // å‚ç…§ã‚’ä¿æŒ
                currentSound = oscillator;
                
                setTimeout(() => {
                    oscillator.stop();
                    // ç¾åœ¨ã®éŸ³ã¨ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿nullã«
                    if (currentSound === oscillator) {
                        currentSound = null;
                    }
                }, duration);
                
                return true;
            } catch (e) {
                console.log('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
                return false;
            }
        }
        
        // ç°¡æ˜“çš„ãªåŠ¹æœéŸ³
        const sounds = {
            collect: () => playSound(800, 200, 0.3),
            success: () => playSound(1200, 300, 0.3),
            fail: () => playSound(300, 300, 0.3),
            countdown: () => playSound(600, 200, 0.3),
            gameOver: () => {
                playSound(800, 200, 0.3);
                setTimeout(() => playSound(600, 200, 0.3), 200);
                setTimeout(() => playSound(400, 400, 0.3), 400);
            },
            note: (note) => {
                const freq = noteFrequencies[note] || 440;
                return playSound(freq, 500, 0.4);
            }
        };
        
        // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        
        // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã®æ¤œå‡º
        function detectMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // HTTPSã‹ã©ã†ã‹ã®æ¤œå‡º
        function isSecureContext() {
            return window.location.protocol === 'https:' || 
                   window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1';
        }
        
        // ã‚¹ãƒªãƒ¼ãƒ—é–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // å®‰å…¨ãªä½ç½®ã‚’è¨ˆç®—ï¼ˆUIã¨é‡ãªã‚‰ãªã„ï¼‰
        function getSafePosition() {
            const safeWidth = window.innerWidth - safeArea.left - safeArea.right;
            const safeHeight = window.innerHeight - safeArea.top - safeArea.bottom;
            
            return {
                x: safeArea.left + Math.random() * safeWidth,
                y: safeArea.top + Math.random() * safeHeight
            };
        }
        
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å‡¦ç†
        async function startCountdown() {
            countdown.style.display = 'block';
            countdown.textContent = '3';
            sounds.countdown();
            await sleep(1000);
            countdown.textContent = '2';
            sounds.countdown();
            await sleep(1000);
            countdown.textContent = '1';
            sounds.countdown();
            await sleep(1000);
            countdown.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
            sounds.success();
            await sleep(800);
            countdown.style.display = 'none';
            startGame();
        }
        
        // ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
        function startGame() {
            gameActive = true;
            score = 0; // ã‚¹ã‚³ã‚¢ã‚’å¿…ãšãƒªã‚»ãƒƒãƒˆ
            scoreDisplay.textContent = score;
            
            // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦æ™‚é–“ã¨è¡¨ç¤ºè¨­å®š
            if (currentMode === 'draw') {
                gameTime = 60; // ãŠçµµã‹ãã¯é•·ã‚
                score_panel.style.display = 'block'; // ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆä¿®æ­£ï¼‰
            } else {
                gameTime = 30; // ä»–ã®ã‚²ãƒ¼ãƒ ã¯é€šå¸¸
                score_panel.style.display = 'block'; // ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ã‚³ã‚¢è¡¨ç¤º
            }
            
            timerDisplay.textContent = gameTime;
            gameOverScreen.style.display = 'none';
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®åˆæœŸåŒ–
            if (currentMode === 'treasure') {
                startTreasureHunt();
            } else if (currentMode === 'draw') {
                startDrawingMode();
            } else if (currentMode === 'rhythm') {
                startColorMusicGame();
            }
            
            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            clearInterval(timer); // å¿µã®ãŸã‚æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            timer = setInterval(() => {
                gameTime--;
                timerDisplay.textContent = gameTime;
                
                if (gameTime <= 0) {
                    endGame();
                }
            }, 1000);
        }
        
        // ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
        function endGame() {
            gameActive = false;
            clearInterval(timer);
            
            finalScoreDisplay.textContent = score;
            gameOverScreen.style.display = 'block';
            sounds.gameOver();
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®çµ‚äº†å‡¦ç†
            if (currentMode === 'treasure') {
                endTreasureHunt();
            } else if (currentMode === 'draw') {
                endDrawingMode();
            } else if (currentMode === 'rhythm') {
                endColorMusicGame();
            }
        }
        
        // ã‚¹ã‚³ã‚¢åŠ ç®—æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function showScoreAnimation(x, y, points) {
            const animation = document.createElement('div');
            animation.className = 'animation';
            animation.textContent = '+' + points;
            animation.style.left = x + 'px';
            animation.style.top = y + 'px';
            
            document.body.appendChild(animation);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
            setTimeout(() => {
                if (animation.parentNode) {
                    document.body.removeChild(animation);
                }
            }, 1000);
        }
        
        // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°
        function createSparkle(x, y) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.left = x + 'px';
            sparkle.style.top = y + 'px';
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚’è¨­å®š
            const hue = Math.random() * 360;
            sparkle.style.backgroundColor = `hsla(${hue}, 100%, 70%, 0.8)`;
            
            document.body.appendChild(sparkle);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
            setTimeout(() => {
                if (sparkle.parentNode) {
                    document.body.removeChild(sparkle);
                }
            }, 1000);
        }
        
        // ===== ãƒˆãƒ¬ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ =====
        
        const treasures = [];
        const treasureTypes = [
            { type: 'star', value: 10, color: 'gold' },
            { type: 'diamond', value: 20, color: 'cyan' },
            { type: 'ruby', value: 30, color: 'red' }
        ];
        
        function startTreasureHunt() {
            // èª¬æ˜ã‚’æ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
            instructionsDisplay.innerHTML = `
                <p>ğŸ‘‰ äººå·®ã—æŒ‡ã§å®çŸ³ã‚’ã‚¿ãƒƒãƒï¼</p>
            `;
            
            // æ—¢å­˜ã®å®çŸ³ã‚’ã‚¯ãƒªã‚¢
            endTreasureHunt();
            
            // æœ€åˆã®å®çŸ³ã‚’ç”Ÿæˆ
            createTreasure();
            
            // è¿½åŠ ã®å®çŸ³ã‚’ç”Ÿæˆ
            setTimeout(() => createTreasure(), 500);
        }
        
        function endTreasureHunt() {
            // å…¨ã¦ã®å®çŸ³ã‚’å‰Šé™¤
            treasures.forEach(treasure => {
                if (treasure.element && treasure.element.parentNode) {
                    treasure.element.parentNode.removeChild(treasure.element);
                }
            });
            treasures.length = 0;
        }
        
        function createTreasure() {
            if (!gameActive || currentMode !== 'treasure') return;
            
            // å®çŸ³ã®ã‚¿ã‚¤ãƒ—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºã‚ã‚‹ï¼ˆã‚¹ã‚³ã‚¢ãŒé«˜ã„ã»ã©ä¾¡å€¤ã®é«˜ã„å®çŸ³ãŒå‡ºã‚„ã™ã„ï¼‰
            let treasureTypeIndex;
            const rand = Math.random();
            if (score > 200) {
                treasureTypeIndex = rand < 0.5 ? 2 : (rand < 0.8 ? 1 : 0);
            } else if (score > 100) {
                treasureTypeIndex = rand < 0.3 ? 2 : (rand < 0.7 ? 1 : 0);
            } else {
                treasureTypeIndex = rand < 0.1 ? 2 : (rand < 0.4 ? 1 : 0);
            }
            
            const treasureType = treasureTypes[treasureTypeIndex];
            
            // å®‰å…¨ãªä½ç½®ã«é…ç½®ï¼ˆUIã¨é‡ãªã‚‰ãªã„ï¼‰
            const position = getSafePosition();
            
            // å®çŸ³ã®è¦ç´ ã‚’ä½œæˆ
            const treasureElement = document.createElement('div');
            treasureElement.className = 'treasure';
            treasureElement.style.width = '60px';
            treasureElement.style.height = '60px';
            treasureElement.style.left = position.x + 'px';
            treasureElement.style.top = position.y + 'px';
            
            // å®çŸ³ã®ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¦‹ãŸç›®ã‚’å¤‰æ›´
            if (treasureType.type === 'star') {
                treasureElement.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,5 L60,40 L95,40 L65,60 L75,95 L50,75 L25,95 L35,60 L5,40 L40,40 Z" fill="gold" stroke="orange" stroke-width="2"/></svg>')`;
            } else if (treasureType.type === 'diamond') {
                treasureElement.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,5 L95,40 L50,95 L5,40 Z" fill="cyan" stroke="blue" stroke-width="2"/></svg>')`;
            } else if (treasureType.type === 'ruby') {
                treasureElement.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M20,20 L80,20 L95,50 L50,95 L5,50 Z" fill="red" stroke="darkred" stroke-width="2"/></svg>')`;
            }
            
            document.body.appendChild(treasureElement);
            
            // å®çŸ³æƒ…å ±ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
            const treasure = {
                position,
                element: treasureElement,
                type: treasureType.type,
                value: treasureType.value,
                collected: false
            };
            
            treasures.push(treasure);
            
            // ä¸€å®šæ™‚é–“å¾Œã«è‡ªå‹•çš„ã«æ¶ˆãˆã‚‹
            setTimeout(() => {
                if (treasure.element && treasure.element.parentNode && !treasure.collected) {
                    treasure.element.parentNode.removeChild(treasure.element);
                    const index = treasures.indexOf(treasure);
                    if (index !== -1) {
                        treasures.splice(index, 1);
                    }
                    
                    // æ–°ã—ã„å®çŸ³ã‚’ç”Ÿæˆ
                    if (gameActive && currentMode === 'treasure') {
                        createTreasure();
                    }
                }
            }, 3000 + Math.random() * 2000); // 3ã€œ5ç§’ã§ãƒ©ãƒ³ãƒ€ãƒ ã«æ¶ˆãˆã‚‹
        }
        
        function checkTreasureCollection(fingerPosition) {
            for (let i = 0; i < treasures.length; i++) {
                const treasure = treasures[i];
                if (treasure.collected) continue;
                
                // æŒ‡å…ˆã¨å®çŸ³ã®è·é›¢ã‚’è¨ˆç®—
                const distance = Math.sqrt(
                    Math.pow(fingerPosition.x - treasure.position.x, 2) +
                    Math.pow(fingerPosition.y - treasure.position.y, 2)
                );
                
                // å®çŸ³ã«è§¦ã‚ŒãŸå ´åˆï¼ˆè·é›¢ã‚’å¤§ãã‚ã«è¨­å®šï¼‰
                if (distance < 60) {
                    // å®çŸ³ã‚’é›†ã‚ãŸå‡¦ç†
                    treasure.collected = true;
                    treasure.element.style.animation = 'collect 0.5s forwards';
                    
                    // ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—
                    score += treasure.value;
                    scoreDisplay.textContent = score;
                    
                    // åŠ¹æœéŸ³
                    sounds.collect();
                    
                    // ã‚¹ã‚³ã‚¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    showScoreAnimation(treasure.position.x, treasure.position.y, treasure.value);
                    
                    // å®çŸ³ã‚’å‰Šé™¤
                    setTimeout(() => {
                        if (treasure.element && treasure.element.parentNode) {
                            treasure.element.parentNode.removeChild(treasure.element);
                            
                            // æ–°ã—ã„å®çŸ³ã‚’ç”Ÿæˆ
                            if (gameActive && currentMode === 'treasure') {
                                createTreasure();
                                
                                // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦è¿½åŠ ã§å®çŸ³ã‚’ç”Ÿæˆ
                                if (score > 100 && Math.random() < 0.3) {
                                    setTimeout(createTreasure, 500);
                                }
                            }
                        }
                    }, 500);
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                    statusDisplay.textContent = `${treasure.type}ã®å®çŸ³ã‚’ã‚²ãƒƒãƒˆï¼ +${treasure.value}ç‚¹`;
                    
                    return true;
                }
            }
            
            return false;
        }
        
        // ===== ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰ =====
        
        let isDrawing = false;
        let currentColor = 'red';
        let brushSize = 5;
        let lastX = null;
        let lastY = null;
        
        function startDrawingMode() {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’è¡¨ç¤º
            drawingCanvas.style.display = 'block';
            // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã¯éè¡¨ç¤ºï¼ˆè™¹è‰²ãƒ¢ãƒ¼ãƒ‰ã®ã¿ä½¿ç”¨ï¼‰
            colorPalette.style.display = 'none';
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('clear-drawing').style.display = 'block';
            
            // èª¬æ˜ã‚’æ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
            instructionsDisplay.innerHTML = `
                <p>ğŸ‘‰ äººå·®ã—æŒ‡ã§æã“ã†ï¼</p>
            `;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è™¹è‰²ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            rainbowMode = true;
        }
        
        function endDrawingMode() {
            drawingCanvas.style.display = 'none';
            colorPalette.style.display = 'none';
            document.getElementById('clear-drawing').style.display = 'none';
            isDrawing = false;
            lastX = null;
            lastY = null;
        }
        
        function setupDrawingEvents() {
            // è‰²ãƒ‘ãƒ¬ãƒƒãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                option.addEventListener('click', function() {
                    console.log('è‰²ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', this.dataset.color);
                    
                    if (this.dataset.color === 'rainbow') {
                        rainbowMode = true;
                    } else {
                        rainbowMode = false;
                        currentColor = this.dataset.color;
                    }
                    
                    colorOptions.forEach(opt => opt.style.borderWidth = '2px');
                    this.style.borderWidth = '4px';
                    sounds.success();
                });
                
                // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
                option.addEventListener('touchstart', function(e) {
                    console.log('è‰²ãŒã‚¿ãƒƒãƒã•ã‚Œã¾ã—ãŸ:', this.dataset.color);
                    
                    if (this.dataset.color === 'rainbow') {
                        rainbowMode = true;
                    } else {
                        rainbowMode = false;
                        currentColor = this.dataset.color;
                    }
                    
                    colorOptions.forEach(opt => opt.style.borderWidth = '2px');
                    this.style.borderWidth = '4px';
                    sounds.success();
                    e.preventDefault(); // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ¬ã‚’é˜²æ­¢
                });
            });
            
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã«ã‚‚åŒæ§˜ã®å‡¦ç†ã‚’è¿½åŠ 
            const clearButton = document.getElementById('clear-drawing');
            clearButton.addEventListener('click', function() {
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                sounds.success();
            });
            
            clearButton.addEventListener('touchstart', function(e) {
                console.log('ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒã‚¿ãƒƒãƒã•ã‚Œã¾ã—ãŸ');
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                sounds.success();
                e.preventDefault();
            });
        }
        
        function draw(x, y) {
            if (!isDrawing) return;
            
            drawingCtx.lineJoin = 'round';
            drawingCtx.lineCap = 'round';
            
            // è™¹è‰²ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è‰²ã‚’è‡ªå‹•çš„ã«å¤‰åŒ–
            if (rainbowMode) {
                rainbowHue = (rainbowHue + 2) % 360;
                drawingCtx.strokeStyle = getRainbowColor(rainbowHue);
            } else {
                drawingCtx.strokeStyle = currentColor;
            }
            
            drawingCtx.lineWidth = brushSize;
            
            // æœ€åˆã®ãƒã‚¤ãƒ³ãƒˆã®å ´åˆã¯ä½ç½®ã‚’è¨˜éŒ²ã™ã‚‹ã ã‘
            if (lastX === null || lastY === null) {
                lastX = x;
                lastY = y;
                return;
            }
            
            // ç·šã‚’æç”»
            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(x, y);
            drawingCtx.stroke();
            
            // æç”»ä¸­ã«ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªå°ã•ãªå††ï¼‰ã‚’è¿½åŠ 
            if (Math.random() < 0.2) { // 20%ã®ç¢ºç‡ã§
                const sparkleSize = Math.random() * 5 + 2;
                const sparkleX = x + (Math.random() * 20 - 10);
                const sparkleY = y + (Math.random() * 20 - 10);
                
                drawingCtx.fillStyle = `hsla(${Math.random() * 360}, 100%, 75%, 0.8)`;
                drawingCtx.beginPath();
                drawingCtx.arc(sparkleX, sparkleY, sparkleSize, 0, Math.PI * 2);
                drawingCtx.fill();
                
                // DOMè¦ç´ ã¨ã—ã¦ã®ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚‚è¿½åŠ 
                createSparkle(sparkleX, sparkleY);
            }
            
            // ç¾åœ¨ä½ç½®ã‚’æ›´æ–°
            lastX = x;
            lastY = y;
        }
        
        // ===== è‰²ã¨éŸ³ã®ãƒãƒƒãƒãƒ³ã‚°ã‚²ãƒ¼ãƒ  =====
        
        let musicCircles = [];
        let activeCircleIndex = -1;
        let sequenceInterval;
        let currentMelodyIndex = 0;
        let waitingForInput = false;
        let comboCount = 0;
        
        // ãƒ¡ãƒ­ãƒ‡ã‚£ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆç°¡å˜ãªãƒ¡ãƒ­ãƒ‡ã‚£ï¼‰
        const colorMelodies = [
            // ãã‚‰ãã‚‰æ˜Ÿ
            ['C4', 'C4', 'G4', 'G4', 'F4', 'F4', 'G4'],
            // ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ—
            ['C4', 'D4', 'E4', 'C4', 'E4', 'C4', 'E4'],
            // ãƒ¡ãƒªãƒ¼ã•ã‚“ã®ç¾Š
            ['E4', 'D4', 'C4', 'D4', 'E4', 'E4', 'E4']
        ];
        
        function startColorMusicGame() {
            // è‰²ã¨éŸ³ã®ãƒãƒƒãƒãƒ³ã‚°ã‚²ãƒ¼ãƒ ã‚’è¡¨ç¤º
            colorMusicContainer.style.display = 'flex';
            
            // èª¬æ˜ã‚’æ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
            instructionsDisplay.innerHTML = `
                <p>ğŸµ å…‰ã£ãŸè‰²ã‚’ã‚¿ãƒƒãƒï¼</p>
            `;
            
            // å¤‰æ•°ã®åˆæœŸåŒ–
            comboCount = 0;
            musicCircles = Array.from(document.querySelectorAll('.music-circle'));
            currentMelodyIndex = 0;
            activeCircleIndex = -1;
            waitingForInput = false;
            
            // éŸ³æ¥½ã‚µãƒ¼ã‚¯ãƒ«ã®ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            musicCircles.forEach(circle => {
                circle.addEventListener('click', function() {
                    if (!gameActive || !waitingForInput) return;
                    checkCircleHit(this);
                });
            });
            
            // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’é–‹å§‹
            clearInterval(sequenceInterval);
            setTimeout(playNextNote, 1000);
            
            sequenceInterval = setInterval(() => {
                if (gameActive && currentMode === 'rhythm') {
                    if (!waitingForInput) {
                        playNextNote();
                    }
                }
            }, 2500); // 2.5ç§’ã”ã¨ã«æ¬¡ã®éŸ³ç¬¦ã‚’å†ç”Ÿ
        }
        
        function endColorMusicGame() {
            clearInterval(sequenceInterval);
            colorMusicContainer.style.display = 'none';
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå††ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetActiveCircle();
        }
        
        function playNextNote() {
            if (!gameActive || currentMode !== 'rhythm') return;
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ¡ãƒ­ãƒ‡ã‚£ã‚’é¸æŠ
            const melodyIndex = Math.floor(Math.random() * colorMelodies.length);
            const melody = colorMelodies[melodyIndex];
            
            // ç¾åœ¨ã®ãƒ¡ãƒ­ãƒ‡ã‚£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            currentMelodyIndex = (currentMelodyIndex + 1) % melody.length;
            
            // éŸ³ç¬¦ã‚’å†ç”Ÿ
            const note = melody[currentMelodyIndex];
            
            // å¯¾å¿œã™ã‚‹å††ã‚’å…‰ã‚‰ã›ã‚‹
            const circleIndex = findCircleIndexByNote(note);
            setActiveCircle(circleIndex);
            
            // éŸ³ã‚’é³´ã‚‰ã™
            sounds.note(note);
            
            // å…¥åŠ›å¾…ã¡çŠ¶æ…‹ã«
            waitingForInput = true;
            
            // ä¸€å®šæ™‚é–“å¾Œã«è‡ªå‹•çš„ã«æ¬¡ã¸é€²ã‚€ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
            setTimeout(() => {
                if (waitingForInput && activeCircleIndex === circleIndex) {
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¿ãƒƒãƒ—ã—ãªã‹ã£ãŸ
                    showMissedNote();
                    resetActiveCircle();
                    waitingForInput = false;
                    comboCount = 0;
                }
            }, 2000); // 2ç§’ä»¥å†…ã«ã‚¿ãƒƒãƒ—ã—ãªã„ã¨ãƒŸã‚¹
        }
        
        function findCircleIndexByNote(note) {
            for (let i = 0; i < musicCircles.length; i++) {
                if (musicCircles[i].dataset.note === note) {
                    return i;
                }
            }
            return 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
        
        function setActiveCircle(index) {
            // ä»¥å‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå††ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetActiveCircle();
            
            // æ–°ã—ã„å††ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (index >= 0 && index < musicCircles.length) {
                musicCircles[index].classList.add('active');
                activeCircleIndex = index;
            }
        }
        
        function resetActiveCircle() {
            if (activeCircleIndex >= 0 && activeCircleIndex < musicCircles.length) {
                musicCircles[activeCircleIndex].classList.remove('active');
            }
            activeCircleIndex = -1;
        }
        
        function checkCircleHit(circle) {
            // æ­£ã—ã„å††ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸã‹
            const correctCircle = activeCircleIndex >= 0 && 
                                 musicCircles[activeCircleIndex] === circle;
            
            if (correctCircle) {
                // éŸ³ã‚’é³´ã‚‰ã™
                sounds.note(circle.dataset.note);
                
                // ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—
                const basePoints = 20;
                let points = basePoints;
                
                // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹
                comboCount++;
                if (comboCount > 1) {
                    points = Math.floor(points * (1 + Math.min(comboCount, 10) * 0.1));
                }
                
                score += points;
                scoreDisplay.textContent = score;
                
                // çµæœè¡¨ç¤º
                const circleRect = circle.getBoundingClientRect();
                const x = circleRect.left + circleRect.width / 2;
                const y = circleRect.top;
                
                let resultText = "GREAT!";
                if (comboCount > 1) {
                    resultText += ` x${comboCount}`;
                }
                
                showHitResult(x, y, resultText, 'lime');
                showScoreAnimation(x, y - 30, points);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                statusDisplay.textContent = `${circle.dataset.label}ã®éŸ³ã‚’é³´ã‚‰ã—ãŸï¼ +${points}ç‚¹`;
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                resetActiveCircle();
                waitingForInput = false;
            } else {
                // é–“é•ã£ãŸå††ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸ
                sounds.fail();
                
                const circleRect = circle.getBoundingClientRect();
                const x = circleRect.left + circleRect.width / 2;
                const y = circleRect.top;
                
                showHitResult(x, y, "MISS", 'red');
                
                // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
                comboCount = 0;
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                resetActiveCircle();
                waitingForInput = false;
            }
        }
        
        function showMissedNote() {
            if (activeCircleIndex >= 0 && activeCircleIndex < musicCircles.length) {
                const circle = musicCircles[activeCircleIndex];
                const circleRect = circle.getBoundingClientRect();
                const x = circleRect.left + circleRect.width / 2;
                const y = circleRect.top;
                
                showHitResult(x, y, "TOO LATE", 'red');
                sounds.fail();
            }
        }
        
        function showHitResult(x, y, text, color) {
            const resultElement = document.createElement('div');
            resultElement.className = 'hit-result';
            resultElement.style.left = x + 'px';
            resultElement.style.top = (y - 30) + 'px';
            resultElement.style.color = color;
            resultElement.textContent = text;
            
            document.body.appendChild(resultElement);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
            setTimeout(() => {
                if (resultElement.parentNode) {
                    document.body.removeChild(resultElement);
                }
            }, 1000);
        }
        
        // ===== MediaPipeã®åˆæœŸåŒ– =====
        
        function initMediaPipe() {
            video = document.getElementById('video');
            handCanvas = document.getElementById('hand-canvas');
            handCtx = handCanvas.getContext('2d');
            
            gameCanvas = document.getElementById('game-canvas');
            gameCtx = gameCanvas.getContext('2d');
            
            drawingCanvas = document.getElementById('drawing-canvas');
            drawingCtx = drawingCanvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
            handCanvas.width = window.innerWidth;
            handCanvas.height = window.innerHeight;
            gameCanvas.width = window.innerWidth;
            gameCanvas.height = window.innerHeight;
            drawingCanvas.width = window.innerWidth;
            drawingCanvas.height = window.innerHeight;
            
            // ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆãªã„ç’°å¢ƒã§ã¯ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (!useCamera) {
                return setupTouchEvents();
            }
            
            try {
                // MediaPipeãŒä½¿ç”¨å¯èƒ½ã‹ç¢ºèª
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('getUserMediaãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // Hands APIã®è¨­å®š
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                hands.onResults(onResults);
                
                // ã‚«ãƒ¡ãƒ©ã®è¨­å®š
                camera = new Camera(video, {
                    onFrame: async () => {
                        try {
                            await hands.send({image: video});
                        } catch (e) {
                            console.error('Handsã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:', e);
                        }
                    },
                    width: 1280,
                    height: 720
                });
                
                // ã‚«ãƒ¡ãƒ©èµ·å‹•
                camera.start().catch(error => {
                    console.error('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
                    showCameraError('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
                });
                
            } catch (error) {
                console.error('MediaPipeåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showCameraError('ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
            }
            
            // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ
            window.addEventListener('resize', () => {
                handCanvas.width = window.innerWidth;
                handCanvas.height = window.innerHeight;
                gameCanvas.width = window.innerWidth;
                gameCanvas.height = window.innerHeight;
                drawingCanvas.width = window.innerWidth;
                drawingCanvas.height = window.innerHeight;
            });
        }
        
        // ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
        function showCameraError(message) {
            errorDetails.textContent = message;
            errorMessage.style.display = 'block';
            useCamera = false;
            setupTouchEvents();
        }
        
        // MediaPipeã®çµæœå‡¦ç†
        function onResults(results) {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // æ‰‹ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const handLandmarks = results.multiHandLandmarks[0];
                const handedness = results.multiHandedness[0].label;
                
                // æ‰‹ã®èªè­˜ã‚’æç”»
                drawHand(handCtx, handLandmarks, handedness);
                
                // äººå·®ã—æŒ‡ã®ä½ç½®ã‚’å–å¾—
                const indexFinger = handLandmarks[8];  // äººå·®ã—æŒ‡ã®å…ˆç«¯
                
                // ç”»é¢åº§æ¨™ã«å¤‰æ›ï¼ˆé¡åƒåè»¢ã‚’è€ƒæ…®ï¼‰
                const indexFingerPosition = {
                    x: (1 - indexFinger.x) * handCanvas.width, // xåº§æ¨™ã‚’åè»¢
                    y: indexFinger.y * handCanvas.height
                };
                
                // äººå·®ã—æŒ‡ãŒä¸ŠãŒã£ã¦ã„ã‚‹ã‹ã®ç°¡æ˜“åˆ¤å®š
                const wrist = handLandmarks[0]; // æ‰‹é¦–
                const indexDIP = handLandmarks[7]; // äººå·®ã—æŒ‡ã®ç¬¬2é–¢ç¯€
                const isIndexUp = indexFinger.y < indexDIP.y && indexFinger.y < wrist.y;
                
                // æŒ‡ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                fingerPointer.style.display = 'block';
                fingerPointer.style.left = indexFingerPosition.x + 'px';
                fingerPointer.style.top = indexFingerPosition.y + 'px';
                
                // ã‚‚ã—ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ‰‹ãŒæ¤œå‡ºã•ã‚ŒãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹
                if (startScreen.style.display !== 'none' && currentMode) {
                    // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
                    if (countdown.style.display !== 'block') {
                        statusDisplay.textContent = 'ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ï¼';
                        startScreen.style.display = 'none';
                        homeButton.style.display = 'block';
                        startCountdown();
                    }
                }
                
                // ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã®å ´åˆã€ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè¡Œ
                if (gameActive) {
                    if (currentMode === 'treasure') {
                        // ãƒˆãƒ¬ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰: å®çŸ³ã¨ã®å½“ãŸã‚Šåˆ¤å®š
                        if (isIndexUp) {
                            checkTreasureCollection(indexFingerPosition);
                        }
                    } else if (currentMode === 'draw') {
                        // ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰: æç”»å‡¦ç†
                        if (isIndexUp) {
                            isDrawing = true;
                            draw(indexFingerPosition.x, indexFingerPosition.y);
                        } else {
                            isDrawing = false;
                            lastX = null;
                            lastY = null;
                        }
                    } else if (currentMode === 'rhythm') {
                        // è‰²ã¨éŸ³ã®ãƒãƒƒãƒãƒ³ã‚°ã‚²ãƒ¼ãƒ : ã‚µãƒ¼ã‚¯ãƒ«ã¨ã®å½“ãŸã‚Šåˆ¤å®š
                        if (isIndexUp && waitingForInput) {
                            // æŒ‡å…ˆã¨å„ã‚µãƒ¼ã‚¯ãƒ«ã¨ã®å½“ãŸã‚Šåˆ¤å®š
                            for (let i = 0; i < musicCircles.length; i++) {
                                const circle = musicCircles[i];
                                const rect = circle.getBoundingClientRect();
                                const circleCenterX = rect.left + rect.width / 2;
                                const circleCenterY = rect.top + rect.height / 2;
                                
                                const distance = Math.sqrt(
                                    Math.pow(indexFingerPosition.x - circleCenterX, 2) +
                                    Math.pow(indexFingerPosition.y - circleCenterY, 2)
                                );
                                
                                if (distance < rect.width / 2 + 20) {
                                    // ã‚µãƒ¼ã‚¯ãƒ«ã«è§¦ã‚ŒãŸ
                                    checkCircleHit(circle);
                                    break;
                                }
                            }
                        }
                    }
                }
            } else {
                // æ‰‹ãŒæ¤œå‡ºã•ã‚Œãªã„å ´åˆã¯ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«
                fingerPointer.style.display = 'none';
                
                // æ‰‹ãŒæ¤œå‡ºã•ã‚Œãªã„å ´åˆã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                if (startScreen.style.display === 'none' && !gameActive) {
                    statusDisplay.textContent = 'æ‰‹ã‚’ç”»é¢ã«æ˜ ã—ã¦ãã ã•ã„';
                }
                
                // ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æç”»ã‚’åœæ­¢
                if (currentMode === 'draw') {
                    isDrawing = false;
                    lastX = null;
                    lastY = null;
                }
            }
        }
        
        // æ‰‹ã®èªè­˜ã‚’æç”»ã™ã‚‹é–¢æ•°
        function drawHand(ctx, landmarks, handedness) {
            // æ‰‹ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æç”»
            ctx.fillStyle = handedness === 'Left' ? 'rgba(0, 255, 0, 0.7)' : 'rgba(0, 0, 255, 0.7)';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            
            // å„ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æç”»
            for (const landmark of landmarks) {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯æ—¢ã«mirrorã‚¯ãƒ©ã‚¹ã§åè»¢ã—ã¦ã„ã‚‹ãŸã‚ã€åº§æ¨™ã¯ãã®ã¾ã¾ä½¿ç”¨
                const x = landmark.x * ctx.canvas.width;
                const y = landmark.y * ctx.canvas.height;
                
                // å††ã‚’æç”»
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
            }
            
            // æŒ‡ã®æ¥ç¶šç·šã‚’æç”»
            ctx.strokeStyle = handedness === 'Left' ? 'rgba(0, 255, 0, 0.7)' : 'rgba(0, 0, 255, 0.7)';
            ctx.lineWidth = 3;
            
            // è¦ªæŒ‡
            drawConnection(ctx, landmarks, 0, 1);
            drawConnection(ctx, landmarks, 1, 2);
            drawConnection(ctx, landmarks, 2, 3);
            drawConnection(ctx, landmarks, 3, 4);
            
            // äººå·®ã—æŒ‡
            drawConnection(ctx, landmarks, 0, 5);
            drawConnection(ctx, landmarks, 5, 6);
            drawConnection(ctx, landmarks, 6, 7);
            drawConnection(ctx, landmarks, 7, 8);
            
            // ä¸­æŒ‡
            drawConnection(ctx, landmarks, 5, 9);
            drawConnection(ctx, landmarks, 9, 10);
            drawConnection(ctx, landmarks, 10, 11);
            drawConnection(ctx, landmarks, 11, 12);
            
            // è–¬æŒ‡
            drawConnection(ctx, landmarks, 9, 13);
            drawConnection(ctx, landmarks, 13, 14);
            drawConnection(ctx, landmarks, 14, 15);
            drawConnection(ctx, landmarks, 15, 16);
            
            // å°æŒ‡
            drawConnection(ctx, landmarks, 13, 17);
            drawConnection(ctx, landmarks, 17, 18);
            drawConnection(ctx, landmarks, 18, 19);
            drawConnection(ctx, landmarks, 19, 20);
            
            // æ‰‹ã®ã²ã‚‰ã®æ¥ç¶š
            drawConnection(ctx, landmarks, 0, 17);
            drawConnection(ctx, landmarks, 5, 9);
            drawConnection(ctx, landmarks, 9, 13);
            drawConnection(ctx, landmarks, 13, 17);
        }
        
        // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯é–“ã®æ¥ç¶šç·šã‚’æç”»
        function drawConnection(ctx, landmarks, index1, index2) {
            const start = landmarks[index1];
            const end = landmarks[index2];
            
            ctx.beginPath();
            ctx.moveTo(start.x * ctx.canvas.width, start.y * ctx.canvas.height);
            ctx.lineTo(end.x * ctx.canvas.width, end.y * ctx.canvas.height);
            ctx.stroke();
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ç”¨ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
        function setupTouchEvents() {
            // ã‚¿ãƒƒãƒæ“ä½œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            document.addEventListener('touchstart', handleTouch);
            document.addEventListener('touchmove', handleTouch);
            
            function handleTouch(event) {
                // ã‚¿ãƒƒãƒåº§æ¨™ã‚’å–å¾—
                const touch = event.touches[0];
                if (!touch) return;
                
                const touchPosition = {
                    x: touch.clientX,
                    y: touch.clientY
                };
                
                // æŒ‡ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                fingerPointer.style.display = 'block';
                fingerPointer.style.left = touchPosition.x + 'px';
                fingerPointer.style.top = touchPosition.y + 'px';
                
                // ã‚¿ãƒƒãƒã•ã‚ŒãŸè¦ç´ ã‚’å–å¾—
                const element = document.elementFromPoint(touchPosition.x, touchPosition.y);
                
                // ãƒ‡ãƒãƒƒã‚°ç”¨ - ã‚¿ãƒƒãƒã—ãŸè¦ç´ ã®æƒ…å ±ã‚’è¡¨ç¤º
                console.log('ã‚¿ãƒƒãƒã•ã‚ŒãŸè¦ç´ :', element);
                if (element) {
                    console.log('è¦ç´ ã®ã‚¯ãƒ©ã‚¹:', element.className);
                    console.log('è¦ç´ ã®ID:', element.id);
                }
                
                // è‰²é¸æŠã®å‡¦ç†ã‚’è¿½åŠ 
                if (element && element.classList.contains('color-option')) {
                    console.log('è‰²é¸æŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:', element.dataset.color);
                    // è‰²ã‚’å¤‰æ›´
                    if (element.dataset.color === 'rainbow') {
                        rainbowMode = true;
                    } else {
                        rainbowMode = false;
                        currentColor = element.dataset.color;
                    }
                    
                    // é¸æŠã•ã‚ŒãŸè‰²ã‚’å¼·èª¿è¡¨ç¤º
                    const colorOptions = document.querySelectorAll('.color-option');
                    colorOptions.forEach(opt => opt.style.borderWidth = '2px');
                    element.style.borderWidth = '4px';
                    
                    // åŠ¹æœéŸ³ã‚’é³´ã‚‰ã™
                    sounds.success();
                    
                    // ä»¥é™ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    event.preventDefault();
                    return;
                }
                
                // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®å‡¦ç†
                if (element && element.id === 'clear-drawing') {
                    console.log('ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    sounds.success();
                    event.preventDefault();
                    return;
                }
                
                // æ—¢å­˜ã®buttonè¦ç´ ã®å‡¦ç†
                if (element && element.tagName === 'BUTTON') {
                    return; // ãƒœã‚¿ãƒ³ã¯ãã®ã¾ã¾ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
                }
                
                // ï¼ˆä»¥ä¸‹ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
                // ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã®å ´åˆã®ã¿å‡¦ç†
                if (gameActive) {
                    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç†
                    if (currentMode === 'treasure') {
                        checkTreasureCollection(touchPosition);
                    } else if (currentMode === 'draw') {
                        isDrawing = true;
                        draw(touchPosition.x, touchPosition.y);
                    } else if (currentMode === 'rhythm') {
                        // å„ã‚µãƒ¼ã‚¯ãƒ«ã¨ã®å½“ãŸã‚Šåˆ¤å®š
                        if (waitingForInput) {
                            const element = document.elementFromPoint(touchPosition.x, touchPosition.y);
                            if (element && element.classList.contains('music-circle')) {
                                checkCircleHit(element);
                            }
                        }
                    }
                } else if (startScreen.style.display !== 'none' && currentMode) {
                    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢è¡¨ç¤ºä¸­ã§ãƒ¢ãƒ¼ãƒ‰é¸æŠæ¸ˆã¿ã®å ´åˆ
                    startScreen.style.display = 'none';
                    homeButton.style.display = 'block';
                    startCountdown();
                }
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
                event.preventDefault();
            }
            
            document.addEventListener('touchend', function() {
                // ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æç”»ã‚’åœæ­¢
                if (currentMode === 'draw') {
                    isDrawing = false;
                    lastX = null;
                    lastY = null;
                }
                
                // æŒ‡ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
                fingerPointer.style.display = 'none';
            });
        }
        
        // ===== åˆæœŸåŒ–å‡¦ç† =====
        
        function init() {
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®æ¤œå‡º
            isMobileDevice = detectMobileDevice();
            
            // HTTPSã¾ãŸã¯localhostä»¥å¤–ã®ç’°å¢ƒã§ã¯ã‚«ãƒ¡ãƒ©ã‚’ç„¡åŠ¹åŒ–
            if (!isSecureContext()) {
                useCamera = false;
                console.warn('å®‰å…¨ã§ãªã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ã‚«ãƒ¡ãƒ©ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚HTTPSã¾ãŸã¯localhostã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            }
            
            // è¦ç´ ã®å‚ç…§ã‚’å–å¾—
            statusDisplay = document.getElementById('status');
            scoreDisplay = document.getElementById('score');
            timerDisplay = document.getElementById('timer');
            countdown = document.getElementById('countdown');
            gameOverScreen = document.getElementById('game-over');
            finalScoreDisplay = document.getElementById('final-score');
            startScreen = document.getElementById('start-screen');
            homeButton = document.getElementById('home-button');
            colorPalette = document.getElementById('color-palette');
            instructionsDisplay = document.getElementById('instructions');
            fingerPointer = document.getElementById('finger-pointer');
            errorMessage = document.getElementById('error-message');
            errorDetails = document.getElementById('error-details');
            errorOkButton = document.getElementById('error-ok-button');
            colorMusicContainer = document.getElementById('color-music-container');
            score_panel = document.getElementById('score-panel');
            
            // ã‚¨ãƒ©ãƒ¼OKãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            errorOkButton.addEventListener('click', function() {
                errorMessage.style.display = 'none';
            });
            
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®å ´åˆ
            if (isMobileDevice) {
                // UIã®èª¿æ•´
                safeArea.top = 120; // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å°‘ã—å°ã•ã
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ãŸã‚ã«ã‚¿ãƒƒãƒã§å…ˆã«ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
                document.addEventListener('touchstart', function initAudio() {
                    // ä¸€æ™‚çš„ãªãƒ“ãƒ¼ãƒ—éŸ³ã‚’é³´ã‚‰ã—ã¦åˆæœŸåŒ–
                    if (!audioCtx) {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();
                        gainNode.gain.value = 0;  // ç„¡éŸ³
                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);
                        oscillator.start();
                        oscillator.stop(audioCtx.currentTime + 0.01);
                    }
                    document.removeEventListener('touchstart', initAudio);
                }, { once: true });
            }
            
            // MediaPipeã®åˆæœŸåŒ–
            initMediaPipe();
            
            // å„ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            document.getElementById('treasure-mode').addEventListener('click', () => {
                currentMode = 'treasure';
                startScreen.style.display = 'none';
                homeButton.style.display = 'block';
                startCountdown();
            });
            
            document.getElementById('draw-mode').addEventListener('click', () => {
                currentMode = 'draw';
                startScreen.style.display = 'none';
                homeButton.style.display = 'block';
                startCountdown();
            });
            
            document.getElementById('rhythm-mode').addEventListener('click', () => {
                currentMode = 'rhythm';
                startScreen.style.display = 'none';
                homeButton.style.display = 'block';
                startCountdown();
            });
            
            // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('restart-button').addEventListener('click', () => {
                gameOverScreen.style.display = 'none';
                startCountdown();
            });
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('back-to-menu-button').addEventListener('click', () => {
                gameOverScreen.style.display = 'none';
                startScreen.style.display = 'block';
                homeButton.style.display = 'none';
                
                // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (currentMode === 'treasure') {
                    endTreasureHunt();
                } else if (currentMode === 'draw') {
                    endDrawingMode();
                } else if (currentMode === 'rhythm') {
                    endColorMusicGame();
                }
                
                currentMode = null;
            });
            
            // ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            homeButton.addEventListener('click', () => {
                // ã‚‚ã—ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ãªã‚‰çµ‚äº†
                if (gameActive) {
                    clearInterval(timer);
                    gameActive = false;
                }
                
                startScreen.style.display = 'block';
                homeButton.style.display = 'none';
                
                // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (currentMode === 'treasure') {
                    endTreasureHunt();
                } else if (currentMode === 'draw') {
                    endDrawingMode();
                } else if (currentMode === 'rhythm') {
                    endColorMusicGame();
                }
                
                currentMode = null;
            });
                        
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            setupTouchEvents();

            // ãŠçµµã‹ããƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            setupDrawingEvents();
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>