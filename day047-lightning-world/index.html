<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- OGP (Open Graph Protocol) -->
    <meta property="og:title" content="æ¥½ã—ã„é›·ã®ä¸–ç•Œ - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–é›·ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼†ã‚²ãƒ¼ãƒ " />
    <meta property="og:description" content="ç¾ã—ã„é›·ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨æ˜ ãˆã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚²ãƒ¼ãƒ ã‚’æ¥½ã—ã‚ã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã€‚ã•ã¾ã–ã¾ãªãƒ†ãƒ¼ãƒã€è‡ªå‹•å†ç”Ÿã€é›£æ˜“åº¦è¨­å®šãŒå¯èƒ½ã€‚" />
    <meta property="og:image" content="https://hiroe28.github.io/llm-100days-challenge/day047-lightning-world/screenshot.png" />
    <meta property="og:url" content="https://hiroe28.github.io/llm-100days-challenge/day047-lightning-world/index.html" />
    <meta property="og:type" content="website" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="æ¥½ã—ã„é›·ã®ä¸–ç•Œ" />
    <meta name="twitter:description" content="ã‚¿ãƒƒãƒ—ã§ç¾ã—ã„é›·ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã€‚3ã¤ã®ãƒ†ãƒ¼ãƒã¨é›£æ˜“åº¦èª¿æ•´å¯èƒ½ãªã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’æ­è¼‰ã—ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ä½“é¨“ã€‚" />
    <meta name="twitter:image" content="https://hiroe28.github.io/llm-100days-challenge/day047-lightning-world/screenshot.png" />

    <title>æ¥½ã—ã„é›·ã®ä¸–ç•Œ - æ˜ ãˆã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation;
            position: relative;
            background-color: #000;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700&display=swap');
        
        .container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            cursor: pointer;
        }
        
        .background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                #0f1b38 0%, 
                #1a2a59 25%, 
                #2b3969 50%, 
                #1f2445 75%, 
                #0f1123 100%);
            z-index: 1;
            transition: background 1.5s ease;
        }
        
        .background.sunset {
            background: linear-gradient(to bottom, 
                #ff7e00 0%, 
                #ff9a44 25%, 
                #2b3969 70%, 
                #1f2445 85%, 
                #0f1123 100%);
        }
        
        .background.fantasy {
            background: linear-gradient(to bottom, 
                #5d3a9e 0%, 
                #7349c1 25%, 
                #453c8c 60%, 
                #322a6c 80%, 
                #221b4a 100%);
        }
        
        .moon {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 40% 40%, #ffffff 0%, #d8d8eb 60%, #a9a9c9 100%);
            box-shadow: 0 0 30px #d8d8eb80, 0 0 60px #a9a9c920;
            top: 60px;
            right: 80px;
            z-index: 2;
            opacity: 0.85;
            transition: all 1.5s ease;
        }
        
        .moon.sunset {
            background: radial-gradient(circle at 40% 40%, #ffe7c8 0%, #ffc68a 60%, #ff9e44 100%);
            box-shadow: 0 0 30px #ffb76b80, 0 0 60px #ff7e0020;
        }
        
        .moon.fantasy {
            background: radial-gradient(circle at 40% 40%, #e4c8ff 0%, #c49aff 60%, #9e44ff 100%);
            box-shadow: 0 0 30px #c49aff80, 0 0 60px #9e44ff20;
            animation: pulse 4s infinite alternate;
        }
        
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0.7;
            transition: opacity 1.5s ease;
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle var(--twinkle-duration, 4s) infinite var(--twinkle-delay, 0s);
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0; }
            50% { opacity: var(--star-opacity, 0.8); }
        }
        
        .lightning-container {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 20;
            transition: opacity 0.1s;
        }
        
        .ui-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
            max-width: 600px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .mode-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .difficulty-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
            display: none;
        }
        
        .theme-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        button {
            background: rgba(46, 51, 90, 0.8);
            color: white;
            border: 2px solid #a3a7cc;
            padding: 10px 15px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        button:hover {
            background: rgba(74, 82, 138, 0.9);
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button.active {
            background: rgba(116, 97, 195, 0.9);
            border-color: #c3b2ff;
            box-shadow: 0 0 15px rgba(195, 178, 255, 0.5);
        }
        
        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
        }
        
        #nightTheme {
            background: radial-gradient(circle, #2b3969 0%, #1a2a59 100%);
        }
        
        #sunsetTheme {
            background: radial-gradient(circle, #ff9a44 0%, #ff7e00 100%);
        }
        
        #fantasyTheme {
            background: radial-gradient(circle, #7349c1 0%, #5d3a9e 100%);
        }
        
        .game-header {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 100;
            pointer-events: none;
        }
        
        .timer-display {
            background: rgba(46, 51, 90, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 24px;
            margin-right: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid #a3a7cc;
            display: none;
        }
        
        .score-display {
            background: rgba(46, 51, 90, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid #a3a7cc;
            display: none;
        }
        
        .combo-display {
            background: rgba(255, 150, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 18px;
            margin-left: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid #ffc266;
            display: none;
            transition: transform 0.2s, background 0.2s;
        }
        
        .combo-display.pulse {
            transform: scale(1.2);
            background: rgba(255, 100, 0, 0.8);
        }
        
        .level-display {
            background: rgba(70, 120, 200, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 18px;
            margin-left: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid #a0c0ff;
            display: none;
        }
        
        .target {
            position: absolute;
            width: 70px;
            height: 70px;
            z-index: 15;
            display: none;
            pointer-events: none;
            animation: pulse 2s infinite;
            transition: width 0.3s, height 0.3s;
        }
        
        .target-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px dashed rgba(255, 217, 0, 0.8);
            border-radius: 50%;
            box-sizing: border-box;
        }
        
        .target-inner {
            position: absolute;
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            background-color: rgba(255, 60, 60, 0.5);
            border-radius: 50%;
            box-sizing: border-box;
        }
        
        .target-center {
            position: absolute;
            width: 20%;
            height: 20%;
            top: 40%;
            left: 40%;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            box-sizing: border-box;
        }
        
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            color: white;
            z-index: 200;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(100, 100, 255, 0.8);
            opacity: 0;
            transition: opacity 0.2s, transform 0.5s;
            pointer-events: none;
        }
        
        .countdown.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .countdown.hide {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        
        .message-box {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%);
            background: rgba(46, 51, 90, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            font-size: 24px;
            max-width: 80%;
            text-align: center;
            z-index: 150;
            display: none;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
            border: 3px solid #a3a7cc;
            transition: all 0.3s;
            opacity: 0;
        }
        
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-30%);
        }
        
        .start-button {
            background: rgba(0, 170, 70, 0.9);
            color: white;
            border: 2px solid #80ffaa;
            padding: 12px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 20px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
            display: inline-block;
        }
        
        .start-button:hover {
            background: rgba(0, 190, 80, 0.9);
            transform: translateY(-2px);
        }
        
        .result-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%) scale(0.9);
            background: rgba(46, 51, 90, 0.9);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            font-size: 28px;
            max-width: 80%;
            text-align: center;
            z-index: 150;
            display: none;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
            border: 3px solid #a3a7cc;
            transition: all 0.5s;
            opacity: 0;
        }
        
        .result-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-50%) scale(1);
        }
        
        .result-title {
            font-size: 32px;
            margin-bottom: 20px;
            color: #ffcc00;
        }
        
        .result-score {
            font-size: 48px;
            margin-bottom: 10px;
            color: #ffffff;
        }
        
        .result-stats {
            font-size: 18px;
            margin-bottom: 20px;
            color: #c3b2ff;
        }
        
        .result-message {
            margin-bottom: 30px;
            font-size: 20px;
        }
        
        .retry-button {
            background: rgba(116, 97, 195, 0.9);
            color: white;
            border: 2px solid #c3b2ff;
            padding: 10px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 20px;
            margin-top: 10px;
            transition: all 0.3s;
            /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®æƒãˆã™ã‚‹ãŸã‚ã®è¿½åŠ  */
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .retry-button:hover {
            background: rgba(136, 117, 215, 0.9);
            transform: translateY(-2px);
        }
        
        .instructions {
            color: #c3b2ff;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .emoji {
            font-size: 24px;
            margin-right: 5px;
        }
        
        .impact-effect {
            position: absolute;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            z-index: 19;
            pointer-events: none;
        }
        
        .floating-score {
            position: absolute;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: transform 1s, opacity 1s;
        }
        
        /* ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å‰Šæ¸›ã¸ã®å¯¾å¿œ */
        @media (prefers-reduced-motion: reduce) {
            .target {
                animation: none;
            }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            button {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .ui-container {
                bottom: 10px;
            }
            
            .theme-btn {
                width: 34px;
                height: 34px;
            }
            
            .mode-selector, .controls, .difficulty-selector {
                gap: 6px;
            }
            
            .message-box {
                font-size: 18px;
                padding: 15px 20px;
            }
            
            .instructions {
                font-size: 14px;
            }
            
            .timer-display, .score-display {
                font-size: 20px;
                padding: 8px 20px;
            }
            
            .combo-display, .level-display {
                font-size: 16px;
                padding: 6px 12px;
            }
            
            .countdown {
                font-size: 90px;
            }
            
            .result-box {
                padding: 20px 25px;
                font-size: 22px;
            }
            
            .result-title {
                font-size: 26px;
            }
            
            .result-score {
                font-size: 36px;
            }
            
            .retry-button {
                font-size: 18px;
                padding: 8px 20px;
            }
            
            .start-button {
                font-size: 18px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="background" id="background"></div>
        <div class="moon" id="moon"></div>
        <div class="stars" id="starsContainer"></div>
        
        <div class="game-header">
            <div class="timer-display" id="timerDisplay">ã‚ã¨30ç§’</div>
            <div class="score-display" id="scoreDisplay">ã‚¹ã‚³ã‚¢: 0</div>
            <div class="combo-display" id="comboDisplay">ã‚³ãƒ³ãƒœ x2</div>
            <div class="level-display" id="levelDisplay">ãƒ¬ãƒ™ãƒ« 1</div>
        </div>
        
        <div class="target" id="target">
            <div class="target-ring"></div>
            <div class="target-inner"></div>
            <div class="target-center"></div>
        </div>
        
        <div class="countdown" id="countdown">3</div>
        
        <div class="lightning-container" id="lightningContainer"></div>
        
        <div class="message-box" id="messageBox">
            <div id="messageText">é›·ã®ä¸–ç•Œã¸ã‚ˆã†ã“ãï¼</div>
            <div class="instructions" id="instructionsText">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é›·ã‚’å‘¼ã³ã¾ã—ã‚‡ã†</div>
            <button class="start-button" id="startButton" style="display: none;">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>
        
        <div class="result-box" id="resultBox">
            <div class="result-title">ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
            <div class="result-score" id="finalScore">0</div>
            <div class="result-stats" id="resultStats">æœ€å¤§ã‚³ãƒ³ãƒœ: 0 / æœ€é«˜ãƒ¬ãƒ™ãƒ«: 1</div>
            <div class="result-message" id="resultMessage">ç´ æ™´ã‚‰ã—ã„ï¼</div>
            <button class="retry-button" id="retryButton">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
        
        <div class="ui-container">
            <div class="theme-selector">
                <button id="nightTheme" class="theme-btn active" title="å¤œã®ãƒ†ãƒ¼ãƒ"></button>
                <button id="sunsetTheme" class="theme-btn" title="å¤•ç„¼ã‘ãƒ†ãƒ¼ãƒ"></button>
                <button id="fantasyTheme" class="theme-btn" title="ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ†ãƒ¼ãƒ"></button>
            </div>
            
            <div class="mode-selector">
                <button id="normalMode" class="active"><span class="emoji">âš¡</span>ãµã¤ã†ãƒ¢ãƒ¼ãƒ‰</button>
                <button id="gameMode"><span class="emoji">ğŸ®</span>ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            
            <div class="difficulty-selector" id="difficultySelector">
                <button id="easyMode" class="active"><span class="emoji">ğŸ˜Š</span>ã‹ã‚“ãŸã‚“</button>
                <button id="normalDifficulty"><span class="emoji">ğŸ˜</span>ãµã¤ã†</button>
                <button id="hardMode"><span class="emoji">ğŸ˜†</span>ã‚€ãšã‹ã—ã„</button>
            </div>
            
            <div class="controls">
                <button id="playButton"><span class="emoji">ğŸ”„</span>è‡ªå‹•é›· ON</button>
                <button id="soundButton"><span class="emoji">ğŸ”Š</span>éŸ³ ON</button>
                <button id="infoButton"><span class="emoji">â„¹ï¸</span>èª¬æ˜</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ã‚²ãƒ¼ãƒ è¨­å®š
            const DIFFICULTY_SETTINGS = {
                easy: {
                    gameDuration: 30, // ã‚²ãƒ¼ãƒ ã®åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰
                    targetSize: 70,   // åˆæœŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚º
                    minTargetSize: 50, // æœ€å°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚º
                    targetShrinkRate: 0.5, // ãƒ¬ãƒ™ãƒ«ã”ã¨ã®ã‚µã‚¤ã‚ºæ¸›å°‘é‡
                    targetSpeed: 0,    // åˆæœŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆç§»å‹•é€Ÿåº¦
                    maxTargetSpeed: 1.5, // æœ€å¤§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç§»å‹•é€Ÿåº¦
                    targetSpeedIncrement: 0.3, // ãƒ¬ãƒ™ãƒ«ã”ã¨ã®é€Ÿåº¦å¢—åŠ é‡
                    scorePerHit: 10,   // ãƒ’ãƒƒãƒˆæ™‚ã®ã‚¹ã‚³ã‚¢
                    comboMultiplier: 1.5, // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹å€ç‡
                    levelUpThreshold: 5, // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã«å¿…è¦ãªãƒ’ãƒƒãƒˆæ•°
                    maxTargets: 1,     // æœ€å¤§åŒæ™‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°
                },
                normal: {
                    gameDuration: 30,
                    targetSize: 60,
                    minTargetSize: 40,
                    targetShrinkRate: 1,
                    targetSpeed: 0.5,
                    maxTargetSpeed: 2.5,
                    targetSpeedIncrement: 0.4,
                    scorePerHit: 10,
                    comboMultiplier: 2,
                    levelUpThreshold: 4,
                    maxTargets: 2,
                },
                hard: {
                    gameDuration: 30,
                    targetSize: 50,
                    minTargetSize: 30,
                    targetShrinkRate: 1.5,
                    targetSpeed: 1,
                    maxTargetSpeed: 4,
                    targetSpeedIncrement: 0.6,
                    scorePerHit: 10,
                    comboMultiplier: 3,
                    levelUpThreshold: 3,
                    maxTargets: 3,
                }
            };
            
            let currentDifficulty = 'easy'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é›£æ˜“åº¦
            
            // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ - ã“ã‚Œã‚‰ã¯å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            const THUNDER_SOUNDS = [
                'sounds/thunder1.mp3',
                'sounds/thunder2.mp3',
                'sounds/thunder3.mp3'
            ];
            
            // åŠ¹æœéŸ³
            const SFX = {
                click: 'sounds/click.mp3',
                success: 'sounds/success.mp3',
                fail: 'sounds/fail.mp3',
                magic: 'sounds/magic.mp3',
                countdown: 'sounds/countdown.mp3',
                start: 'sounds/start.mp3',
                levelup: 'sounds/levelup.mp3',
                combo: 'sounds/combo.mp3'
            };
            
            // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const RESULT_MESSAGES = {
                excellent: [
                    "ç´ æ™´ã‚‰ã—ã„ï¼é›·ã®é”äººã ã­ï¼",
                    "ã™ã”ã„ï¼å›ã¯ã™ã§ã«é›·ãƒã‚¹ã‚¿ãƒ¼ã ï¼",
                    "é©šç•°çš„ãªã‚¹ã‚³ã‚¢ï¼ç¨²å¦»ã®ç‹æ§˜ã ï¼"
                ],
                good: [
                    "ã„ã„æ„Ÿã˜ï¼ã©ã‚“ã©ã‚“ä¸Šæ‰‹ã«ãªã£ã¦ã‚‹ã­ï¼",
                    "ç´ æ•µãªãƒ—ãƒ¬ã‚¤ã ã£ãŸã‚ˆï¼",
                    "é›·ã®åŠ›ã‚’ä¸Šæ‰‹ã«ä½¿ã„ã“ãªã›ã¦ã„ã‚‹ã­ï¼"
                ],
                normal: [
                    "ã„ã„èª¿å­ï¼ã‚‚ã†ä¸€å›ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã‚ˆã†ï¼",
                    "é›·ã®åŠ›ãŒç›®è¦šã‚ã¦ããŸã­ï¼",
                    "ã‚‚ã†å°‘ã—ã§é›·ãƒã‚¹ã‚¿ãƒ¼ã«ãªã‚Œã‚‹ã‚ˆï¼"
                ],
                beginner: [
                    "ã¾ãšã¯é›·ã«æ…£ã‚Œã¦ã„ã“ã†ï¼",
                    "ç·´ç¿’ã‚ã‚‹ã®ã¿ï¼æ¬¡ã¯ã‚‚ã£ã¨ä¸Šæ‰‹ããªã‚‹ã‚ˆï¼",
                    "æœ€åˆã¯é›£ã—ã„ã‘ã©ã€ãã£ã¨ä¸Šæ‰‹ã«ãªã‚‹ã‚ˆï¼"
                ]
            };
            
            // DOMè¦ç´ ã®å–å¾—
            const container = document.getElementById('container');
            const lightningContainer = document.getElementById('lightningContainer');
            const playButton = document.getElementById('playButton');
            const soundButton = document.getElementById('soundButton');
            const infoButton = document.getElementById('infoButton');
            const normalMode = document.getElementById('normalMode');
            const gameMode = document.getElementById('gameMode');
            const easyMode = document.getElementById('easyMode');
            const normalDifficulty = document.getElementById('normalDifficulty');
            const hardMode = document.getElementById('hardMode');
            const difficultySelector = document.getElementById('difficultySelector');
            const background = document.getElementById('background');
            const moon = document.getElementById('moon');
            const nightTheme = document.getElementById('nightTheme');
            const sunsetTheme = document.getElementById('sunsetTheme');
            const fantasyTheme = document.getElementById('fantasyTheme');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            const comboDisplay = document.getElementById('comboDisplay');
            const levelDisplay = document.getElementById('levelDisplay');
            const countdown = document.getElementById('countdown');
            const target = document.getElementById('target');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const instructionsText = document.getElementById('instructionsText');
            const startButton = document.getElementById('startButton');
            const starsContainer = document.getElementById('starsContainer');
            const resultBox = document.getElementById('resultBox');
            const finalScore = document.getElementById('finalScore');
            const resultStats = document.getElementById('resultStats');
            const resultMessage = document.getElementById('resultMessage');
            const retryButton = document.getElementById('retryButton');
            
            // SVGåå‰ç©ºé–“
            const svgNS = "http://www.w3.org/2000/svg";
            
            // çŠ¶æ…‹å¤‰æ•°
            let autoPlay = false;
            let soundEnabled = true;
            let currentTheme = 'night';
            let currentMode = 'normal';
            let score = 0;
            let combo = 0;
            let maxCombo = 0;
            let gameActive = false;
            let gameTimeRemaining = 30; // åˆæœŸã‚²ãƒ¼ãƒ æ™‚é–“ï¼ˆç§’ï¼‰
            let level = 1;
            let maxLevel = 1;
            let hitsInLevel = 0;
            let timeoutIds = [];
            let gameTimerId = null;
            let targetMovementTimerId = null;
            let targetsActive = [];
            let countdownActive = false;
            let messageHideTimeout = null; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‡ªå‹•æ¶ˆå»ã‚¿ã‚¤ãƒãƒ¼å¤‰æ•°ã‚’è¿½åŠ 
            
            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ç§»å‹•ã«é–¢ã™ã‚‹å¤‰æ•°
            let targetVelocityX = 0;
            let targetVelocityY = 0;
            
            // SVGè¦ç´ ã‚’ä½œæˆ
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", "0 0 " + window.innerWidth + " " + window.innerHeight);
            lightningContainer.appendChild(svg);
            
            // SVGãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ï¼ˆãƒ¡ãƒ¢ãƒªæœ€é©åŒ–ï¼‰
            const svgNodePool = {
                paths: [],
                flashes: [],
                rects: []
            };
            
            // Audioè¦ç´ ãƒ—ãƒ¼ãƒ«
            const audioPool = [];
            for (let i = 0; i < 5; i++) {
                const audio = new Audio();
                audio.volume = 0.5;
                audioPool.push(audio);
            }
            
            // åŠ¹æœéŸ³ãƒ—ãƒ¼ãƒ«
            const sfxPool = {};
            for (const [key, url] of Object.entries(SFX)) {
                sfxPool[key] = new Audio();
                sfxPool[key].src = url;
                sfxPool[key].volume = 0.3;
            }
            
            // æ˜Ÿã‚’ä½œæˆ
            function createStars() {
                // æ—¢å­˜ã®æ˜Ÿã‚’å‰Šé™¤
                starsContainer.innerHTML = '';
                
                // æ–°ã—ã„æ˜Ÿã‚’ç”Ÿæˆ
                const starCount = Math.min(window.innerWidth, window.innerHeight) / 3;
                
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    star.classList.add('star');
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã¨ã‚µã‚¤ã‚º
                    const size = Math.random() * 2 + 1;
                    star.style.width = size + 'px';
                    star.style.height = size + 'px';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    star.style.setProperty('--twinkle-duration', (3 + Math.random() * 5) + 's');
                    star.style.setProperty('--twinkle-delay', (Math.random() * 5) + 's');
                    star.style.setProperty('--star-opacity', (0.5 + Math.random() * 0.5).toString());
                    
                    starsContainer.appendChild(star);
                }
            }
            
            // ãƒ†ãƒ¼ãƒã‚’è¨­å®š
            function setTheme(theme) {
                currentTheme = theme;
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                nightTheme.classList.remove('active');
                sunsetTheme.classList.remove('active');
                fantasyTheme.classList.remove('active');
                
                if (theme === 'night') {
                    nightTheme.classList.add('active');
                    background.className = 'background';
                    moon.className = 'moon';
                    starsContainer.style.opacity = '0.7';
                } else if (theme === 'sunset') {
                    sunsetTheme.classList.add('active');
                    background.className = 'background sunset';
                    moon.className = 'moon sunset';
                    starsContainer.style.opacity = '0.3';
                } else if (theme === 'fantasy') {
                    fantasyTheme.classList.add('active');
                    background.className = 'background fantasy';
                    moon.className = 'moon fantasy';
                    starsContainer.style.opacity = '1';
                }
                
                // åŠ¹æœéŸ³å†ç”Ÿ
                playSFX('click');
            }
            
            // ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            function setMode(mode) {
                // ç¾åœ¨ã¨åŒã˜ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (mode === currentMode) return;
                
                currentMode = mode;
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                normalMode.classList.remove('active');
                gameMode.classList.remove('active');
                
                // ãƒ¢ãƒ¼ãƒ‰å›ºæœ‰ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
                hideGameUI();
                target.style.display = 'none';
                resultBox.style.display = 'none';
                
                // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
                clearAllTimers();
                
                // é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ãŒã‚ã‚Œã°çµ‚äº†
                if (gameActive) {
                    endGame();
                }
                
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’ç¢ºå®Ÿã«éè¡¨ç¤º
                countdown.style.display = 'none';
                countdown.classList.remove('show');
                countdown.classList.remove('hide');
                countdownActive = false;
                
                if (mode === 'normal') {
                    normalMode.classList.add('active');
                    difficultySelector.style.display = 'none';
                    showMessage('ãµã¤ã†ãƒ¢ãƒ¼ãƒ‰', 'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é›·ã‚’å‘¼ã³å‡ºãã†ï¼', 2000);
                } else if (mode === 'game') {
                    gameMode.classList.add('active');
                    difficultySelector.style.display = 'flex';
                    
                    // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®èª¬æ˜ã‚’è¡¨ç¤ºï¼ˆè‡ªå‹•ã§æ¶ˆãˆãªã„ã‚ˆã†ã«ï¼‰
                    showGameInstructions();
                }
                
                // åŠ¹æœéŸ³å†ç”Ÿ
                playSFX('click');
            }
            
            // é›£æ˜“åº¦ã‚’è¨­å®š
            function setDifficulty(difficulty) {
                // ç¾åœ¨ã¨åŒã˜é›£æ˜“åº¦ãŒé¸æŠã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚²ãƒ¼ãƒ ä¸­ã®èª¤ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
                if (difficulty === currentDifficulty && gameActive) return;
                
                currentDifficulty = difficulty;
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                easyMode.classList.remove('active');
                normalDifficulty.classList.remove('active');
                hardMode.classList.remove('active');
                
                if (difficulty === 'easy') {
                    easyMode.classList.add('active');
                } else if (difficulty === 'normal') {
                    normalDifficulty.classList.add('active');
                } else if (difficulty === 'hard') {
                    hardMode.classList.add('active');
                }
                
                // ã‚²ãƒ¼ãƒ è¨­å®šã‚’æ›´æ–°
                if (currentMode === 'game') {
                    // é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ãŒã‚ã‚Œã°çµ‚äº†ï¼ˆãƒªã‚¶ãƒ«ãƒˆç”»é¢ã‚’è¡¨ç¤ºã›ãšï¼‰
                    if (gameActive) {
                        endGame(false);  // ãƒªã‚¶ãƒ«ãƒˆè¡¨ç¤ºã—ãªã„ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™
                    }
                    
                    gameTimeRemaining = DIFFICULTY_SETTINGS[difficulty].gameDuration;
                    updateTimer();
                    
                    // é›£æ˜“åº¦ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    let difficultyName;
                    if (difficulty === 'easy') difficultyName = 'ã‹ã‚“ãŸã‚“';
                    else if (difficulty === 'normal') difficultyName = 'ãµã¤ã†';
                    else difficultyName = 'ã‚€ãšã‹ã—ã„';
                    
                    showGameInstructions(difficultyName);
                }
                
                // åŠ¹æœéŸ³å†ç”Ÿ
                playSFX('click');
            }
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®æ¡ˆå†…ã‚’è¡¨ç¤º
            function showGameInstructions(difficultyName = null) {
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„
                if (countdownActive) return;
                
                // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (gameActive) {
                    endGame(false);  // ãƒªã‚¶ãƒ«ãƒˆè¡¨ç¤ºã—ãªã„ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™
                }
                
                // çµæœç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°éè¡¨ç¤ºã«ã™ã‚‹
                resultBox.classList.remove('show');
                resultBox.style.display = 'none';
                
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                const diffText = difficultyName ? `é›£æ˜“åº¦: ${difficultyName}` : '';
                
                // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«ã®èª¬æ˜
                let instructionText = `åˆ¶é™æ™‚é–“${settings.gameDuration}ç§’é–“ã«ã€ã§ãã‚‹ã ã‘å¤šãã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã—ã‚ˆã†ï¼
                ${diffText}
                ãƒ»é€£ç¶šãƒ’ãƒƒãƒˆã§ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ï¼
                ãƒ»ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚‹ã¨é›£ã—ããªã‚‹ã‚ˆï¼`;
                
                messageText.textContent = 'ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰';
                instructionsText.innerHTML = instructionText;
                startButton.style.display = 'inline-block';
                
                // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‡ªå‹•æ¶ˆå»ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                if (messageHideTimeout) {
                    clearTimeout(messageHideTimeout);
                    messageHideTimeout = null;
                }
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒãƒ¼ãªã—ã§å¸¸ã«è¡¨ç¤ºï¼‰
                messageBox.style.display = 'block';
                messageBox.classList.remove('show');
                
                // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆCSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
                setTimeout(() => {
                    messageBox.classList.add('show');
                }, 10);
            }
            
            // ã‚²ãƒ¼ãƒ UIã‚’è¡¨ç¤º
            function showGameUI() {
                timerDisplay.style.display = 'block';
                scoreDisplay.style.display = 'block';
                comboDisplay.style.display = 'block';
                levelDisplay.style.display = 'block';
                
                // ã‚³ãƒ³ãƒœãŒ0ã®å ´åˆã¯éè¡¨ç¤º
                if (combo <= 1) {
                    comboDisplay.style.display = 'none';
                }
            }
            
            // ã‚²ãƒ¼ãƒ UIã‚’éè¡¨ç¤º
            function hideGameUI() {
                timerDisplay.style.display = 'none';
                scoreDisplay.style.display = 'none';
                comboDisplay.style.display = 'none';
                levelDisplay.style.display = 'none';
            }
            

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º
            function showCountdown() {
                if (countdownActive || gameActive) return;
                countdownActive = true;
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤º
                messageBox.classList.remove('show');
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 300);
                
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’åˆæœŸåŒ–
                countdown.style.display = 'block';
                let count = 3;
                countdown.textContent = count;
                countdown.classList.add('show');
                
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã‚’å†ç”Ÿï¼ˆ1å›ã ã‘ï¼‰
                playSFX('countdown');
                
                const countdownInterval = setInterval(() => {
                    count--;
                    
                    if (count > 0) {
                        countdown.classList.remove('show');
                        setTimeout(() => {
                            countdown.textContent = count;
                            countdown.classList.add('show');
                            // è¿½åŠ ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã®å†ç”Ÿã‚’å‰Šé™¤
                        }, 100);
                    } else {
                        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†ã€ã‚²ãƒ¼ãƒ é–‹å§‹
                        countdown.classList.remove('show');
                        countdown.classList.add('hide');
                        clearInterval(countdownInterval);
                        
                        setTimeout(() => {
                            countdown.classList.remove('hide');
                            countdown.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
                            countdown.classList.add('show');
                            playSFX('start');
                            
                            setTimeout(() => {
                                countdown.classList.remove('show');
                                countdown.classList.add('hide');
                                
                                setTimeout(() => {
                                    countdown.style.display = 'none';
                                    countdown.classList.remove('hide');
                                    if (currentMode === 'game') {
                                        startGame();
                                    }
                                    countdownActive = false;
                                }, 500);
                            }, 1000);
                        }, 200);
                    }
                }, 1000);
            }
            
            // ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
            function startGame() {
                if (gameActive) return;
                
                // ã‚²ãƒ¼ãƒ è¨­å®šã‚’å–å¾—
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                
                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                score = 0;
                combo = 0;
                maxCombo = 0;
                level = 1;
                maxLevel = 1;
                hitsInLevel = 0;
                gameTimeRemaining = settings.gameDuration;
                gameActive = true;
                targetsActive = [];
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆ
                target.style.width = settings.targetSize + 'px';
                target.style.height = settings.targetSize + 'px';
                
                // UIã‚’è¡¨ç¤º
                showGameUI();
                updateScore();
                updateCombo();
                updateLevel();
                updateTimer();
                
                // åˆå›ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¡¨ç¤º
                showTarget();
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç§»å‹•ã‚’é–‹å§‹
                startTargetMovement();
                
                // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
                gameTimerId = setInterval(() => {
                    gameTimeRemaining--;
                    updateTimer();
                    
                    if (gameTimeRemaining <= 0) {
                        endGame();
                    }
                }, 1000);
            }
            
            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ç§»å‹•ã‚’é–‹å§‹
            function startTargetMovement() {
                if (!gameActive) return;
                
                // è¨­å®šã‚’å–å¾—
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                const speed = Math.min(settings.targetSpeed + (level - 1) * settings.targetSpeedIncrement, settings.maxTargetSpeed);
                
                if (speed <= 0) return; // ç§»å‹•é€Ÿåº¦ãŒ0ä»¥ä¸‹ãªã‚‰å‹•ã‹ã•ãªã„
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªåˆæœŸæ–¹å‘
                const angle = Math.random() * Math.PI * 2;
                targetVelocityX = Math.cos(angle) * speed;
                targetVelocityY = Math.sin(angle) * speed;
                
                // ç§»å‹•æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼
                targetMovementTimerId = setInterval(() => {
                    if (!gameActive || targetsActive.length === 0) return;
                    
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ç§»å‹•
                    targetsActive.forEach(targetData => {
                        const targetElem = targetData.element;
                        const rect = targetElem.getBoundingClientRect();
                        
                        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ä¸­å¿ƒåº§æ¨™ã‚’è¨ˆç®—
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        
                        // æ–°ã—ã„ä½ç½®ã‚’è¨ˆç®—
                        let newX = rect.left + targetData.velocityX;
                        let newY = rect.top + targetData.velocityY;
                        
                        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã‚’å–å¾—
                        const targetSize = targetData.size;
                        const padding = 20;
                        
                        // ç”»é¢å¤–ãƒã‚§ãƒƒã‚¯ - å®Œå…¨ã«ç”»é¢å¤–ã«å‡ºã¦ã—ã¾ã£ãŸå ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
                        if (centerX < -targetSize || centerX > window.innerWidth + targetSize ||
                            centerY < -targetSize || centerY > window.innerHeight + targetSize) {
                            
                            // ç”»é¢ã®å®‰å…¨ãªå ´æ‰€ã«å†é…ç½®
                            newX = window.innerWidth / 2 - targetSize / 2;
                            newY = window.innerHeight / 3 - targetSize / 2;
                            
                            // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«å‹•ãã‚ˆã†ã«è¨­å®š
                            const newAngle = Math.random() * Math.PI * 2;
                            targetData.velocityX = Math.cos(newAngle) * speed;
                            targetData.velocityY = Math.sin(newAngle) * speed;
                        }
                        
                        // å¢ƒç•Œãƒã‚§ãƒƒã‚¯ - ç”»é¢ç«¯ã«è¿‘ã¥ã„ãŸã‚‰åè»¢
                        if (newX < padding || newX + targetSize > window.innerWidth - padding) {
                            targetData.velocityX *= -1; // åè»¢
                            newX += targetData.velocityX * 2; // å¢ƒç•Œã‹ã‚‰é›¢ã‚Œã‚‹
                        }
                        
                        if (newY < padding || newY + targetSize > window.innerHeight - padding) {
                            targetData.velocityY *= -1; // åè»¢
                            newY += targetData.velocityY * 2; // å¢ƒç•Œã‹ã‚‰é›¢ã‚Œã‚‹
                        }
                        
                        // UIã‚¨ãƒªã‚¢ä»˜è¿‘ã®å ´åˆã‚‚åè»¢ï¼ˆç”»é¢ä¸‹éƒ¨ã®UIã«è¿‘ã¥ãã™ããªã„ã‚ˆã†ã«ï¼‰
                        const uiContainer = document.querySelector('.ui-container');
                        const uiRect = uiContainer.getBoundingClientRect();
                        
                        if (newY + targetSize > uiRect.top - padding) {
                            targetData.velocityY *= -1; // ä¸Šå‘ãã«åè»¢
                            newY = uiRect.top - padding - targetSize; // UIã®ä¸Šã«æˆ»ã™
                        }
                        
                        // ä½ç½®ã‚’æ›´æ–°
                        targetElem.style.left = `${newX}px`;
                        targetElem.style.top = `${newY}px`;
                    });
                }, 20); // æ»‘ã‚‰ã‹ãªå‹•ãã®ãŸã‚ã«é »ç¹ã«æ›´æ–°
            }
            
            // ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†
            function endGame(showResultScreen = true) {  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                clearInterval(gameTimerId);
                clearInterval(targetMovementTimerId);
                gameActive = false;
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ã™ã¹ã¦éè¡¨ç¤º
                targetsActive.forEach(targetData => {
                    targetData.element.style.display = 'none';
                });
                targetsActive = [];
                
                // çµæœè¡¨ç¤ºï¼ˆã‚¹ã‚³ã‚¢ãŒã‚ã‚‹å ´åˆã®ã¿ - ãƒªã‚¶ãƒ«ãƒˆè¡¨ç¤ºãƒ•ãƒ©ã‚°ãŒtrueã®å ´åˆï¼‰
                if (score > 0 && showResultScreen) {  // æ¡ä»¶ã‚’è¿½åŠ 
                    showResult();
                }
            }
            
            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¡¨ç¤º
            function showTarget() {
                if (!gameActive) return;
                
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                
                // ã™ã§ã«æœ€å¤§æ•°ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ã—ãªã„
                if (targetsActive.length >= settings.maxTargets) return;
                
                // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                const sizeReduction = Math.min((level - 1) * settings.targetShrinkRate, settings.targetSize - settings.minTargetSize);
                const currentSize = settings.targetSize - sizeReduction;
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’é…ç½®
                // UIã®é…ç½®ã‚’é¿ã‘ã‚‹
                const uiContainer = document.querySelector('.ui-container');
                const uiRect = uiContainer.getBoundingClientRect();
                const uiTop = uiRect.top;
                
                const padding = currentSize; // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
                const safeAreaHeight = uiTop - padding; // UIã®ä¸Šéƒ¨ã¾ã§ã®å®‰å…¨ãªé«˜ã•
                
                let x, y;
                do {
                    x = padding + Math.random() * (window.innerWidth - padding * 2);
                    y = padding + Math.random() * safeAreaHeight;
                } while (
                    // UIã®ä¸Šã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒæ¥ãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
                    y > safeAreaHeight || 
                    // ç”»é¢ç«¯ã™ãã‚‹ä½ç½®ã‚’é¿ã‘ã‚‹
                    x < padding || 
                    x > window.innerWidth - padding || 
                    y < padding
                );
                
                // æ–°ã—ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ä½œæˆã¾ãŸã¯æ—¢å­˜ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å†åˆ©ç”¨
                let targetElement;
                
                if (targetsActive.length === 0) {
                    // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ä½¿ç”¨
                    targetElement = target;
                } else {
                    // ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ
                    targetElement = target.cloneNode(true);
                    container.appendChild(targetElement);
                }
                
                targetElement.style.width = `${currentSize}px`;
                targetElement.style.height = `${currentSize}px`;
                targetElement.style.left = `${x - currentSize / 2}px`;
                targetElement.style.top = `${y - currentSize / 2}px`;
                targetElement.style.display = 'block';
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªç§»å‹•æ–¹å‘ã‚’è¨­å®š
                const speed = Math.min(settings.targetSpeed + (level - 1) * settings.targetSpeedIncrement, settings.maxTargetSpeed);
                const angle = Math.random() * Math.PI * 2;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                targetsActive.push({
                    element: targetElement,
                    velocityX: vx,
                    velocityY: vy,
                    size: currentSize
                });
                
                // é›£æ˜“åº¦ã«å¿œã˜ã¦è¿½åŠ ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¡¨ç¤º
                if (settings.maxTargets > 1 && level > 1 && targetsActive.length < settings.maxTargets) {
                    setTimeout(() => {
                        if (gameActive) showTarget();
                    }, 500);
                }
            }
            
            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ’ãƒƒãƒˆå‡¦ç†
            function hitTarget(targetElement, x, y) {
                if (!gameActive) return;
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã™
                const targetIndex = targetsActive.findIndex(t => t.element === targetElement);
                if (targetIndex === -1) return;
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’éè¡¨ç¤º
                targetElement.style.display = 'none';
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                const targetData = targetsActive.splice(targetIndex, 1)[0];
                
                // ãƒ’ãƒƒãƒˆæ•°ã¨ã‚³ãƒ³ãƒœã‚’å¢—åŠ 
                hitsInLevel++;
                combo++;
                maxCombo = Math.max(maxCombo, combo);
                
                // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ä»˜ãï¼‰
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                const baseScore = settings.scorePerHit;
                let bonusScore = 0;
                
                if (combo > 1) {
                    // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—
                    bonusScore = Math.floor(baseScore * (combo - 1) * (settings.comboMultiplier / 10));
                }
                
                const totalScore = baseScore + bonusScore;
                score += totalScore;
                
                // æµ®ãä¸ŠãŒã‚‹ã‚¹ã‚³ã‚¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                showFloatingScore(x, y, totalScore, combo > 1);
                
                // UIã‚’æ›´æ–°
                updateScore();
                updateCombo();
                
                // æˆåŠŸåŠ¹æœéŸ³
                if (combo > 1) {
                    playSFX('combo');
                } else {
                    playSFX('success');
                }
                
                // é›·ã‚’ç”Ÿæˆ
                animateLightning(x, y);
                
                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç¢ºèª
                checkLevelUp();
                
                // æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¡¨ç¤ºï¼ˆé›·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ï¼‰
                setTimeout(() => {
                    if (gameActive) showTarget();
                }, 200);
            }
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚’ç¢ºèª
            function checkLevelUp() {
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                if (hitsInLevel >= settings.levelUpThreshold) {
                    level++;
                    maxLevel = Math.max(maxLevel, level);
                    hitsInLevel = 0;
                    
                    // ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
                    updateLevel();
                    
                    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åŠ¹æœéŸ³
                    playSFX('levelup');
                    
                    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€ç¬è¡¨ç¤º
                    const levelupMsg = document.createElement('div');
                    levelupMsg.textContent = `ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${level}`;
                    levelupMsg.style.position = 'absolute';
                    levelupMsg.style.top = '40%';
                    levelupMsg.style.left = '50%';
                    levelupMsg.style.transform = 'translate(-50%, -50%)';
                    levelupMsg.style.color = '#ffcc00';
                    levelupMsg.style.textShadow = '0 0 10px rgba(255, 200, 0, 0.8)';
                    levelupMsg.style.fontSize = '36px';
                    levelupMsg.style.fontWeight = 'bold';
                    levelupMsg.style.zIndex = '200';
                    levelupMsg.style.opacity = '0';
                    levelupMsg.style.transition = 'all 0.5s';
                    container.appendChild(levelupMsg);
                    
                    setTimeout(() => {
                        levelupMsg.style.opacity = '1';
                        setTimeout(() => {
                            levelupMsg.style.opacity = '0';
                            setTimeout(() => {
                                container.removeChild(levelupMsg);
                            }, 500);
                        }, 1000);
                    }, 10);
                }
            }
            
            // æµ®ãä¸ŠãŒã‚‹ã‚¹ã‚³ã‚¢è¡¨ç¤º
            function showFloatingScore(x, y, score, isCombo) {
                const floatingScore = document.createElement('div');
                floatingScore.classList.add('floating-score');
                
                // ã‚³ãƒ³ãƒœã®å ´åˆã¯è‰²ã‚’å¤‰ãˆã‚‹
                if (isCombo) {
                    floatingScore.style.color = '#ffcc00';
                    floatingScore.textContent = `+${score} COMBO!`;
                } else {
                    floatingScore.textContent = `+${score}`;
                }
                
                floatingScore.style.left = `${x - 30}px`;
                floatingScore.style.top = `${y - 30}px`;
                container.appendChild(floatingScore);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                setTimeout(() => {
                    floatingScore.style.opacity = '1';
                    floatingScore.style.transform = 'translateY(-50px)';
                    
                    setTimeout(() => {
                        floatingScore.style.opacity = '0';
                        setTimeout(() => {
                            container.removeChild(floatingScore);
                        }, 1000);
                    }, 800);
                }, 10);
            }
            
            // ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
            function updateScore() {
                scoreDisplay.textContent = `ã‚¹ã‚³ã‚¢: ${score}`;
            }
            
            // ã‚³ãƒ³ãƒœã‚’æ›´æ–°
            function updateCombo() {
                if (combo > 1) {
                    comboDisplay.textContent = `ã‚³ãƒ³ãƒœ x${combo}`;
                    comboDisplay.style.display = 'block';
                    
                    // ãƒ‘ãƒ«ã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    comboDisplay.classList.add('pulse');
                    setTimeout(() => {
                        comboDisplay.classList.remove('pulse');
                    }, 200);
                } else {
                    comboDisplay.style.display = 'none';
                }
            }
            
            // ãƒ¬ãƒ™ãƒ«ã‚’æ›´æ–°
            function updateLevel() {
                levelDisplay.textContent = `ãƒ¬ãƒ™ãƒ« ${level}`;
            }
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°
            function updateTimer() {
                timerDisplay.textContent = `ã‚ã¨${gameTimeRemaining}ç§’`;
                
                // æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªããªã£ãŸã‚‰è­¦å‘Šè‰²ã«
                if (gameTimeRemaining <= 5) {
                    timerDisplay.style.color = '#ff3333';
                } else {
                    timerDisplay.style.color = 'white';
                }
            }
            
            // çµæœè¡¨ç¤º
            function showResult() {
                finalScore.textContent = score;
                resultStats.textContent = `æœ€å¤§ã‚³ãƒ³ãƒœ: ${maxCombo} / æœ€é«˜ãƒ¬ãƒ™ãƒ«: ${maxLevel}`;
                
                // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let messageType;
                const difficulty = currentDifficulty;
                
                let excellentThreshold, goodThreshold, normalThreshold;
                
                if (difficulty === 'easy') {
                    excellentThreshold = 200;
                    goodThreshold = 120;
                    normalThreshold = 60;
                } else if (difficulty === 'normal') {
                    excellentThreshold = 300;
                    goodThreshold = 200;
                    normalThreshold = 100;
                } else { // hard
                    excellentThreshold = 500;
                    goodThreshold = 300;
                    normalThreshold = 150;
                }
                
                if (score >= excellentThreshold) {
                    messageType = 'excellent';
                } else if (score >= goodThreshold) {
                    messageType = 'good';
                } else if (score >= normalThreshold) {
                    messageType = 'normal';
                } else {
                    messageType = 'beginner';
                }
                
                const messages = RESULT_MESSAGES[messageType];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                resultMessage.textContent = randomMessage;
                
                // çµæœãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
                resultBox.style.display = 'block';
                setTimeout(() => {
                    resultBox.classList.add('show');
                }, 10);
                
                // UIã¯éè¡¨ç¤º
                hideGameUI();
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            function showMessage(title, instructions, duration = 0) {
                messageText.textContent = title;
                instructionsText.innerHTML = instructions;
                startButton.style.display = 'none';
                messageBox.style.display = 'block';
                
                // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‡ªå‹•æ¶ˆå»ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                if (messageHideTimeout) {
                    clearTimeout(messageHideTimeout);
                    messageHideTimeout = null;
                }
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆã‚ã›ã‚‹ãŸã‚å°‘ã—é…å»¶
                setTimeout(() => {
                    messageBox.classList.add('show');
                }, 10);
                
                // durationãŒæ­£ã®æ•°ã®å ´åˆã®ã¿è‡ªå‹•éè¡¨ç¤º
                if (duration > 0) {
                    messageHideTimeout = setTimeout(() => {
                        messageBox.classList.remove('show');
                        setTimeout(() => {
                            messageBox.style.display = 'none';
                            messageHideTimeout = null;
                        }, 300);
                    }, duration);
                }
            }
            
            // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
            function playSFX(type) {
                if (!soundEnabled) return;
                
                const sfx = sfxPool[type];
                if (sfx) {
                    sfx.currentTime = 0;
                    sfx.play().catch(e => console.log('SFX play failed:', e));
                }
            }
            
            // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            function clearAllTimers() {
                // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
                timeoutIds.forEach(id => clearTimeout(id));
                timeoutIds = [];
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‡ªå‹•æ¶ˆå»ã‚¿ã‚¤ãƒãƒ¼ã‚‚ã‚¯ãƒªã‚¢
                if (messageHideTimeout) {
                    clearTimeout(messageHideTimeout);
                    messageHideTimeout = null;
                }
                
                // ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
                if (gameTimerId) {
                    clearInterval(gameTimerId);
                    gameTimerId = null;
                }
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç§»å‹•ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
                if (targetMovementTimerId) {
                    clearInterval(targetMovementTimerId);
                    targetMovementTimerId = null;
                }
                
                gameActive = false;
            }
            
            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªäº‹å‰ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
            function preloadAudio() {
                if (!soundEnabled) return;
                
                const audio = audioPool[0];
                audio.src = THUNDER_SOUNDS[0];
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }).catch(err => {
                    console.log('Auto-play prevented: ' + err);
                });
                
                // åŠ¹æœéŸ³ã‚‚äº‹å‰ãƒ­ãƒ¼ãƒ‰
                for (const [key, sfx] of Object.entries(sfxPool)) {
                    sfx.play().then(() => {
                        sfx.pause();
                        sfx.currentTime = 0;
                    }).catch(err => {
                        console.log(`SFX ${key} auto-play prevented: ${err}`);
                    });
                }
            }
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªäº‹å‰ãƒ­ãƒ¼ãƒ‰
            window.addEventListener('touchstart', function() {
                preloadAudio();
            }, { once: true });
            
            // é›·ã®ã‚°ãƒ­ãƒ¼åŠ¹æœç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆ
            function createLightningFilter() {
                // SVGã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¿½åŠ 
                const filterDefs = document.createElementNS(svgNS, "defs");
                
                const filter = document.createElementNS(svgNS, "filter");
                filter.setAttribute("id", "lightningGlow");
                filter.setAttribute("x", "-50%");
                filter.setAttribute("y", "-50%");
                filter.setAttribute("width", "200%");
                filter.setAttribute("height", "200%");
                
                // ã¼ã‹ã—åŠ¹æœ
                const gaussianBlur = document.createElementNS(svgNS, "feGaussianBlur");
                gaussianBlur.setAttribute("in", "SourceGraphic");
                gaussianBlur.setAttribute("stdDeviation", "10");
                gaussianBlur.setAttribute("result", "blur");
                filter.appendChild(gaussianBlur);
                
                // æ˜ã‚‹ã•
                const brightness = document.createElementNS(svgNS, "feComponentTransfer");
                brightness.setAttribute("in", "blur");
                brightness.setAttribute("result", "bright");
                
                const funcR = document.createElementNS(svgNS, "feFuncR");
                funcR.setAttribute("type", "linear");
                funcR.setAttribute("slope", "3");
                brightness.appendChild(funcR);
                
                const funcG = document.createElementNS(svgNS, "feFuncG");
                funcG.setAttribute("type", "linear");
                funcG.setAttribute("slope", "3");
                brightness.appendChild(funcG);
                
                const funcB = document.createElementNS(svgNS, "feFuncB");
                funcB.setAttribute("type", "linear");
                funcB.setAttribute("slope", "3");
                brightness.appendChild(funcB);
                
                filter.appendChild(brightness);
                
                // å…ƒã®é›·ã¨åˆæˆ
                const composite = document.createElementNS(svgNS, "feComposite");
                composite.setAttribute("in", "bright");
                composite.setAttribute("in2", "SourceGraphic");
                composite.setAttribute("operator", "over");
                filter.appendChild(composite);
                
                filterDefs.appendChild(filter);
                svg.appendChild(filterDefs);
            }
            
            // é›·ãƒ‘ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆã‚ˆã‚Šè¤‡é›‘ã§è‡ªç„¶ãªå½¢çŠ¶ã«ï¼‰
            function generateLightningPath(startX, startY, endX, endY, displacementFactor, iterations, segmentLength = 30) {
                let points = [];
                points.push({ x: startX, y: startY });
                
                // çµ‚ç‚¹ã¾ã§ã®è·é›¢
                const dx = endX - startX;
                const dy = endY - startY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°ã‚’è¨ˆç®—
                const numSegments = Math.ceil(distance / segmentLength);
                
                // ä¸­é–“ç‚¹ã‚’ä½œæˆ
                let currentX = startX;
                let currentY = startY;
                
                for (let i = 0; i < numSegments; i++) {
                    // æ¬¡ã®ç‚¹ã®æ–¹å‘ã‚’è‹¥å¹²ãƒ©ãƒ³ãƒ€ãƒ ã«
                    const segmentDistance = distance / numSegments;
                    const directionChangeX = (Math.random() * 2 - 1) * 0.3;
                    const directionChangeY = Math.random() * 0.5; // ä¸‹å‘ãã«é€²ã‚€å‚¾å‘
                    
                    const normalizedDx = dx / distance + directionChangeX;
                    const normalizedDy = dy / distance + directionChangeY;
                    
                    const nextX = currentX + normalizedDx * segmentDistance;
                    const nextY = currentY + normalizedDy * segmentDistance;
                    
                    // ã‚¸ã‚°ã‚¶ã‚°ã™ã‚‹ãŸã‚ã®æ¨ªæ–¹å‘ã®å¤‰ä½
                    const displacement = (Math.random() * 2 - 1) * displacementFactor;
                    const perpX = -normalizedDy;
                    const perpY = normalizedDx;
                    
                    const displacedX = nextX + perpX * displacement;
                    const displacedY = nextY + perpY * displacement;
                    
                    currentX = displacedX;
                    currentY = displacedY;
                    
                    points.push({ x: currentX, y: currentY });
                }
                
                // çµ‚ç‚¹ã‚’è¿½åŠ ã—ã¦ç¢ºå®Ÿã«ç›®çš„åœ°ã«åˆ°é”
                points.push({ x: endX, y: endY });
                
                // ã‚¸ã‚°ã‚¶ã‚°å‡¦ç†ã‚’ã•ã‚‰ã«ç´°ã‹ãï¼ˆã‚ˆã‚Šé›·ã‚‰ã—ãï¼‰
                for (let iter = 0; iter < iterations; iter++) {
                    let newPoints = [];
                    for (let j = 0; j < points.length - 1; j++) {
                        const start = points[j];
                        const end = points[j + 1];
                        newPoints.push(start);
                        
                        // ç‚¹é–“ã®ä¸­é–“ç‚¹ã‚’è¨ˆç®—
                        const midX = (start.x + end.x) / 2;
                        const midY = (start.y + end.y) / 2;
                        
                        // ä¸­é–“ç‚¹ã‚’å¤‰ä½
                        const displacement = (Math.random() * 2 - 1) * displacementFactor / (iter + 1);
                        const dx = end.x - start.x;
                        const dy = end.y - start.y;
                        const perpX = -dy;
                        const perpY = dx;
                        
                        const length = Math.sqrt(perpX * perpX + perpY * perpY);
                        if (length > 0) {
                            const normalizedPerpX = perpX / length;
                            const normalizedPerpY = perpY / length;
                            
                            const newX = midX + normalizedPerpX * displacement;
                            const newY = midY + normalizedPerpY * displacement;
                            
                            newPoints.push({ x: newX, y: newY });
                        }
                    }
                    newPoints.push(points[points.length - 1]);
                    points = newPoints;
                }
                
                return points;
            }
            
            // é›·ãƒ‘ã‚¹ã‹ã‚‰SVGãƒ‘ã‚¹æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
            function createPathString(points) {
                let pathString = `M ${points[0].x} ${points[0].y}`;
                for (let i = 1; i < points.length; i++) {
                    pathString += ` L ${points[i].x} ${points[i].y}`;
                }
                return pathString;
            }
            
            // é›·ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
            function createLightning(startX, startY, endX, endY, color, width, brightness = 1) {
                const points = generateLightningPath(startX, startY, endX, endY, 40, 5, 20);
                const pathString = createPathString(points);
                
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", pathString);
                path.setAttribute("stroke", color);
                path.setAttribute("stroke-width", width);
                path.setAttribute("fill", "none");
                path.setAttribute("stroke-linecap", "round");
                path.setAttribute("stroke-linejoin", "round");
                path.setAttribute("opacity", brightness);
                path.setAttribute("filter", "url(#lightningGlow)");
                svg.appendChild(path);
                
                return { path, points };
            }
            
            // æåˆ†ã‹ã‚Œé›·ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
            function createBranchLightning(mainPoints, branchIndex, color, width, brightness = 0.7) {
                if (branchIndex < 1 || branchIndex >= mainPoints.length - 1) return null;
                
                const startPoint = mainPoints[branchIndex];
                const prevPoint = mainPoints[branchIndex - 1];
                
                // æåˆ†ã‹ã‚Œã®æ–¹å‘ã‚’æ±ºå®šï¼ˆå‰ã®ç‚¹ã¨ã®è§’åº¦ã‹ã‚‰æ´¾ç”Ÿï¼‰
                const dx = startPoint.x - prevPoint.x;
                const dy = startPoint.y - prevPoint.y;
                const angle = Math.atan2(dy, dx);
                
                // æåˆ†ã‹ã‚Œã®æ–¹å‘ã«ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’è¿½åŠ 
                const branchAngle = angle + (Math.random() * 1.5 - 0.5);
                const branchLength = Math.random() * 300 + 100;
                
                const endX = startPoint.x + Math.cos(branchAngle) * branchLength;
                const endY = startPoint.y + Math.sin(branchAngle) * branchLength;
                
                const points = generateLightningPath(startPoint.x, startPoint.y, endX, endY, 25, 4, 15);
                const pathString = createPathString(points);
                
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", pathString);
                path.setAttribute("stroke", color);
                path.setAttribute("stroke-width", width);
                path.setAttribute("fill", "none");
                path.setAttribute("stroke-linecap", "round");
                path.setAttribute("stroke-linejoin", "round");
                path.setAttribute("opacity", brightness);
                path.setAttribute("filter", "url(#lightningGlow)");
                svg.appendChild(path);
                
                // ã•ã‚‰ã«æåˆ†ã‹ã‚Œã™ã‚‹å¯èƒ½æ€§
                let subBranch = null;
                if (Math.random() < 0.5 && points.length > 3) {
                    const subBranchIndex = Math.floor(Math.random() * (points.length - 2)) + 1;
                    subBranch = createBranchLightning(points, subBranchIndex, color, width * 0.6, brightness * 0.7);
                }
                
                return { path, points, subBranch };
            }
            
            // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ä½œæˆ
            function createBackgroundFlash() {
                const flash = document.createElementNS(svgNS, "rect");
                flash.setAttribute("width", "100%");
                flash.setAttribute("height", "100%");
                flash.setAttribute("fill", "rgba(230, 240, 255, 0)");
                svg.appendChild(flash);
                return flash;
            }
            
            // é›·ã®é–ƒå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            function createLightningFlash(x, y, size) {
                const flash = document.createElementNS(svgNS, "circle");
                flash.setAttribute("cx", x);
                flash.setAttribute("cy", y);
                flash.setAttribute("r", size);
                flash.setAttribute("fill", "rgba(255, 255, 255, 0)");
                flash.setAttribute("filter", "url(#lightningGlow)");
                svg.appendChild(flash);
                return flash;
            }
            
            // è¡æ’ƒæ³¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            function createImpactEffect(x, y) {
                const impact = document.createElement('div');
                impact.classList.add('impact-effect');
                impact.style.left = `${x - 50}px`;
                impact.style.top = `${y - 50}px`;
                container.appendChild(impact);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                let size = 0;
                const maxSize = 300;
                const duration = 1000;
                const startTime = Date.now();
                
                function animateImpact() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    size = maxSize * progress;
                    impact.style.width = `${size}px`;
                    impact.style.height = `${size}px`;
                    impact.style.opacity = 1 - progress;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateImpact);
                    } else {
                        container.removeChild(impact);
                    }
                }
                
                requestAnimationFrame(animateImpact);
            }
            
            // ä½¿ç”¨ä¸­ã®SVGãƒãƒ¼ãƒ‰
            let activeNodes = {
                paths: [],
                flashes: [],
                rects: []
            };
            
            // é›·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒãƒ¼IDï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ï¼‰
            let lightningTimerId = null;
            let isAnimating = false;
            
            // é›·å…¨ä½“ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹é–¢æ•°ï¼ˆã‚¿ãƒƒãƒ—ä½ç½®å¯¾å¿œç‰ˆï¼‰
            function animateLightning(targetX = null, targetY = null) {
                // ç¾åœ¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã‹ã¤ã‚¿ãƒƒãƒ—ä½ç½®æŒ‡å®šã§ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (isAnimating && targetX === null && targetY === null) {
                    return;
                }
                
                // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                if (lightningTimerId) {
                    clearTimeout(lightningTimerId);
                    lightningTimerId = null;
                }
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                isAnimating = true;
                
                // ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
                lightningContainer.style.opacity = 1;
                
                // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ä½œæˆ
                const backgroundFlash = createBackgroundFlash();
                activeNodes.rects.push(backgroundFlash);
                
                // ãƒ¡ã‚¤ãƒ³ã®é›·ã®é–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®
                let mainStartX, mainStartY, mainEndX, mainEndY;
                
                if (targetX !== null && targetY !== null) {
                    // ã‚¿ãƒƒãƒ—ä½ç½®ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                    mainStartX = targetX + (Math.random() * 40 - 20);
                    mainStartY = -50; // ç”»é¢ä¸Šéƒ¨ï¼ˆç”»é¢å¤–ï¼‰ã‹ã‚‰å§‹ã‚ã‚‹
                    mainEndX = targetX;
                    mainEndY = targetY; // ã‚¿ãƒƒãƒ—ä½ç½®
                } else {
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ï¼ˆè‡ªå‹•å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼‰
                    mainStartX = Math.random() * window.innerWidth * 0.8 + window.innerWidth * 0.1;
                    mainStartY = -50;
                    mainEndX = Math.random() * window.innerWidth * 0.8 + window.innerWidth * 0.1;
                    mainEndY = window.innerHeight + 50;
                }
                
                // è¤‡æ•°ã®é›·ã‚’ç•°ãªã‚‹å¤ªã•ã¨è‰²ã§é‡ã­ã‚‹ï¼ˆã‚°ãƒ­ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ï¼‰
                const mainLightnings = [];
                
                // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’é¸æŠ
                const LIGHTNING_COLORS = {
                    night: [
                        "#f0f9ff", // æœ€ã‚‚æ˜ã‚‹ã„ç™½é’è‰²
                        "#d6ebff", 
                        "#b8dfff", 
                        "#92d2ff"  // ã‚ˆã‚Šé’ã¿ãŒã‹ã£ãŸè‰²
                    ],
                    sunset: [
                        "#fff0e0", // æš–ã‹ã„ç™½
                        "#ffe0c0", 
                        "#ffd0a0", 
                        "#ffc080"  // ã‚ªãƒ¬ãƒ³ã‚¸ãŒã‹ã£ãŸè‰²
                    ],
                    fantasy: [
                        "#f0e0ff", // è–„ç´«è‰²ã®ç™½
                        "#e0c0ff", 
                        "#d0a0ff", 
                        "#c080ff"  // é®®ã‚„ã‹ãªç´«
                    ]
                };
                
                const colorPalette = LIGHTNING_COLORS[currentTheme];
                
                // ãƒ¡ã‚¤ãƒ³ã®é›·ï¼ˆæœ€ã‚‚å¤ªã„å¤–å´ã®å…‰ï¼‰
                const outerLightning = createLightning(
                    mainStartX, mainStartY, mainEndX, mainEndY, 
                    colorPalette[0], 12, 0.7
                );
                mainLightnings.push(outerLightning);
                activeNodes.paths.push(outerLightning.path);
                
                // å†…å´ã®å…‰
                for (let i = 0; i < 3; i++) {
                    const lightning = createLightning(
                        mainStartX, mainStartY, mainEndX, mainEndY, 
                        colorPalette[i], 10 - i * 2, 0.9 - i * 0.1
                    );
                    mainLightnings.push(lightning);
                    activeNodes.paths.push(lightning.path);
                }
                
                // ä¸­å¿ƒã®æœ€ã‚‚æ˜ã‚‹ã„éƒ¨åˆ†
                const coreLightning = createLightning(
                    mainStartX, mainStartY, mainEndX, mainEndY, 
                    "#ffffff", 2, 1.0
                );
                mainLightnings.push(coreLightning);
                activeNodes.paths.push(coreLightning.path);
                
                // æåˆ†ã‹ã‚Œé›·ã‚’è¿½åŠ ï¼ˆã‚ˆã‚Šè¤‡é›‘ã«ï¼‰
                const branches = [];
                const branchCount = Math.floor(Math.random() * 4) + 2; // æœ€ä½2ã¤ã®æ
                const mainPoints = mainLightnings[0].points;
                
                for (let i = 0; i < branchCount; i++) {
                    // é›·ã®ä¸­é–“éƒ¨åˆ†ã‹ã‚‰æåˆ†ã‹ã‚Œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
                    const branchIndex = Math.floor(Math.random() * (mainPoints.length * 0.6)) + Math.floor(mainPoints.length * 0.2);
                    
                    // å¤–å´ã®ã‚°ãƒ­ãƒ¼
                    const outerBranch = createBranchLightning(
                        mainPoints, branchIndex, colorPalette[0], 6, 0.6
                    );
                    if (outerBranch) {
                        branches.push(outerBranch);
                        activeNodes.paths.push(outerBranch.path);
                        if (outerBranch.subBranch && outerBranch.subBranch.path) {
                            activeNodes.paths.push(outerBranch.subBranch.path);
                        }
                    }
                    
                    // å†…å´ã®æ˜ã‚‹ã„éƒ¨åˆ†
                    const innerBranch = createBranchLightning(
                        mainPoints, branchIndex, colorPalette[2], 3, 0.8
                    );
                    if (innerBranch) {
                        branches.push(innerBranch);
                        activeNodes.paths.push(innerBranch.path);
                        if (innerBranch.subBranch && innerBranch.subBranch.path) {
                            activeNodes.paths.push(innerBranch.subBranch.path);
                        }
                    }
                    
                    // ä¸­å¿ƒã®æœ€ã‚‚æ˜ã‚‹ã„éƒ¨åˆ†
                    const coreBranch = createBranchLightning(
                        mainPoints, branchIndex, "#ffffff", 1.5, 1.0
                    );
                    if (coreBranch) {
                        branches.push(coreBranch);
                        activeNodes.paths.push(coreBranch.path);
                        if (coreBranch.subBranch && coreBranch.subBranch.path) {
                            activeNodes.paths.push(coreBranch.subBranch.path);
                        }
                    }
                }
                
                // é›·ã®è¡çªç‚¹ã«é–ƒå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                const impactFlash = createLightningFlash(mainEndX, Math.min(mainEndY, window.innerHeight) - 50, 2);
                activeNodes.flashes.push(impactFlash);
                
                // è¡æ’ƒæ³¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                if (targetX !== null && targetY !== null) {
                    createImpactEffect(targetX, targetY);
                }
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼
                const startTime = Date.now();
                const flashDuration = 150; // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç¶™ç¶šæ™‚é–“
                const fadeDuration = 350;  // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆæ™‚é–“
                
                let isVisible = false;
                let lastToggleTime = 0;
                const flickerInterval = 15; // ç‚¹æ»…é–“éš”ï¼ˆmsï¼‰
                
                function animate() {
                    const now = Date.now();
                    const elapsed = now - startTime;
                    
                    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã®ã¡ã‚‰ã¤ãåŠ¹æœï¼ˆæœ€åˆã®200msï¼‰
                    if (elapsed < 200) {
                        if (now - lastToggleTime > flickerInterval) {
                            lastToggleTime = now;
                            isVisible = !isVisible;
                            
                            // ã™ã¹ã¦ã®é›·ã®å¯è¦–æ€§ã‚’ãƒˆã‚°ãƒ«
                            const visibility = isVisible ? 1 : 0.2;
                            mainLightnings.forEach(lightning => {
                                lightning.path.style.opacity = visibility;
                            });
                            branches.forEach(branch => {
                                if (branch && branch.path) {
                                    branch.path.style.opacity = visibility * 0.7;
                                }
                                if (branch && branch.subBranch && branch.subBranch.path) {
                                    branch.subBranch.path.style.opacity = visibility * 0.5;
                                }
                            });
                        }
                    }
                    
                    // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    let flashOpacity = 0;
                    if (elapsed < flashDuration) {
                        // å¾ã€…ã«æ˜ã‚‹ããªã‚‹
                        flashOpacity = elapsed / flashDuration * 0.8;
                    } else if (elapsed < flashDuration + fadeDuration) {
                        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                        flashOpacity = 0.8 - ((elapsed - flashDuration) / fadeDuration * 0.8);
                    }
                    
                    // ãƒ†ãƒ¼ãƒã«åˆã‚ã›ãŸãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ©ãƒ¼
                    let flashColor;
                    if (currentTheme === 'night') {
                        flashColor = `rgba(230, 240, 255, ${flashOpacity})`;
                    } else if (currentTheme === 'sunset') {
                        flashColor = `rgba(255, 230, 220, ${flashOpacity})`;
                    } else if (currentTheme === 'fantasy') {
                        flashColor = `rgba(230, 220, 255, ${flashOpacity})`;
                    }
                    
                    backgroundFlash.setAttribute("fill", flashColor);
                    
                    // è¡çªç‚¹ã®é–ƒå…‰
                    let impactOpacity = 0;
                    let impactSize = 0;
                    if (elapsed > flashDuration * 0.8 && elapsed < flashDuration + fadeDuration) {
                        impactOpacity = Math.min(1, (elapsed - flashDuration * 0.8) / (flashDuration * 0.2));
                        impactSize = impactOpacity * 50;
                        impactFlash.setAttribute("r", impactSize);
                        impactFlash.setAttribute("fill", `rgba(255, 255, 255, ${impactOpacity * 0.7})`);
                    } else if (elapsed >= flashDuration + fadeDuration) {
                        impactOpacity = Math.max(0, 1 - (elapsed - (flashDuration + fadeDuration)) / 300);
                        impactSize = 50 + (1 - impactOpacity) * 100;
                        impactFlash.setAttribute("r", impactSize);
                        impactFlash.setAttribute("fill", `rgba(255, 255, 255, ${impactOpacity * 0.3})`);
                    }
                    
                    // é›·ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                    if (elapsed > flashDuration + 100) {
                        const fadeOpacity = Math.max(0, 1 - (elapsed - (flashDuration + 100)) / fadeDuration);
                        
                        mainLightnings.forEach(lightning => {
                            lightning.path.style.opacity = fadeOpacity;
                        });
                        
                        branches.forEach(branch => {
                            if (branch && branch.path) {
                                branch.path.style.opacity = fadeOpacity * 0.7;
                            }
                            if (branch && branch.subBranch && branch.subBranch.path) {
                                branch.subBranch.path.style.opacity = fadeOpacity * 0.5;
                            }
                        });
                    }
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†åˆ¤å®š
                    if (elapsed < flashDuration + fadeDuration + 500) {
                        requestAnimationFrame(animate);
                    } else {
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†
                        isAnimating = false;
                        lightningContainer.style.opacity = 0;
                        
                        // SVGå†…ã®é›·è¦ç´ ã‚’ã‚¯ãƒªã‚¢
                        activeNodes.paths.forEach(path => {
                            if (path.parentNode) {
                                path.parentNode.removeChild(path);
                            }
                        });
                        activeNodes.flashes.forEach(flash => {
                            if (flash.parentNode) {
                                flash.parentNode.removeChild(flash);
                            }
                        });
                        activeNodes.rects.forEach(rect => {
                            if (rect.parentNode) {
                                rect.parentNode.removeChild(rect);
                            }
                        });
                        activeNodes = { paths: [], flashes: [], rects: [] };
                        
                        // æ¬¡ã®é›·ã¾ã§ã®é…å»¶ï¼ˆè‡ªå‹•å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
                        if (autoPlay) {
                            const nextDelay = Math.random() * 3000 + 2000;
                            lightningTimerId = setTimeout(() => {
                                animateLightning();
                            }, nextDelay);
                        }
                    }
                }
                
                // é›·ã®éŸ³ã‚’å†ç”Ÿ
                playThunderSound();
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                requestAnimationFrame(animate);
            }
            
            // é›·ã®éŸ³ã‚’å†ç”Ÿï¼ˆã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–å¾—ï¼‰
            function playThunderSound() {
                if (!soundEnabled) return;
                
                // åˆ©ç”¨å¯èƒ½ãªã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’è¦‹ã¤ã‘ã‚‹
                const audio = audioPool.find(a => a.paused) || audioPool[0];
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªé›·éŸ³ã‚’è¨­å®š
                const soundIndex = Math.floor(Math.random() * THUNDER_SOUNDS.length);
                audio.src = THUNDER_SOUNDS[soundIndex];
                
                // éŸ³é‡ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰åŒ–ã•ã›ã‚‹ï¼ˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                audio.volume = 0.3 + Math.random() * 0.4;
                
                // å†ç”Ÿ
                audio.play().catch(e => {
                    console.log('Thunder sound play failed: ' + e);
                });
            }
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
            function handleResize() {
                svg.setAttribute("viewBox", "0 0 " + window.innerWidth + " " + window.innerHeight);
                createStars();
            }
            
            // åˆæœŸåŒ–é–¢æ•°
            function init() {
                // æ˜Ÿã‚’ä½œæˆ
                createStars();
                
                // é›·ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½œæˆ
                createLightningFilter();
                
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¦ç´ ã®åˆæœŸè¨­å®š
                countdown.style.display = 'none';
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                startButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showCountdown();
                });
                
                // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                retryButton.addEventListener('click', function() {
                    resultBox.classList.remove('show');
                    gameActive = false; // ã‚²ãƒ¼ãƒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆ
                    setTimeout(() => {
                        resultBox.style.display = 'none';
                        showCountdown();
                    }, 300);
                });
                
                // åˆæœŸãƒ†ãƒ¼ãƒè¨­å®š
                setTheme('night');
                
                // åˆæœŸãƒ¢ãƒ¼ãƒ‰è¨­å®š - å¿…ãšã€Œãµã¤ã†ãƒ¢ãƒ¼ãƒ‰ã€ã‹ã‚‰å§‹ã‚ã‚‹
                normalMode.classList.add('active');
                gameMode.classList.remove('active');
                currentMode = 'normal';
                difficultySelector.style.display = 'none';
                
                // é›£æ˜“åº¦ã®åˆæœŸè¨­å®š
                setDifficulty('easy');
                
                // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆæœ€å¾Œã«å®Ÿè¡Œã—ã¦ä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†ã«ï¼‰
                showMessage('é›·ã®ä¸–ç•Œã¸ã‚ˆã†ã“ãï¼', 'ã‚¿ãƒƒãƒ—ã—ã¦éŠã‚“ã§ã¿ã‚ˆã†ï¼', 3000);
            }
            
            // ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§é›·ã‚’ç™ºç”Ÿã•ã›ã‚‹
            container.addEventListener('click', function(e) {
                // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«UIãƒ‘ãƒãƒ«å†…ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
                if (e.target.closest('.ui-container') || e.target.closest('.message-box') || e.target.closest('.result-box')) return;
                
                // çµæœè¡¨ç¤ºä¸­ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–ï¼ˆè¿½åŠ ï¼‰
                if (resultBox.style.display === 'block') return;
                
                // ã‚¯ãƒªãƒƒã‚¯åº§æ¨™ã‚’å–å¾—
                const clickX = e.clientX;
                const clickY = e.clientY;
                
                // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç†
                if (currentMode === 'normal') {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ - ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«é›·ã‚’ç™ºç”Ÿ
                    animateLightning(clickX, clickY);
                } else if (currentMode === 'game') {
                    // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰
                    if (!gameActive && !countdownActive) {
                        // ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
                        showCountdown();
                    } else if (gameActive) {
                        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ’ãƒƒãƒˆåˆ¤å®š
                        let targetHit = false;
                        
                        // å„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã¤ã„ã¦ãƒã‚§ãƒƒã‚¯
                        for (let i = 0; i < targetsActive.length; i++) {
                            const targetData = targetsActive[i];
                            const targetElement = targetData.element;
                            const targetRect = targetElement.getBoundingClientRect();
                            const targetX = targetRect.left + targetRect.width / 2;
                            const targetY = targetRect.top + targetRect.height / 2;
                            
                            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å½“ãŸã‚Šåˆ¤å®šï¼ˆå††å½¢ï¼‰
                            const dx = targetX - clickX;
                            const dy = targetY - clickY;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < targetData.size / 2 + 10) { // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚ºã«å¿œã˜ãŸå½“ãŸã‚Šåˆ¤å®š
                                // ãƒ’ãƒƒãƒˆå‡¦ç†
                                targetHit = true;
                                hitTarget(targetElement, targetX, targetY);
                                break;
                            }
                        }
                        
                        if (!targetHit) {
                            // ãƒŸã‚¹ - é›·ã¯ç™ºç”Ÿã•ã›ã‚‹ãŒå¾—ç‚¹ã¯å…¥ã‚‰ãªã„
                            combo = 0; // ã‚³ãƒ³ãƒœã‚’ãƒªã‚»ãƒƒãƒˆ
                            updateCombo();
                            animateLightning(clickX, clickY);
                            playSFX('fail');
                        }
                    }
                }
            });
            
            // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
            gameMode.addEventListener('click', function(e) {
                e.stopPropagation();
                setMode('game');
            });
            
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
            normalMode.addEventListener('click', function(e) {
                e.stopPropagation();
                setMode('normal');
            });
            
            // é›£æ˜“åº¦ãƒœã‚¿ãƒ³
            easyMode.addEventListener('click', function(e) {
                e.stopPropagation();
                setDifficulty('easy');
            });
            
            normalDifficulty.addEventListener('click', function(e) {
                e.stopPropagation();
                setDifficulty('normal');
            });
            
            hardMode.addEventListener('click', function(e) {
                e.stopPropagation();
                setDifficulty('hard');
            });
            
            // å†ç”Ÿãƒœã‚¿ãƒ³
            playButton.addEventListener('click', function(e) {
                e.stopPropagation();
                
                autoPlay = !autoPlay;
                
                if (autoPlay) {
                    this.innerHTML = '<span class="emoji">â¹ï¸</span>è‡ªå‹•é›· OFF';
                    animateLightning();
                } else {
                    this.innerHTML = '<span class="emoji">ğŸ”„</span>è‡ªå‹•é›· ON';
                    
                    // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    if (lightningTimerId) {
                        clearTimeout(lightningTimerId);
                        lightningTimerId = null;
                    }
                }
                
                playSFX('click');
            });
            
            // ã‚µã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³
            soundButton.addEventListener('click', function(e) {
                e.stopPropagation();
                
                soundEnabled = !soundEnabled;
                
                if (soundEnabled) {
                    this.innerHTML = '<span class="emoji">ğŸ”Š</span>éŸ³ ON';
                    
                    // ã‚µã‚¦ãƒ³ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ãŸã‚‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
                    preloadAudio();
                } else {
                    this.innerHTML = '<span class="emoji">ğŸ”‡</span>éŸ³ OFF';
                }
                
                playSFX('click');
            });
            
            // æƒ…å ±ãƒœã‚¿ãƒ³
            infoButton.addEventListener('click', function(e) {
                e.stopPropagation();
                
                const tips = [
                    'ã„ã‚ã„ã‚ãªã¨ã“ã‚ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é›·ã‚’è½ã¨ã—ã¦ã¿ã‚ˆã†ï¼',
                    'ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚³ãƒ³ãƒœã‚’ç¹‹ã’ã‚‹ã¨é«˜å¾—ç‚¹ãŒç‹™ãˆã‚‹ã‚ˆï¼',
                    'ãƒ†ãƒ¼ãƒã‚’å¤‰ãˆã‚‹ã¨é›·ã®è‰²ã‚‚å¤‰ã‚ã‚‹ã‚ˆï¼',
                    'ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚‹ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒå°ã•ããªã£ãŸã‚Šé€Ÿããªã£ãŸã‚Šã™ã‚‹ã‚ˆï¼',
                    'é›£æ˜“åº¦ã«ã‚ˆã£ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ•°ã‚„å‹•ãæ–¹ãŒå¤‰ã‚ã‚‹ã‚ˆï¼',
                    'ä¸€ç•ªé›£ã—ã„ã€Œã‚€ãšã‹ã—ã„ã€ãƒ¢ãƒ¼ãƒ‰ã§é«˜å¾—ç‚¹ã‚’ç‹™ãŠã†ï¼'
                ];
                
                const tipIndex = Math.floor(Math.random() * tips.length);
                showMessage('ã‚ãã³ã‹ãŸ', tips[tipIndex], 4000);
                
                playSFX('click');
            });
            
            // ãƒ†ãƒ¼ãƒé¸æŠ
            nightTheme.addEventListener('click', function(e) {
                e.stopPropagation();
                setTheme('night');
            });
            
            sunsetTheme.addEventListener('click', function(e) {
                e.stopPropagation();
                setTheme('sunset');
            });
            
            fantasyTheme.addEventListener('click', function(e) {
                e.stopPropagation();
                setTheme('fantasy');
            });
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
            window.addEventListener('resize', handleResize);
            
            // åˆæœŸåŒ–
            init();
        });
    </script>
</body>
</html>