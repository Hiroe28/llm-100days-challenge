<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é€šå­¦è·¯åœ°å›³ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
      overflow: hidden;
      height: 100vh;
    }

    /* åœ°å›³ï¼ˆå…¨ç”»é¢ï¼‰ */
    #map {
      width: 100%;
      height: 100vh;
      background: #e5e7eb;
    }

    /* æ¤œç´¢ãƒãƒ¼ï¼ˆä¸Šéƒ¨å›ºå®šï¼‰ */
    .search-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 999;
    }

    .search-container {
      display: flex;
      gap: 8px;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
    }

    .search-input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .search-btn:hover {
      background: #5568d3;
    }

    /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆPCç”¨ï¼šå·¦ä¸Šï¼‰ */
    .floating-toolbar {
      position: fixed;
      top: 70px;
      left: 16px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 16px;
      z-index: 998;
      max-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toolbar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .toolbar-title {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
    }

    .toolbar-toggle {
      width: 28px;
      height: 28px;
      background: #f3f4f6;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .toolbar-toggle:hover {
      background: #e5e7eb;
    }

    .toolbar-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toolbar-content.collapsed {
      display: none;
    }

    .tool-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tool-group-label {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tool-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tool-btn {
      flex: 1;
      min-width: 70px;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    .tool-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .tool-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .tool-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .tool-btn.btn-success {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .tool-btn.btn-success:hover {
      background: #059669;
    }

    .tool-btn.btn-preview {
      background: #f59e0b;
      color: white;
      border-color: #f59e0b;
    }

    .tool-btn.btn-preview:hover {
      background: #d97706;
    }

    .tool-btn.btn-preview.active {
      background: #7c2d12;
      border-color: #7c2d12;
    }

    .color-buttons {
      display: flex;
      gap: 6px;
    }

    .color-btn {
      flex: 1;
      height: 40px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .color-btn.active {
      border-color: #667eea;
      border-width: 3px;
      transform: scale(1.05);
    }

    .color-btn.red { background: #ef4444; }
    .color-btn.blue { background: #3b82f6; }
    .color-btn.black { background: #1f2937; }

    .tool-select, .tool-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      background: white;
      transition: all 0.2s;
    }

    .tool-select:focus, .tool-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    /* ç”»åƒã‚µã‚¤ã‚ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .size-preview {
      margin-top: 8px;
      padding: 8px;
      background: #f3f4f6;
      border-radius: 6px;
      font-size: 11px;
      color: #6b7280;
    }

    .size-preview-box {
      margin-top: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 4px;
      padding: 8px;
    }

    .size-preview-rect {
      border: 2px solid #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .stat-badges {
      display: flex;
      gap: 8px;
    }

    .stat-badge {
      flex: 1;
      background: #667eea;
      color: white;
      padding: 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }

    .stat-badge.green {
      background: #10b981;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœãƒˆãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .mobile-toolbar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 12px 16px 20px;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.15);
      z-index: 998;
    }

    .mobile-toolbar-main {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .mobile-toolbar-main .tool-btn {
      flex: 1;
      padding: 14px 8px;
      font-size: 13px;
    }

    .mobile-toolbar-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .mobile-toolbar-actions .tool-btn {
      flex: 1;
      padding: 12px 8px;
      font-size: 12px;
    }

    .settings-btn {
      width: 100%;
      padding: 12px;
      background: #374151;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      background: #f3f4f6;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* é€šçŸ¥ */
    .notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      animation: slideDown 0.3s ease;
    }

    .notification.show {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */
    .help-text {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 9999;
      display: none;
      max-width: 90%;
      text-align: center;
    }

    .help-text.show {
      display: block;
    }

    /* ç·šæç”»å®Œäº†ãƒœã‚¿ãƒ³ */
    .line-complete-btn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #10b981;
      color: white;
      padding: 16px 32px;
      border-radius: 30px;
      font-size: 17px;
      font-weight: 700;
      z-index: 10000;
      display: none;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
      border: 3px solid white;
      cursor: pointer;
      animation: slideUp 0.3s ease, pulse 2s ease-in-out infinite;
    }

    .line-complete-btn.show {
      display: block;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
      }
      50% {
        box-shadow: 0 6px 30px rgba(16, 185, 129, 0.8);
      }
    }

    /* ä¿å­˜ç¯„å›²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ  */
    .save-range-preview {
      position: fixed;
      border: 3px dashed rgba(239, 68, 68, 0.6);
      background: rgba(239, 68, 68, 0.05);
      pointer-events: none;
      z-index: 995;
      display: none;
    }

    .save-range-preview.show {
      display: block;
    }

    .save-range-corner {
      position: absolute;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(239, 68, 68, 0.8);
      background: white;
    }

    .save-range-corner.top-left {
      top: -3px;
      left: -3px;
      border-right: none;
      border-bottom: none;
    }

    .save-range-corner.top-right {
      top: -3px;
      right: -3px;
      border-left: none;
      border-bottom: none;
    }

    .save-range-corner.bottom-left {
      bottom: -3px;
      left: -3px;
      border-right: none;
      border-top: none;
    }

    .save-range-corner.bottom-right {
      bottom: -3px;
      right: -3px;
      border-left: none;
      border-top: none;
    }

    .save-range-label {
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(239, 68, 68, 0.9);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      .floating-toolbar {
        display: none;
      }

      .mobile-toolbar {
        display: block;
      }

      .help-text {
        display: none !important;
      }

      .line-complete-btn {
        bottom: 230px;
        font-size: 16px;
        padding: 14px 28px;
      }

      .leaflet-top .leaflet-control-zoom {
        margin-top: 90px;
      }

    }

    /* ç·šã®å§‹ç‚¹ãƒãƒ¼ã‚«ãƒ¼ */
    .line-start-marker {
      width: 12px;
      height: 12px;
      background: #10b981;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
    }

    /* ä¿å­˜ä¸­å¿ƒãƒãƒ¼ã‚«ãƒ¼ï¼ˆåå­—ï¼‰ */
    .save-center-marker {
      position: fixed;
      width: 40px;
      height: 40px;
      z-index: 996;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .save-center-crosshair {
      position: relative;
      width: 40px;
      height: 40px;
    }

    .save-center-crosshair::before,
    .save-center-crosshair::after {
      content: '';
      position: absolute;
      background: #ef4444;
      box-shadow: 0 0 0 2px white, 0 0 8px rgba(0,0,0,0.5);
    }

    .save-center-crosshair::before {
      width: 2px;
      height: 40px;
      left: 19px;
      top: 0;
    }

    .save-center-crosshair::after {
      width: 40px;
      height: 2px;
      left: 0;
      top: 19px;
    }

    .save-center-label {
      position: fixed;
      z-index: 996;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- æ¤œç´¢ãƒãƒ¼ -->
  <div class="search-bar">
    <div class="search-container">
      <input type="text" id="addressInput" class="search-input" placeholder="å ´æ‰€ã‚’æ¤œç´¢ï¼ˆä¾‹: æœ­å¹Œå¸‚ç«‹â—‹â—‹å°å­¦æ ¡ï¼‰">
      <button id="searchBtn" class="search-btn">ğŸ” ç§»å‹•</button>
    </div>
  </div>

  <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆPCç”¨ï¼‰ -->
  <div class="floating-toolbar">
    <div class="toolbar-header">
      <div class="toolbar-title">ğŸ“ é€šå­¦è·¯ãƒ„ãƒ¼ãƒ«</div>
      <button class="toolbar-toggle" id="toolbarToggle">âˆ’</button>
    </div>
    
    <div class="toolbar-content" id="toolbarContent">
      <!-- åŸºæœ¬ãƒ„ãƒ¼ãƒ« -->
      <div class="tool-group">
        <div class="tool-group-label">åŸºæœ¬ãƒ„ãƒ¼ãƒ«</div>
        <div class="tool-buttons">
          <button id="toolPin" class="tool-btn">ğŸ“ ãƒ”ãƒ³</button>
          <button id="toolLine" class="tool-btn">ğŸ“ ç·š</button>
          <button id="toolMove" class="tool-btn">âœ‹ ãƒ”ãƒ³ç§»å‹•</button>
        </div>
      </div>

      <!-- è‰²é¸æŠ -->
      <div class="tool-group">
        <div class="tool-group-label">ç‚¹/ç·šã®è‰²</div>
        <div class="color-buttons">
          <div class="color-btn red" data-color="#ef4444"></div>
          <div class="color-btn blue" data-color="#3b82f6"></div>
          <div class="color-btn black active" data-color="#1f2937"></div>
        </div>
      </div>

      <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
      <div class="tool-group">
        <div class="tool-group-label">ã‚¢ã‚¤ã‚³ãƒ³</div>
        <select id="iconType" class="tool-select">
          <option value="none">ãªã—ï¼ˆç‚¹ã®ã¿ï¼‰</option>
          <option value="home">ğŸ  å®¶</option>
          <option value="school">ğŸ« å­¦æ ¡</option>
          <option value="pin">ğŸ“ ç›®å°</option>
          <option value="star">â­ é‡è¦</option>
          <option value="crossing">ğŸš¸ æ¨ªæ–­æ­©é“</option>
          <option value="warning">âš ï¸ æ³¨æ„</option>
          <option value="flag">ğŸš© æ——</option>
          <option value="stop">ğŸ›‘ åœæ­¢</option>
        </select>
      </div>

      <!-- ãƒ©ãƒ™ãƒ« -->
      <div class="tool-group">
        <div class="tool-group-label">ãƒ©ãƒ™ãƒ«</div>
        <input type="text" id="labelInput" class="tool-input" placeholder="ä¾‹: å®¶ã€å­¦æ ¡">
      </div>

      <!-- ä¿å­˜ä¸­å¿ƒ -->
      <div class="tool-group">
        <div class="tool-group-label">ä¿å­˜ä¸­å¿ƒ</div>
        <button id="centerToView" class="tool-btn" style="width: 100%;">â• è¡¨ç¤ºä¸­å¿ƒã«ç§»å‹•</button>
      </div>

      <!-- ç”»åƒã‚µã‚¤ã‚º -->
      <div class="tool-group">
        <div class="tool-group-label">ç”»åƒã‚µã‚¤ã‚º</div>
        <select id="imageSize" class="tool-select">
          <option value="1200x900">1200x900</option>
          <option value="900x1200">900x1200</option>
          <option value="1500x1500">1500x1500</option>
          <option value="2000x1500">2000x1500</option>
        </select>
      </div>

      <!-- çµ±è¨ˆ -->
      <div class="stat-badges">
        <div class="stat-badge" id="pinCount">ğŸ“ 0</div>
        <div class="stat-badge green" id="lineCount">ğŸ“ 0</div>
      </div>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="tool-group">
        <div class="tool-buttons">
          <button id="toolUndo" class="tool-btn" disabled>â†©ï¸ æç”»ã‚’æˆ»ã™</button>
          <button id="toolClear" class="tool-btn">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
        <button id="toolPreview" class="tool-btn btn-preview" style="width: 100%;">ğŸ—ºï¸ ç™½é»’åœ°å›³</button>
        <button id="toolSave" class="tool-btn btn-success" style="width: 100%;">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœãƒˆãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="mobile-toolbar">
    <div class="mobile-toolbar-main">
      <button id="toolPinMobile" class="tool-btn">ğŸ“<br>ãƒ”ãƒ³</button>
      <button id="toolLineMobile" class="tool-btn">ğŸ“<br>ç·š</button>
      <button id="toolUndoMobileBtn" class="tool-btn" disabled>â†©ï¸<br>æç”»ã‚’æˆ»ã™</button>
      <button id="toolMoveMobile" class="tool-btn">âœ‹<br>ãƒ”ãƒ³ç§»å‹•</button>
    </div>
    <div class="mobile-toolbar-actions">
      <button id="centerToViewMobileBtn" class="tool-btn">â•<br>ä¸­å¿ƒ</button>
      <button id="toolPreviewMobileBtn" class="tool-btn btn-preview">ğŸ—ºï¸<br>ç™½é»’åœ°å›³</button>
      <button id="toolSaveMobile" class="tool-btn btn-success">ğŸ’¾<br>ä¿å­˜</button>
    </div>
    <button id="settingsBtnMobile" class="settings-btn">âš™ï¸ è©³ç´°è¨­å®š</button>
  </div>

  <!-- åœ°å›³ -->
  <div id="map"></div>

  <!-- ä¿å­˜ç¯„å›²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ  -->
  <div id="saveRangePreview" class="save-range-preview">
    <div class="save-range-corner top-left"></div>
    <div class="save-range-corner top-right"></div>
    <div class="save-range-corner bottom-left"></div>
    <div class="save-range-corner bottom-right"></div>
    <div class="save-range-label">ä¿å­˜ã•ã‚Œã‚‹ç¯„å›²ï¼ˆã‚ºãƒ¼ãƒ 18ï¼‰</div>
  </div>

  <!-- ä¿å­˜ä¸­å¿ƒãƒãƒ¼ã‚«ãƒ¼ï¼ˆåå­—ï¼‰ -->
  <div id="saveCenterMarker" class="save-center-marker">
    <div class="save-center-crosshair"></div>
  </div>
  <div id="saveCenterLabel" class="save-center-label">ä¿å­˜ã®ä¸­å¿ƒï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼‰</div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">âš™ï¸ è©³ç´°è¨­å®š</div>
        <button class="modal-close" id="modalClose">âœ•</button>
      </div>
      <div class="modal-body">
        <!-- ä¿å­˜ä¸­å¿ƒ -->
        <div class="tool-group">
          <div class="tool-group-label">ä¿å­˜ä¸­å¿ƒ</div>
          <button id="centerToViewMobile" class="tool-btn" style="width: 100%;">â• è¡¨ç¤ºä¸­å¿ƒã«ç§»å‹•</button>
        </div>

        <!-- è‰²é¸æŠ -->
        <div class="tool-group">
          <div class="tool-group-label">ç‚¹/ç·šã®è‰²</div>
          <div class="color-buttons">
            <div class="color-btn red modal-color active" data-color="#ef4444"></div>
            <div class="color-btn blue modal-color" data-color="#3b82f6"></div>
            <div class="color-btn black modal-color" data-color="#1f2937"></div>
          </div>
        </div>

        <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="tool-group">
          <div class="tool-group-label">ã‚¢ã‚¤ã‚³ãƒ³</div>
          <select id="iconTypeMobile" class="tool-select">
            <option value="none">ãªã—ï¼ˆç‚¹ã®ã¿ï¼‰</option>
            <option value="home">ğŸ  å®¶</option>
            <option value="school">ğŸ« å­¦æ ¡</option>
            <option value="pin">ğŸ“ ç›®å°</option>
            <option value="star">â­ é‡è¦</option>
            <option value="crossing">ğŸš¸ æ¨ªæ–­æ­©é“</option>
            <option value="warning">âš ï¸ æ³¨æ„</option>
            <option value="flag">ğŸš© æ——</option>
            <option value="stop">ğŸ›‘ åœæ­¢</option>
          </select>
        </div>

        <!-- ãƒ©ãƒ™ãƒ« -->
        <div class="tool-group">
          <div class="tool-group-label">ãƒ©ãƒ™ãƒ«</div>
          <input type="text" id="labelInputMobile" class="tool-input" placeholder="ä¾‹: å®¶ã€å­¦æ ¡">
        </div>

        <!-- ç”»åƒã‚µã‚¤ã‚º -->
        <div class="tool-group">
          <div class="tool-group-label">ç”»åƒã‚µã‚¤ã‚º</div>
          <select id="imageSizeMobile" class="tool-select">
            <option value="1200x900">1200x900</option>
            <option value="900x1200">900x1200</option>
            <option value="1500x1500">1500x1500</option>
            <option value="2000x1500">2000x1500</option>
          </select>
        </div>

        <!-- çµ±è¨ˆ -->
        <div class="stat-badges">
          <div class="stat-badge" id="pinCountMobile">ğŸ“ 0</div>
          <div class="stat-badge green" id="lineCountMobile">ğŸ“ 0</div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="tool-group">
          <div class="tool-buttons">
            <button id="toolUndoMobile" class="tool-btn" disabled>â†©ï¸ æç”»ã‚’æˆ»ã™</button>
            <button id="toolClearMobile" class="tool-btn">ğŸ—‘ï¸ å‰Šé™¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥ -->
  <div id="notification" class="notification"></div>

  <!-- ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ -->
  <div id="helpText" class="help-text"></div>

  <!-- ç·šæç”»å®Œäº†ãƒœã‚¿ãƒ³ -->
  <button id="lineCompleteBtn" class="line-complete-btn">âœ… ç·šã‚’å®Œäº†</button>

  <script>
    // åœ°å›³ã®åˆæœŸåŒ–
    const map = L.map('map', {
      doubleClickZoom: false
    }).setView([43.064, 141.347], 15);

    // åœ°å›³ã®çŠ¶æ…‹
    let isPreviewMode = false;
    let currentTool = null;
    let currentColor = '#1f2937';
    
    let markers = [];
    let polylines = [];
    let currentPolyline = null;
    let currentLineStartMarker = null;
    let polylinePoints = [];
    
    let history = [];
    let tileLayer;
    
    // ä¿å­˜ä¸­å¿ƒã®ç®¡ç†
    let saveCenterLatLng = map.getCenter(); // åˆæœŸå€¤ã¯åœ°å›³ã®ä¸­å¿ƒ
    let isDraggingSaveCenter = false;

    // ä¿å­˜ä¸­å¿ƒãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®æ›´æ–°
    function updateSaveCenterMarkerPosition() {
      const marker = document.getElementById('saveCenterMarker');
      const label = document.getElementById('saveCenterLabel');
      const point = map.latLngToContainerPoint(saveCenterLatLng);
      
      marker.style.left = (point.x - 20) + 'px';
      marker.style.top = (point.y - 20) + 'px';
      
      label.style.left = (point.x) + 'px';
      label.style.top = (point.y + 30) + 'px';
      label.style.transform = 'translateX(-50%)';
      
      // ä¿å­˜ç¯„å›²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ ã‚‚æ›´æ–°
      updateSaveRangePreview();
    }

    // ä¿å­˜ç¯„å›²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ ã®æ›´æ–°
    function updateSaveRangePreview() {
      const imageSizeStr = document.getElementById('imageSize').value;
      const [width, height] = imageSizeStr.split('x').map(Number);
      
      const saveZoom = 18;
      const currentZoom = map.getZoom();
      
      // ã‚ºãƒ¼ãƒ å·®ã«ã‚ˆã‚‹å€ç‡è¨ˆç®—
      const scale = Math.pow(2, currentZoom - saveZoom);
      
      // ç”»é¢ä¸Šã§ã®ä¿å­˜ç¯„å›²ã®ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
      const displayWidth = width * scale;
      const displayHeight = height * scale;
      
      // ä¿å­˜ä¸­å¿ƒã®ç”»é¢åº§æ¨™
      const centerPoint = map.latLngToContainerPoint(saveCenterLatLng);
      
      const preview = document.getElementById('saveRangePreview');
      preview.style.width = displayWidth + 'px';
      preview.style.height = displayHeight + 'px';
      preview.style.left = (centerPoint.x - displayWidth / 2) + 'px';
      preview.style.top = (centerPoint.y - displayHeight / 2) + 'px';
      preview.classList.add('show');
    }

    // ä¿å­˜ç¯„å›²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ ã®è¡¨ç¤º/éè¡¨ç¤º
    function showSaveRangePreview() {
      updateSaveRangePreview();
    }

    function hideSaveRangePreview() {
      document.getElementById('saveRangePreview').classList.remove('show');
    }

    // åœ°å›³ç§»å‹•æ™‚ã«ãƒãƒ¼ã‚«ãƒ¼ä½ç½®ã‚’æ›´æ–°
    map.on('move', updateSaveCenterMarkerPosition);
    map.on('zoom', updateSaveCenterMarkerPosition);

    // ä¿å­˜ä¸­å¿ƒãƒãƒ¼ã‚«ãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
    const saveCenterMarker = document.getElementById('saveCenterMarker');
    const saveCenterLabel = document.getElementById('saveCenterLabel');
    
    let dragStartX, dragStartY;
    let markerStartX, markerStartY;

    function startDrag(e) {
      isDraggingSaveCenter = true;
      const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
      
      dragStartX = clientX;
      dragStartY = clientY;
      
      const point = map.latLngToContainerPoint(saveCenterLatLng);
      markerStartX = point.x;
      markerStartY = point.y;
      
      saveCenterMarker.style.cursor = 'grabbing';
      saveCenterLabel.textContent = 'ç§»å‹•ä¸­...';
      
      e.preventDefault();
    }

    function doDrag(e) {
      if (!isDraggingSaveCenter) return;
      
      const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
      
      const deltaX = clientX - dragStartX;
      const deltaY = clientY - dragStartY;
      
      const newPoint = L.point(markerStartX + deltaX, markerStartY + deltaY);
      saveCenterLatLng = map.containerPointToLatLng(newPoint);
      
      updateSaveCenterMarkerPosition();
      
      e.preventDefault();
    }

    function endDrag(e) {
      if (!isDraggingSaveCenter) return;
      
      isDraggingSaveCenter = false;
      saveCenterMarker.style.cursor = 'grab';
      saveCenterLabel.textContent = 'ä¿å­˜ã®ä¸­å¿ƒï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼‰';
      
      e.preventDefault();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    saveCenterMarker.style.cursor = 'grab';
    saveCenterMarker.style.pointerEvents = 'auto';
    saveCenterLabel.style.pointerEvents = 'auto';

    saveCenterMarker.addEventListener('mousedown', startDrag);
    saveCenterMarker.addEventListener('touchstart', startDrag);
    saveCenterLabel.addEventListener('mousedown', startDrag);
    saveCenterLabel.addEventListener('touchstart', startDrag);

    document.addEventListener('mousemove', doDrag);
    document.addEventListener('touchmove', doDrag, { passive: false });
    
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    // åˆæœŸä½ç½®è¨­å®šã¨ç¯„å›²è¡¨ç¤º
    updateSaveCenterMarkerPosition();
    showSaveRangePreview();

    // ç™½é»’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ç·šã®è‰²ã‚’å–å¾—
    function getLineColor(baseColor) {
      if (!isPreviewMode) {
        return baseColor;
      }
      // ç™½é»’ãƒ¢ãƒ¼ãƒ‰ã§ã¯æ˜ã‚‹ã„è‰²ã«å¤‰æ›
      const colorMap = {
        '#ef4444': '#ff0000',  // èµ¤ â†’ æ˜ã‚‹ã„èµ¤
        '#3b82f6': '#0066ff',  // é’ â†’ æ˜ã‚‹ã„é’
        '#1f2937': '#ff00ff'   // é»’ â†’ ãƒã‚¼ãƒ³ã‚¿ï¼ˆç›®ç«‹ã¤è‰²ï¼‰
      };
      return colorMap[baseColor] || '#ff0000';
    }

    // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°
    function updateTileLayer() {
      if (tileLayer) {
        map.removeLayer(tileLayer);
      }

      const stadiaApiKey = 'bd319ee8-343b-42e5-b811-a449c58bef78';
      let tileUrl;

      if (isPreviewMode) {
        tileUrl = `https://tiles.stadiamaps.com/tiles/stamen_toner_background/{z}/{x}/{y}{r}.png?api_key=${stadiaApiKey}`;
      } else {
        tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      }

      tileLayer = L.tileLayer(tileUrl, {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
    }

    updateTileLayer();

    // é€šçŸ¥è¡¨ç¤º
    function showNotification(message, duration = 2000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
    function showHelp(message) {
      const helpText = document.getElementById('helpText');
      helpText.textContent = message;
      helpText.classList.add('show');
    }

    function hideHelp() {
      const helpText = document.getElementById('helpText');
      helpText.classList.remove('show');
    }

    // å®Œäº†ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
    function showCompleteButton() {
      document.getElementById('lineCompleteBtn').classList.add('show');
    }

    function hideCompleteButton() {
      document.getElementById('lineCompleteBtn').classList.remove('show');
    }

    // ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ—
    const iconEmojiMap = {
      'home': 'ğŸ ',
      'school': 'ğŸ«',
      'pin': 'ğŸ“',
      'star': 'â­',
      'crossing': 'ğŸš¸',
      'warning': 'âš ï¸',
      'flag': 'ğŸš©',
      'stop': 'ğŸ›‘'
    };

    // ã‚¢ã‚¤ã‚³ãƒ³ä½œæˆé–¢æ•°
    function createDotIcon(color) {
      return L.divIcon({
        html: `<div style="width:10px; height:10px; background:${color}; border-radius:50%; border:2px solid white; box-shadow:0 0 4px rgba(0,0,0,0.5);"></div>`,
        className: 'dot-marker',
        iconSize: [14, 14],
        iconAnchor: [7, 7]
      });
    }

    function createEmojiIcon(emoji, size = 30) {
      return L.divIcon({
        html: `<div style="font-size:${size}px; line-height:1; text-align:center;">${emoji}</div>`,
        className: 'custom-marker',
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
      });
    }

    function createLabeledIcon(emoji, label, size = 30, isDot = false) {
      if (isDot) {
        return L.divIcon({
          html: `
            <div style="text-align:center; position:relative;">
              <div style="width:10px; height:10px; background:${currentColor}; border-radius:50%; border:2px solid white; box-shadow:0 0 4px rgba(0,0,0,0.5); margin:0 auto;"></div>
              <div style="font-size:11px; font-weight:bold; color:#333; background:white; padding:2px 6px; border-radius:4px; margin-top:2px; white-space:nowrap; box-shadow:0 1px 3px rgba(0,0,0,0.3);">${label}</div>
            </div>
          `,
          className: 'custom-marker-with-label',
          iconSize: [14, 35],
          iconAnchor: [7, 7]
        });
      } else {
        return L.divIcon({
          html: `
            <div style="text-align:center; position:relative;">
              <div style="font-size:${size}px; line-height:1;">${emoji}</div>
              <div style="font-size:11px; font-weight:bold; color:#333; background:white; padding:2px 6px; border-radius:4px; margin-top:2px; white-space:nowrap; box-shadow:0 1px 3px rgba(0,0,0,0.3);">${label}</div>
            </div>
          `,
          className: 'custom-marker-with-label',
          iconSize: [size, size + 25],
          iconAnchor: [size/2, size/2]
        });
      }
    }

    function createLineStartMarker() {
      return L.divIcon({
        html: '<div class="line-start-marker"></div>',
        className: 'line-start-icon',
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStats() {
      document.getElementById('pinCount').textContent = `ğŸ“ ${markers.length}`;
      document.getElementById('lineCount').textContent = `ğŸ“ ${polylines.length}`;
      document.getElementById('pinCountMobile').textContent = `ğŸ“ ${markers.length}`;
      document.getElementById('lineCountMobile').textContent = `ğŸ“ ${polylines.length}`;
    }

    // Undoæ©Ÿèƒ½ã®æ›´æ–°
    function updateUndoButton() {
      const disabled = history.length === 0;
      document.getElementById('toolUndo').disabled = disabled;
      document.getElementById('toolUndoMobile').disabled = disabled;
      document.getElementById('toolUndoMobileBtn').disabled = disabled;
    }

    // å±¥æ­´ã«è¿½åŠ 
    function addToHistory(type, data) {
      history.push({ type, data });
      updateUndoButton();
    }

    // ç·šã‚’å®Œäº†
    function completeLine() {
      if (currentPolyline && polylinePoints.length > 1) {
        polylines.push(currentPolyline);
        addToHistory('polyline', currentPolyline);
        currentPolyline = null;
        polylinePoints = [];
        if (currentLineStartMarker) {
          map.removeLayer(currentLineStartMarker);
          currentLineStartMarker = null;
        }
        updateStats();
        hideCompleteButton();
        showNotification('âœ… ç·šã‚’å®Œäº†ã—ã¾ã—ãŸ');
        if (currentTool === 'line') {
          showHelp('ğŸ“ ç·šã®å§‹ç‚¹ã‚’ã‚¿ãƒƒãƒ—');
        }
      }
    }

    // æç”»ä¸­ã®ç·šã‚’è‡ªå‹•å®Œäº†ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆä»–ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ç”¨ï¼‰
    function autoCompleteOrCancelLine() {
      if (currentPolyline && polylinePoints.length > 1) {
        // 2ç‚¹ä»¥ä¸Šãªã‚‰å®Œäº†
        polylines.push(currentPolyline);
        addToHistory('polyline', currentPolyline);
        currentPolyline = null;
        polylinePoints = [];
        if (currentLineStartMarker) {
          map.removeLayer(currentLineStartMarker);
          currentLineStartMarker = null;
        }
        updateStats();
        hideCompleteButton();
        hideHelp();
      } else if (currentPolyline) {
        // 1ç‚¹ã ã‘ãªã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        map.removeLayer(currentPolyline);
        currentPolyline = null;
        polylinePoints = [];
        if (currentLineStartMarker) {
          map.removeLayer(currentLineStartMarker);
          currentLineStartMarker = null;
        }
        hideCompleteButton();
        hideHelp();
      }
    }

    // ãƒ„ãƒ¼ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
    function setTool(tool) {
      if (currentPolyline && polylinePoints.length > 1) {
        polylines.push(currentPolyline);
        addToHistory('polyline', currentPolyline);
        currentPolyline = null;
        polylinePoints = [];
        if (currentLineStartMarker) {
          map.removeLayer(currentLineStartMarker);
          currentLineStartMarker = null;
        }
        updateStats();
      } else if (currentPolyline) {
        map.removeLayer(currentPolyline);
        currentPolyline = null;
        polylinePoints = [];
        if (currentLineStartMarker) {
          map.removeLayer(currentLineStartMarker);
          currentLineStartMarker = null;
        }
      }

      hideCompleteButton();

      document.querySelectorAll('.tool-btn').forEach(btn => {
        const id = btn.id;
        if (id.includes('Pin') || id.includes('Line') || id.includes('Move')) {
          btn.classList.remove('active');
        }
      });

      currentTool = tool;
      hideHelp();

      markers.forEach(marker => {
        if (tool === 'move') {
          marker.dragging.enable();
        } else {
          marker.dragging.disable();
        }
      });

      if (tool === 'pin') {
        document.getElementById('toolPin').classList.add('active');
        document.getElementById('toolPinMobile').classList.add('active');
        map.getContainer().style.cursor = 'crosshair';
        showHelp('ğŸ“ åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ”ãƒ³ã‚’é…ç½®');
      } else if (tool === 'line') {
        document.getElementById('toolLine').classList.add('active');
        document.getElementById('toolLineMobile').classList.add('active');
        polylinePoints = [];
        map.getContainer().style.cursor = 'crosshair';
        showHelp('ğŸ“ ç·šã®å§‹ç‚¹ã‚’ã‚¿ãƒƒãƒ—');
      } else if (tool === 'move') {
        document.getElementById('toolMove').classList.add('active');
        document.getElementById('toolMoveMobile').classList.add('active');
        map.getContainer().style.cursor = 'grab';
        showHelp('âœ‹ ãƒ”ãƒ³ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•');
      } else {
        map.getContainer().style.cursor = '';
      }
    }

    // ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('toolPin').addEventListener('click', () => setTool(currentTool === 'pin' ? null : 'pin'));
    document.getElementById('toolLine').addEventListener('click', () => setTool(currentTool === 'line' ? null : 'line'));
    document.getElementById('toolMove').addEventListener('click', () => setTool(currentTool === 'move' ? null : 'move'));

    document.getElementById('toolPinMobile').addEventListener('click', () => setTool(currentTool === 'pin' ? null : 'pin'));
    document.getElementById('toolLineMobile').addEventListener('click', () => setTool(currentTool === 'line' ? null : 'line'));
    document.getElementById('toolMoveMobile').addEventListener('click', () => setTool(currentTool === 'move' ? null : 'move'));

    // ç·šå®Œäº†ãƒœã‚¿ãƒ³
    document.getElementById('lineCompleteBtn').addEventListener('click', completeLine);

    // Undoãƒœã‚¿ãƒ³
    function handleUndo() {
      autoCompleteOrCancelLine();
      
      if (history.length === 0) return;
      
      const lastAction = history.pop();
      
      if (lastAction.type === 'marker') {
        const marker = lastAction.data;
        map.removeLayer(marker);
        const index = markers.indexOf(marker);
        if (index > -1) {
          markers.splice(index, 1);
        }
      } else if (lastAction.type === 'polyline') {
        const line = lastAction.data;
        map.removeLayer(line);
        const index = polylines.indexOf(line);
        if (index > -1) {
          polylines.splice(index, 1);
        }
      }
      
      updateStats();
      updateUndoButton();
      showNotification('â†©ï¸ 1ã¤æˆ»ã—ã¾ã—ãŸ');
    }

    document.getElementById('toolUndo').addEventListener('click', handleUndo);
    document.getElementById('toolUndoMobile').addEventListener('click', handleUndo);
    document.getElementById('toolUndoMobileBtn').addEventListener('click', handleUndo);

    // å…¨å‰Šé™¤ãƒœã‚¿ãƒ³
    function handleClear() {
      autoCompleteOrCancelLine();
      
      if (markers.length === 0 && polylines.length === 0) {
        showNotification('å‰Šé™¤ã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (confirm('ã™ã¹ã¦ã®ãƒ”ãƒ³ã¨ç·šã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
        markers.forEach(marker => map.removeLayer(marker));
        polylines.forEach(line => map.removeLayer(line));
        if (currentPolyline) map.removeLayer(currentPolyline);
        if (currentLineStartMarker) map.removeLayer(currentLineStartMarker);
        
        markers = [];
        polylines = [];
        currentPolyline = null;
        currentLineStartMarker = null;
        polylinePoints = [];
        history = [];
        updateStats();
        updateUndoButton();
        showNotification('ğŸ—‘ï¸ ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    }

    document.getElementById('toolClear').addEventListener('click', handleClear);
    document.getElementById('toolClearMobile').addEventListener('click', handleClear);

    // ç™½é»’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    function handlePreview() {
      autoCompleteOrCancelLine();
      
      isPreviewMode = !isPreviewMode;
      
      const previewBtn = document.getElementById('toolPreview');
      const previewBtnMobile = document.getElementById('toolPreviewMobileBtn');
      
      if (isPreviewMode) {
        // PCï¼ˆæ”¹è¡Œã„ã‚‰ãªã„ãªã‚‰ textContent ã®ã¾ã¾ã§OKï¼‰
        previewBtn.textContent = 'ğŸ—ºï¸ã‚«ãƒ©ãƒ¼åœ°å›³';

        // âœ… ãƒ¢ãƒã‚¤ãƒ«ï¼ˆ<br> ã‚’åŠ¹ã‹ã›ã‚‹ï¼‰
        previewBtnMobile.innerHTML = 'ğŸ—ºï¸<br>ã‚«ãƒ©ãƒ¼åœ°å›³';

        previewBtn.classList.add('active');
        previewBtnMobile.classList.add('active');
        map.setZoom(18);
        showNotification('ç™½é»’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰', 3000);
      } else {
        previewBtn.textContent = 'ğŸ—ºï¸ç™½é»’åœ°å›³';

        // âœ… ãƒ¢ãƒã‚¤ãƒ«ï¼ˆ<br> ã‚’åŠ¹ã‹ã›ã‚‹ï¼‰
        previewBtnMobile.innerHTML = 'ğŸ—ºï¸<br>ç™½é»’åœ°å›³';

        previewBtn.classList.remove('active');
        previewBtnMobile.classList.remove('active');
        showNotification('ã‚«ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã—ã¾ã—ãŸ');
      }
      
      updateTileLayer();
      
      // æ—¢å­˜ã®ç·šã®è‰²ã‚’æ›´æ–°
      polylines.forEach(line => {
        const originalColor = line.customColor || currentColor;
        line.setStyle({ color: getLineColor(originalColor) });
      });
      
      // æç”»ä¸­ã®ç·šã‚‚æ›´æ–°
      if (currentPolyline) {
        currentPolyline.setStyle({ color: getLineColor(currentColor) });
      }
    }

    document.getElementById('toolPreview').addEventListener('click', handlePreview);
    document.getElementById('toolPreviewMobileBtn').addEventListener('click', handlePreview);

    // è‰²é¸æŠ
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const isModal = this.classList.contains('modal-color');
        const selector = isModal ? '.modal-color' : '.color-btn:not(.modal-color)';
        document.querySelectorAll(selector).forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentColor = this.dataset.color;
        
        // PC/ãƒ¢ãƒã‚¤ãƒ«ã‚’åŒæœŸ
        if (!isModal) {
          document.querySelectorAll('.modal-color').forEach(b => {
            b.classList.remove('active');
            if (b.dataset.color === currentColor) {
              b.classList.add('active');
            }
          });
        } else {
          document.querySelectorAll('.color-btn:not(.modal-color)').forEach(b => {
            b.classList.remove('active');
            if (b.dataset.color === currentColor) {
              b.classList.add('active');
            }
          });
        }
      });
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³
    async function saveCurrentMap() {
      autoCompleteOrCancelLine();
      
      const imageSizeStr = document.getElementById('imageSize').value;
      const [width, height] = imageSizeStr.split('x').map(Number);
      
      // ä¿å­˜ã®ä¸­å¿ƒã¨ã‚ºãƒ¼ãƒ ï¼ˆ18å›ºå®šï¼‰
      const saveZoom = 18;

      try {
        showNotification('â³ ç”»åƒã‚’ç”Ÿæˆä¸­...', 10000);
        
        // ä¿å­˜ä¸­å¿ƒãƒãƒ¼ã‚«ãƒ¼ã¨ç¯„å›²æ ã‚’ä¸€æ™‚çš„ã«éè¡¨ç¤º
        document.getElementById('saveCenterMarker').style.display = 'none';
        document.getElementById('saveCenterLabel').style.display = 'none';
        document.getElementById('saveRangePreview').style.display = 'none';

        const tempDiv = document.createElement('div');
        tempDiv.style.width = width + 'px';
        tempDiv.style.height = height + 'px';
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        tempDiv.style.top = '0';
        tempDiv.id = 'tempMap';
        document.body.appendChild(tempDiv);

        const tempMap = L.map('tempMap', {
          zoomControl: false,
          attributionControl: false,
          preferCanvas: true
        });

        // ä¿å­˜ä¸­å¿ƒã‚’ä½¿ç”¨ã€ã‚ºãƒ¼ãƒ 18å›ºå®š
        tempMap.setView([saveCenterLatLng.lat, saveCenterLatLng.lng], saveZoom);

        const stadiaApiKey = 'bd319ee8-343b-42e5-b811-a449c58bef78';
        let tileUrl;
        
        if (isPreviewMode) {
          tileUrl = `https://tiles.stadiamaps.com/tiles/stamen_toner_background/{z}/{x}/{y}{r}.png?api_key=${stadiaApiKey}`;
        } else {
          tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        }

        const tempTileLayer = L.tileLayer(tileUrl, { 
          maxZoom: 19,
          crossOrigin: true
        }).addTo(tempMap);

        await new Promise((resolve) => {
          tempTileLayer.on('load', () => {
            setTimeout(resolve, 500);
          });
          setTimeout(resolve, 3000);
        });

        // ç·šã‚’è¿½åŠ ï¼ˆå…ƒã®è‰²ã‚’ä½¿ç”¨ï¼‰
        polylines.forEach(line => {
          const latlngs = line.getLatLngs();
          const originalColor = line.customColor || currentColor;
          const displayColor = isPreviewMode ? getLineColor(originalColor) : originalColor;
          L.polyline(latlngs, {
            color: displayColor,
            weight: 4,
            opacity: 0.8
          }).addTo(tempMap);
        });

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        markers.forEach(marker => {
          const latlng = marker.getLatLng();
          const icon = marker.options.icon;
          L.marker([latlng.lat, latlng.lng], { icon: icon }).addTo(tempMap);
        });

        await new Promise(resolve => setTimeout(resolve, 1000));

        // ç”»åƒåŒ–
        const canvas = await html2canvas(tempDiv, {
          useCORS: true,
          allowTaint: false,
          backgroundColor: '#ffffff',
          scale: 1,
          logging: false
        });

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10);
        const mode = isPreviewMode ? 'ç™½é»’åœ°å›³' : 'ã‚«ãƒ©ãƒ¼åœ°å›³';
        link.download = `é€šå­¦è·¯åœ°å›³_${mode}_zoom${saveZoom}_${timestamp}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        // å¾Œç‰‡ä»˜ã‘
        tempMap.remove();
        document.body.removeChild(tempDiv);
        
        // ä¿å­˜ä¸­å¿ƒãƒãƒ¼ã‚«ãƒ¼ã¨ç¯„å›²æ ã‚’å†è¡¨ç¤º
        document.getElementById('saveCenterMarker').style.display = 'flex';
        document.getElementById('saveCenterLabel').style.display = 'block';
        document.getElementById('saveRangePreview').style.display = 'block';

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œï¼‰
        showNotification('âœ… åœ°å›³ã‚’ä¿å­˜ã—ã¾ã—ãŸ! (ã‚ºãƒ¼ãƒ 18ãƒ»30mç¸®å°º)', 3000);

      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒãƒ¼ã‚«ãƒ¼ã¨ç¯„å›²æ ã‚’å†è¡¨ç¤º
        document.getElementById('saveCenterMarker').style.display = 'flex';
        document.getElementById('saveCenterLabel').style.display = 'block';
        document.getElementById('saveRangePreview').style.display = 'block';
        
        showNotification('âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 3000);
        console.error(error);
      }
    }

    document.getElementById('toolSave').addEventListener('click', saveCurrentMap);
    document.getElementById('toolSaveMobile').addEventListener('click', saveCurrentMap);

    // ä¿å­˜ä¸­å¿ƒã‚’è¡¨ç¤ºä¸­å¿ƒã«ç§»å‹•
    function moveSaveCenterToViewCenter() {
      autoCompleteOrCancelLine();
      
      saveCenterLatLng = map.getCenter();
      updateSaveCenterMarkerPosition();
      showNotification('âœ… ä¿å­˜ä¸­å¿ƒã‚’ç¾åœ¨ã®è¡¨ç¤ºä¸­å¿ƒã«ç§»å‹•ã—ã¾ã—ãŸ');
    }

    document.getElementById('centerToView').addEventListener('click', moveSaveCenterToViewCenter);
    document.getElementById('centerToViewMobile').addEventListener('click', function() {
      moveSaveCenterToViewCenter();
      document.getElementById('modalOverlay').classList.remove('show');
    });
    document.getElementById('centerToViewMobileBtn').addEventListener('click', moveSaveCenterToViewCenter);

    // å ´æ‰€æ¤œç´¢
    async function handleSearch() {
      const address = document.getElementById('addressInput').value.trim();
      if (!address) {
        showNotification('å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?` + 
          `format=json&q=${encodeURIComponent(address)}&limit=1&countrycodes=jp`
        );
        
        const data = await response.json();
        
        if (data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          map.setView([lat, lon], 18);
          
          // æ¤œç´¢åœ°ç‚¹ã‚’ä¿å­˜ä¸­å¿ƒã«è¨­å®š
          saveCenterLatLng = L.latLng(lat, lon);
          updateSaveCenterMarkerPosition();
          
          showNotification('âœ… å ´æ‰€ã«ç§»å‹•ã—ã¾ã—ãŸï¼ˆä¿å­˜ä¸­å¿ƒã‚‚è¨­å®šï¼‰', 3000);
        } else {
          showNotification('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 3000);
        }
      } catch (error) {
        showNotification('æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 3000);
      }
    }

    document.getElementById('searchBtn').addEventListener('click', handleSearch);
    document.getElementById('addressInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleSearch();
      }
    });

    // åœ°å›³ã‚¯ãƒªãƒƒã‚¯
    map.on('click', function(e) {
      if (currentTool === 'pin') {
        const iconType = document.getElementById('iconType').value;
        const labelText = document.getElementById('labelInput').value.trim();
        let icon;

        if (iconType === 'none') {
          if (labelText) {
            icon = createLabeledIcon('', labelText, 30, true);
          } else {
            icon = createDotIcon(currentColor);
          }
        } else {
          const emoji = iconEmojiMap[iconType];
          if (labelText) {
            icon = createLabeledIcon(emoji, labelText, 30, false);
          } else {
            icon = createEmojiIcon(emoji, 30);
          }
        }

        const marker = L.marker([e.latlng.lat, e.latlng.lng], { 
          icon: icon,
          draggable: false
        }).addTo(map);

        marker.customLabel = labelText;
        marker.customColor = currentColor;
        marker.customIconType = iconType;
        
        markers.push(marker);
        addToHistory('marker', marker);
        updateStats();
        
        document.getElementById('labelInput').value = '';
        document.getElementById('labelInputMobile').value = '';
        
        showNotification('ğŸ“ ãƒ”ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      } 
      else if (currentTool === 'line') {
        polylinePoints.push([e.latlng.lat, e.latlng.lng]);

        if (polylinePoints.length === 1) {
          currentLineStartMarker = L.marker([e.latlng.lat, e.latlng.lng], {
            icon: createLineStartMarker()
          }).addTo(map);
          showHelp('ğŸ“ æ¬¡ã®ç‚¹ã‚’ã‚¿ãƒƒãƒ—');
        }

        if (currentPolyline) {
          map.removeLayer(currentPolyline);
        }

        currentPolyline = L.polyline(polylinePoints, {
          color: getLineColor(currentColor),
          weight: 4,
          opacity: 0.8
        }).addTo(map);
        
        // å…ƒã®è‰²ã‚’ä¿å­˜
        currentPolyline.customColor = currentColor;

        if (polylinePoints.length > 1) {
          showNotification(`ç·šã«ç‚¹ã‚’è¿½åŠ ï¼ˆ${polylinePoints.length}ç‚¹ç›®ï¼‰`);
          showCompleteButton();
        }
      }
    });

    // å³ã‚¯ãƒªãƒƒã‚¯ã§ç·šã‚’å®Œäº†
    map.on('contextmenu', function(e) {
      if (currentTool === 'line' && currentPolyline && polylinePoints.length > 1) {
        e.originalEvent.preventDefault();
        completeLine();
      }
    });

    // Escã‚­ãƒ¼
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && currentTool === 'line') {
        if (currentPolyline && polylinePoints.length > 1) {
          completeLine();
        } else {
          if (currentPolyline) {
            map.removeLayer(currentPolyline);
            currentPolyline = null;
          }
          if (currentLineStartMarker) {
            map.removeLayer(currentLineStartMarker);
            currentLineStartMarker = null;
          }
          polylinePoints = [];
          hideCompleteButton();
          showNotification('ç·šæç”»ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
          showHelp('ğŸ“ ç·šã®å§‹ç‚¹ã‚’ã‚¿ãƒƒãƒ—');
        }
      } else if (e.key === 'Escape') {
        setTool(null);
      }
    });

    // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿
    document.getElementById('toolbarToggle').addEventListener('click', function() {
      const content = document.getElementById('toolbarContent');
      content.classList.toggle('collapsed');
      this.textContent = content.classList.contains('collapsed') ? '+' : 'âˆ’';
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    document.getElementById('settingsBtnMobile').addEventListener('click', function() {
      document.getElementById('modalOverlay').classList.add('show');
    });

    document.getElementById('modalClose').addEventListener('click', function() {
      document.getElementById('modalOverlay').classList.remove('show');
    });

    document.getElementById('modalOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
      }
    });

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒ»å…¥åŠ›ã®åŒæœŸ
    document.getElementById('iconType').addEventListener('change', function() {
      document.getElementById('iconTypeMobile').value = this.value;
    });

    document.getElementById('iconTypeMobile').addEventListener('change', function() {
      document.getElementById('iconType').value = this.value;
    });

    document.getElementById('imageSize').addEventListener('change', function() {
      document.getElementById('imageSizeMobile').value = this.value;
      updateSaveRangePreview();
    });

    document.getElementById('imageSizeMobile').addEventListener('change', function() {
      document.getElementById('imageSize').value = this.value;
      updateSaveRangePreview();
    });

    document.getElementById('labelInput').addEventListener('input', function() {
      document.getElementById('labelInputMobile').value = this.value;
    });

    document.getElementById('labelInputMobile').addEventListener('input', function() {
      document.getElementById('labelInput').value = this.value;
    });

    // ã‚¹ã‚±ãƒ¼ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    L.control.scale({
      imperial: false,
      metric: true
    }).addTo(map);

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
    window.addEventListener('resize', function() {
      updateSaveCenterMarkerPosition();
    });

    // åˆæœŸçŠ¶æ…‹
    updateUndoButton();
    updateStats();
  </script>
</body>
</html>