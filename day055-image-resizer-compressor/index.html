<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- OGP (Open Graph Protocol) -->
    <meta property="og:title" content="画像リサイズ・圧縮ツール - ブラウザで簡単画像編集" />
    <meta property="og:description" content="ブラウザ上でJPEG/PNG画像のリサイズと圧縮ができる便利ツール。データ送信なしで安心・高速に処理。複数ファイルのバッチ処理も可能。" />
    <meta property="og:image" content="https://hiroe28.github.io/llm-100days-challenge/day055-image-resizer-compressor/screenshot.png" />
    <meta property="og:url" content="https://hiroe28.github.io/llm-100days-challenge/day055-image-resizer-compressor/index.html" />
    <meta property="og:type" content="website" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="画像リサイズ・圧縮ツール" />
    <meta name="twitter:description" content="ブラウザで画像を安全にリサイズ・圧縮。データ送信なしのプライバシー重視設計。複数ファイルの一括処理、ZIPダウンロード対応の便利ツール。" />
    <meta name="twitter:image" content="https://hiroe28.github.io/llm-100days-challenge/day055-image-resizer-compressor/screenshot.png" />

    <title>画像リサイズ・圧縮ツール</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H1SW0RH6CK"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-H1SW0RH6CK');
    </script>

    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

    

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #f5f9fc;
            --accent-color: #6ee7b7;
            --text-color: #333;
            --light-gray: #f3f4f6;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
            position: relative; /* コンテナに相対位置を設定 */
        }

        .drop-area {
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background-color: var(--light-gray);
        }

        .drop-area.highlight {
            border-color: var(--accent-color);
            background-color: rgba(110, 231, 183, 0.1);
        }

        .drop-area i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .drop-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .browse-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .browse-btn:hover {
            background-color: #3451b2;
        }

        /* 添付ファイル一覧のスタイル */
        .file-list-container {
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .file-list-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: var(--light-gray);
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            background-color: white;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item-left {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .file-item-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .file-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-size {
            margin: 0 10px;
            color: #666;
            font-size: 0.9rem;
        }

        .file-item-delete {
            background: none;
            border: none;
            color: #ff4d4f;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .file-item-delete:hover {
            background-color: rgba(255, 77, 79, 0.1);
        }
        
        .options-container {
            display: none;
            margin-top: 30px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .option-group {
            background-color: var(--light-gray);
            padding: 20px;
            border-radius: var(--border-radius);
        }

        .option-group h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .option-group h3 i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .option-row {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .quality-slider {
            width: 100%;
            margin-top: 10px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-container input {
            margin-right: 10px;
        }

        .preview-container {
            display: none;
            margin-top: 30px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .preview-title {
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .preview-box {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .preview-box h4 {
            padding: 10px;
            background-color: var(--light-gray);
            border-bottom: 1px solid #ddd;
        }

        .preview-image-container {
            padding: 10px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
        }

        .image-info {
            padding: 10px;
            background-color: var(--light-gray);
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3451b2;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        /* 処理中表示の改善 - モーダルスタイルに変更 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            max-width: 300px;
            width: 100%;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .loading-text {
            font-size: 1.2rem;
            margin-top: 15px;
            color: var(--text-color);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        footer {
            text-align: center;
            margin-top: auto;
            padding: 20px 0;
            color: #666;
            font-size: 0.9rem;
        }


        .batch-info {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            display: none;
        }


        .batch-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: white;
        }

        .batch-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .batch-item:last-child {
            border-bottom: none;
        }

        .batch-progress {
            width: 100%;
            margin-top: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #eee;
            overflow: hidden;
        }

        .batch-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }

        /* 比較表示のスタイル */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .comparison-table th {
            background-color: var(--light-gray);
            font-weight: 600;
        }
        
        .comparison-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        
        .badge-success {
            background-color: #10b981;
        }
        
        .badge-warning {
            background-color: #f59e0b;
        }
        
        .badge-info {
            background-color: var(--primary-color);
        }
        
        .arrow-icon {
            color: #9ca3af;
            margin: 0 5px;
        }
        
        .main-action-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
        }
        
        /* 統一されたアクションボタン */
        .process-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .process-title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .options-grid,
            .preview-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>画像リサイズ・圧縮ツール</h1>
        <p class="subtitle">ブラウザ上で画像をリサイズ・圧縮 - データ送信なし、安心・高速</p>
    </header>

    <div class="container">
        <div id="dropArea" class="drop-area">
            <i class="fas fa-cloud-upload-alt"></i>
            <p class="drop-text">画像をドラッグ＆ドロップ（複数可）</p>
            <p>または</p>
            <label for="fileInput" class="browse-btn">ファイルを選択（複数可）</label>
            <input type="file" id="fileInput" class="file-input" accept="image/jpeg, image/png" multiple>
            <p style="margin-top: 10px;">
                <label for="folderInput" class="browse-btn">フォルダを選択</label>
                <input type="file" id="folderInput" class="file-input" webkitdirectory directory multiple>
            </p>
        </div>

        <!-- 添付ファイル一覧 -->
        <div id="fileListContainer" class="file-list-container">
            <div class="file-list-header">
                <h3 class="file-list-title"><i class="fas fa-images"></i> 添付ファイル一覧</h3>
                <div>
                    <button id="addMoreBtn" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> ファイル追加
                    </button>
                </div>
            </div>
            <div id="fileList" class="file-list">
                <!-- ファイル一覧がここに表示されます -->
            </div>
        </div>

        <div id="optionsContainer" class="options-container" style="display: block;">
            <div class="options-grid">
                <div class="option-group">
                    <h3><i class="fas fa-crop-alt"></i> リサイズオプション</h3>
                    <div class="option-row">
                        <label for="resizeMethod">リサイズ方法</label>
                        <select id="resizeMethod">
                            <option value="percentage">パーセンテージ</option>
                            <option value="dimensions">サイズ指定</option>
                        </select>
                    </div>
                    <div id="dimensionsGroup">
                        <div class="option-row">
                            <label for="width">幅 (px)</label>
                            <input type="number" id="width" min="1">
                        </div>
                        <div class="option-row">
                            <label for="height">高さ (px)</label>
                            <input type="number" id="height" min="1">
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="maintainAspectRatio" checked>
                            <label for="maintainAspectRatio">縦横比を維持</label>
                        </div>
                    </div>
                    <div id="percentageGroup" style="display: none;">
                        <div class="option-row">
                            <label for="percentage">サイズ変更率 (%)</label>
                            <input type="number" id="percentage" min="1" max="100" value="50">
                        </div>
                    </div>
                </div>

                <div class="option-group">
                    <h3><i class="fas fa-compress-alt"></i> 圧縮オプション</h3>
                    <div class="option-row">
                        <label for="format">出力フォーマット</label>
                        <select id="format">
                            <option value="jpeg">JPEG</option>
                            <option value="png">PNG</option>
                        </select>
                    </div>
                    <div id="jpegOptions">
                        <div class="option-row">
                            <label for="quality">画質 (<span id="qualityValue">80</span>%)</label>
                            <input type="range" id="quality" class="quality-slider" min="0" max="100" value="80">
                        </div>
                    </div>
                </div>
                
                <div class="option-group">
                    <h3><i class="fas fa-file-export"></i> 出力オプション</h3>
                    <div class="option-row">
                        <label for="filename">ファイル名</label>
                        <input type="text" id="filename">
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="processBatchBtn" class="btn btn-primary main-action-btn">
                    <i class="fas fa-magic"></i> 画像を処理
                </button>
                <button id="resetBtn" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> リセット
                </button>
            </div>
        </div>

        <div id="previewContainer" class="preview-container">
            <div class="preview-header">
                <h3 class="preview-title">処理結果</h3>
            </div>

            <div class="batch-info" id="batchInfo">
                <h3><i class="fas fa-tasks"></i> 画像処理</h3>
                <p><span id="batchCount">0</span>個の画像が選択されています</p>
                <div class="batch-list" id="batchList"></div>
                <div class="batch-progress">
                    <div class="batch-progress-bar" id="batchProgressBar"></div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="downloadBtn" class="btn btn-primary">
                    <i class="fas fa-download"></i> ダウンロード
                </button>
                <button id="downloadZipBtn" class="btn btn-primary">
                    <i class="fas fa-file-archive"></i> ZIPでダウンロード
                </button>
                <button id="newImageBtn" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> 新しい画像
                </button>
            </div>
        </div>
    </div>

    <!-- 処理中のモーダル表示 -->
    <div id="loadingIndicator" class="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="loading-text">画像処理中...</p>
        </div>
    </div>

    <footer>
        <p>© 2025 画像リサイズ・圧縮ツール | すべての処理はブラウザで行われ、データは外部に送信されません</p>
    </footer>

    <!-- JSZip ライブラリの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // DOM要素の参照を取得
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const optionsContainer = document.getElementById('optionsContainer');
        const previewContainer = document.getElementById('previewContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resizeMethod = document.getElementById('resizeMethod');
        const dimensionsGroup = document.getElementById('dimensionsGroup');
        const percentageGroup = document.getElementById('percentageGroup');
        const widthInput = document.getElementById('width');
        const heightInput = document.getElementById('height');
        const maintainAspectRatio = document.getElementById('maintainAspectRatio');
        const percentageInput = document.getElementById('percentage');
        const formatSelect = document.getElementById('format');
        const jpegOptions = document.getElementById('jpegOptions');
        const qualityInput = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        const filenameInput = document.getElementById('filename');
        const processBatchBtn = document.getElementById('processBatchBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const newImageBtn = document.getElementById('newImageBtn');
        
        // バッチ処理関連の要素
        const batchInfo = document.getElementById('batchInfo');
        const batchCount = document.getElementById('batchCount');
        const batchList = document.getElementById('batchList');
        const batchProgressBar = document.getElementById('batchProgressBar');

        // グローバル変数
        let originalImage = null;
        let processedImageBlob = null;
        let originalAspectRatio = 0;
        let batchFiles = [];
        let processedBatchFiles = [];
        let isBatchMode = false; // バッチモードフラグ
        let originalFileSize = 0; // 元のファイルサイズを保存するグローバル変数
        let userChangedFormat = false; // ユーザーが意図的にフォーマットを変更したかのフラグ
        let originalFileFormat = null; // 元のファイルフォーマットを保存
        
        // フォーム要素の初期無効化
        function disableFormElements(disabled = true) {
            const formElements = [
                widthInput, heightInput, percentageInput, 
                formatSelect, qualityInput, filenameInput,
                processBatchBtn
            ];
            
            formElements.forEach(element => {
                element.disabled = disabled;
            });
        }

        // リサイズ方法の切り替え
        function toggleResizeMethod() {
            if (resizeMethod.value === 'dimensions') {
                dimensionsGroup.style.display = 'block';
                percentageGroup.style.display = 'none';
            } else {
                dimensionsGroup.style.display = 'none';
                percentageGroup.style.display = 'block';
            }
        }

        // フォーマットオプションの切り替え
        function toggleFormatOptions() {
            // ユーザーが手動で変更した場合のみフラグを設定
            userChangedFormat = true;
            
            if (formatSelect.value === 'jpeg') {
                jpegOptions.style.display = 'block';
            } else {
                jpegOptions.style.display = 'none';
            }
        }

        // 画質値の更新表示
        function updateQualityValue() {
            qualityValue.textContent = qualityInput.value;
        }

        // 初期化
        function init() {
            setupEventListeners();
            disableFormElements(true);
            toggleResizeMethod();
            toggleFormatOptions();
            userChangedFormat = false; // 初期状態ではユーザー変更なし
            // loadingIndicatorのスタイルをflexに設定 (display: noneはそのまま)
            loadingIndicator.style.display = 'none';
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // ドラッグ&ドロップのイベント
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
            folderInput.addEventListener('change', handleFolderSelect, false);

            // ファイル追加ボタンのイベント
            addMoreBtn.addEventListener('click', () => {
                dropArea.style.display = 'block';
            });

            // オプション変更のイベント
            resizeMethod.addEventListener('change', toggleResizeMethod);
            formatSelect.addEventListener('change', toggleFormatOptions);
            qualityInput.addEventListener('input', updateQualityValue);
            
            // 縦横比維持の処理
            widthInput.addEventListener('input', () => {
                if (maintainAspectRatio.checked && originalAspectRatio > 0) {
                    heightInput.value = Math.round(widthInput.value / originalAspectRatio);
                }
            });

            heightInput.addEventListener('input', () => {
                if (maintainAspectRatio.checked && originalAspectRatio > 0) {
                    widthInput.value = Math.round(heightInput.value * originalAspectRatio);
                }
            });

            // ボタンのイベント
            processBatchBtn.addEventListener('click', function() {
                // 処理中表示を先に表示
                loadingIndicator.style.display = 'flex';
                
                // 少し遅延させて処理を実行（UIの更新が確実に行われるため）
                setTimeout(() => {
                    if (isBatchMode) {
                        processBatchImages();
                    } else {
                        processSingleImage();
                    }
                }, 50);
            });
            
            resetBtn.addEventListener('click', resetAll);
            downloadBtn.addEventListener('click', downloadImage);
            downloadZipBtn.addEventListener('click', downloadAsZip);
            newImageBtn.addEventListener('click', () => {
                previewContainer.style.display = 'none';
                dropArea.style.display = 'block';
                userChangedFormat = false; // 新しい画像選択時にフラグをリセット
            });
        }

        // デフォルト動作の防止
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // ドロップエリアのハイライト
        function highlight() {
            dropArea.classList.add('highlight');
        }

        // ドロップエリアのハイライト解除
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        // ファイル一覧の更新
        function updateFileList() {
            fileList.innerHTML = '';
            
            if (batchFiles.length === 0) {
                fileListContainer.style.display = 'none';
                return;
            }
            
            batchFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                // ファイルアイコン（タイプに基づいて）
                const iconClass = file.type.includes('jpeg') ? 'fa-file-image' : 'fa-file-image';
                
                fileItem.innerHTML = `
                    <div class="file-item-left">
                        <i class="fas ${iconClass} file-item-icon"></i>
                        <span class="file-item-name">${file.name}</span>
                    </div>
                    <span class="file-item-size">${formatFileSize(file.size)}</span>
                    <button class="file-item-delete" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                fileList.appendChild(fileItem);
                
                // 削除ボタンのイベントリスナー
                const deleteBtn = fileItem.querySelector('.file-item-delete');
                deleteBtn.addEventListener('click', (e) => {
                    const idx = parseInt(e.currentTarget.getAttribute('data-index'));
                    removeFile(idx);
                });
            });
            
            fileListContainer.style.display = 'block';
            
            // ファイル数の更新
            batchCount.textContent = batchFiles.length;
            
            // 複数ファイルの場合はバッチモードに設定
            isBatchMode = batchFiles.length > 1;
            
            // 単一ファイルの場合はファイル名を設定
            if (batchFiles.length === 1) {
                const filename = batchFiles[0].name.replace(/\.[^/.]+$/, "");
                filenameInput.value = filename;
                
                // 単一ファイルの場合は画像情報をロード
                loadSingleFileInfo(batchFiles[0]);
            }
        }
        
        // 指定インデックスのファイルを削除
        function removeFile(index) {
            if (index >= 0 && index < batchFiles.length) {
                batchFiles.splice(index, 1);
                updateFileList();
                
                // ファイルがなくなった場合は入力フォームを無効化
                if (batchFiles.length === 0) {
                    disableFormElements(true);
                    dropArea.style.display = 'block';
                }
            }
        }
        
        // 単一ファイルの情報をロード
        function loadSingleFileInfo(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                
                img.onload = function() {
                    originalImage = img;
                    originalAspectRatio = img.width / img.height;
                    
                    // 元の画像サイズをフォームに設定
                    widthInput.value = img.width;
                    heightInput.value = img.height;
                    
                    // UI更新
                    disableFormElements(false);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }

        // ドロップ処理
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        // 単一ファイル選択処理
        function handleFileSelect(e) {
            const files = e.target.files;
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }
        
        // フォルダ選択処理
        function handleFolderSelect(e) {
            const files = e.target.files;
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }
        
        // ファイル処理の共通関数
        function handleFiles(files) {
            // 画像ファイルのみをフィルタリング
            const imageFiles = Array.from(files).filter(file => 
                file.type.match('image/jpeg') || file.type.match('image/png')
            );
            
            if (imageFiles.length === 0) {
                alert('JPEGまたはPNG画像ファイルが見つかりませんでした。');
                return;
            }
            
            // 現在のファイルリストに追加
            batchFiles = [...batchFiles, ...imageFiles];
            
            // 最初のファイルタイプに基づいてフォーマットを設定
            if (batchFiles.length > 0 && !userChangedFormat) {
                setFormatFromFileType(batchFiles[0].type);
            }
            
            // UI更新
            dropArea.style.display = 'none';
            updateFileList();
            optionsContainer.style.display = 'block';
            disableFormElements(false);
            
            // バッチモードの設定
            isBatchMode = batchFiles.length > 1;
        }
        
        // ファイルタイプに基づいてフォーマットを設定
        function setFormatFromFileType(fileType) {
            userChangedFormat = false; // ユーザーによる変更ではない
            
            if (fileType === 'image/jpeg') {
                formatSelect.value = 'jpeg';
                jpegOptions.style.display = 'block';
                originalFileFormat = 'jpeg';
            } else if (fileType === 'image/png') {
                formatSelect.value = 'png';
                jpegOptions.style.display = 'none';
                originalFileFormat = 'png';
            }
        }
        
        // 単一ファイル処理（旧関数を修正）
        function processSingleFile(file) {
            // 画像ファイルであることを確認
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                alert('JPEGまたはPNG画像ファイルを選択してください。');
                return;
            }
            
            // バッチファイルに追加
            batchFiles = [file];
            
            // ファイルタイプに基づいてフォーマットを設定
            setFormatFromFileType(file.type);
            
            // UI更新
            dropArea.style.display = 'none';
            updateFileList();
            processedBatchFiles = [];
        }
        
        // バッチファイル処理（旧関数を修正）
        function processBatchFiles(files) {
            handleFiles(files);
        }

        // 単一画像処理
        function processSingleImage() {
            if (batchFiles.length === 0) {
                loadingIndicator.style.display = 'none';
                return;
            }
            
            const file = batchFiles[0];
            
            // バッチ情報表示
            batchInfo.style.display = 'block';
            batchCount.textContent = 1;
            batchList.innerHTML = `
                <div class="batch-item">
                    <span>${file.name}</span>
                    <span>${formatFileSize(file.size)}</span>
                </div>
            `;
            
            // リサイズパラメータの取得
            let newWidth, newHeight, percentage, quality;
            
            if (resizeMethod.value === 'dimensions') {
                newWidth = parseInt(widthInput.value) || originalImage.width;
                newHeight = parseInt(heightInput.value) || originalImage.height;
                percentage = null;
            } else {
                percentage = parseInt(percentageInput.value) / 100 || 0.5;
                newWidth = null;
                newHeight = null;
            }
            
            quality = parseInt(qualityInput.value) / 100 || 0.8;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                
                img.onload = function() {
                    // サイズ計算
                    let targetWidth, targetHeight;
                    
                    if (percentage !== null) {
                        targetWidth = Math.round(img.width * percentage);
                        targetHeight = Math.round(img.height * percentage);
                    } else {
                        targetWidth = newWidth;
                        targetHeight = newHeight;
                        
                        // 縦横比維持
                        if (maintainAspectRatio.checked) {
                            const aspectRatio = img.width / img.height;
                            if (targetWidth / targetHeight > aspectRatio) {
                                targetWidth = Math.round(targetHeight * aspectRatio);
                            } else {
                                targetHeight = Math.round(targetWidth / aspectRatio);
                            }
                        }
                    }
                    
                    // Canvas でリサイズ
                    const canvas = document.createElement('canvas');
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                    
                    // 元のファイルフォーマットを使用するか、ユーザーが選択したフォーマットを使用
                    let mimeType;
                    let fileExtension;
                    
                    if (userChangedFormat) {
                        // ユーザーが変更した場合はその選択を優先
                        mimeType = formatSelect.value === 'jpeg' ? 'image/jpeg' : 'image/png';
                        fileExtension = formatSelect.value === 'jpeg' ? '.jpg' : '.png';
                    } else {
                        // ユーザーが変更していない場合は元のファイルの形式を使用
                        if (file.type === 'image/jpeg') {
                            mimeType = 'image/jpeg';
                            fileExtension = '.jpg';
                        } else {
                            mimeType = 'image/png';
                            fileExtension = '.png';
                        }
                    }
                    
                    // 画像データの生成
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            console.error('Blob creation failed');
                            loadingIndicator.style.display = 'none';
                            return;
                        }
                        
                        processedImageBlob = blob;
                        
                        // プレビューコンテナを表示
                        previewContainer.style.display = 'block';
                        
                        // 圧縮率の計算
                        const compressionRate = Math.round((1 - (blob.size / file.size)) * 100);
                        let badgeClass = 'badge-info';
                        if (compressionRate >= 50) {
                            badgeClass = 'badge-success';
                        } else if (compressionRate < 20) {
                            badgeClass = 'badge-warning';
                        }
                        
                        // バッチリストに処理結果を表示
                        batchList.innerHTML = `
                            <div class="batch-item">
                                <span>${file.name}</span>
                                <span>
                                    ${formatFileSize(file.size)} → ${formatFileSize(blob.size)}
                                    <span class="comparison-badge ${badgeClass}" style="margin-left: 5px;">
                                        ${compressionRate > 0 ? '-' : '+'}${Math.abs(compressionRate)}%
                                    </span>
                                </span>
                            </div>
                        `;
                        
                        // 処理済みバッチファイルに追加
                        const filename = file.name.replace(/\.[^/.]+$/, "");
                        
                        processedBatchFiles = [{
                            originalName: file.name,
                            newName: filenameInput.value + fileExtension || filename + fileExtension,
                            blob: blob,
                            originalSize: file.size,
                            newSize: blob.size,
                            originalDimensions: `${img.width}x${img.height}`,
                            newDimensions: `${targetWidth}x${targetHeight}`
                        }];
                        
                        // UI更新
                        loadingIndicator.style.display = 'none';
                        downloadBtn.style.display = 'inline-flex';
                        downloadZipBtn.style.display = 'none';
                        batchProgressBar.style.width = '100%';
                    }, mimeType, quality);
                };
                
                img.onerror = function() {
                    console.error('Image loading error');
                    loadingIndicator.style.display = 'none';
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                console.error('File reading error');
                loadingIndicator.style.display = 'none';
            };
            
            reader.readAsDataURL(file);
        }

        // バッチ画像処理
        function processBatchImages() {
            if (batchFiles.length === 0) {
                loadingIndicator.style.display = 'none';
                return;
            }
            
            processBatchBtn.disabled = true;
            downloadZipBtn.style.display = 'none'; // 処理中はボタンを非表示に
            
            const totalFiles = batchFiles.length;
            let processed = 0;
            processedBatchFiles = [];
            
            // リサイズパラメータの取得
            let newWidth, newHeight, percentage, quality;
            
            if (resizeMethod.value === 'dimensions') {
                newWidth = parseInt(widthInput.value) || 800; // デフォルト値を設定
                newHeight = parseInt(heightInput.value) || 600; // デフォルト値を設定
                percentage = null;
            } else {
                percentage = parseInt(percentageInput.value) / 100 || 0.5; // デフォルト値を設定
                newWidth = null;
                newHeight = null;
            }
            
            quality = parseInt(qualityInput.value) / 100 || 0.8; // デフォルト値を設定
            
            // バッチ情報の表示
            batchInfo.style.display = 'block';
            batchList.innerHTML = '';
            batchFiles.forEach((file) => {
                batchList.innerHTML += `
                    <div class="batch-item">
                        <span>${file.name}</span>
                        <span>${formatFileSize(file.size)}</span>
                    </div>
                `;
            });
            
            // 各ファイルを順番に処理
            processNextBatchFile(0, totalFiles, processed, newWidth, newHeight, percentage, quality);
        }
        
        // バッチファイルの順次処理
        function processNextBatchFile(index, total, processed, newWidth, newHeight, percentage, quality) {
            if (index >= total) {
                // すべてのファイル処理完了
                loadingIndicator.style.display = 'none';
                processBatchBtn.disabled = false;
                
                // プレビューコンテナを表示
                previewContainer.style.display = 'block';
                
                // バッチモードの場合のみZIPダウンロードボタンを表示
                if (isBatchMode && processedBatchFiles.length > 1) {
                    downloadZipBtn.style.display = 'inline-flex';
                    downloadBtn.style.display = 'none';
                } else {
                    downloadZipBtn.style.display = 'none';
                    downloadBtn.style.display = 'inline-flex';
                }
                
                batchProgressBar.style.width = '100%';
                
                // サマリー情報表示
                if (total > 0) {
                    let totalOriginalSize = 0;
                    let totalProcessedSize = 0;
                    
                    processedBatchFiles.forEach(file => {
                        totalOriginalSize += file.originalSize || 0;
                        totalProcessedSize += file.newSize || 0;
                    });
                    
                    // 0で割らないように注意
                    const compressionRate = totalOriginalSize > 0 ? 
                        Math.round((1 - (totalProcessedSize / totalOriginalSize)) * 100) : 0;
                    
                    let badgeClass = 'badge-info';
                    if (compressionRate >= 50) {
                        badgeClass = 'badge-success';
                    } else if (compressionRate < 20) {
                        badgeClass = 'badge-warning';
                    }
                    
                    // サマリー情報を表示
                    batchList.innerHTML += `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>処理前の合計サイズ:</strong>
                                <span>${formatFileSize(totalOriginalSize)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>処理後の合計サイズ:</strong>
                                <span>${formatFileSize(totalProcessedSize)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <strong>全体の圧縮率:</strong>
                                <span class="comparison-badge ${badgeClass}">
                                    ${compressionRate > 0 ? '-' : '+'}${Math.abs(compressionRate)}%
                                </span>
                            </div>
                        </div>
                    `;
                }
                
                return;
            }
            
            const file = batchFiles[index];
            if (!file) {
                // ファイルが存在しない場合は次のファイルへ
                processNextBatchFile(index + 1, total, processed, newWidth, newHeight, percentage, quality);
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                
                img.onload = function() {
                    // サイズ計算
                    let targetWidth, targetHeight;
                    
                    if (percentage !== null) {
                        targetWidth = Math.round(img.width * percentage);
                        targetHeight = Math.round(img.height * percentage);
                    } else {
                        targetWidth = newWidth;
                        targetHeight = newHeight;
                        
                        // 縦横比維持
                        if (maintainAspectRatio.checked) {
                            const aspectRatio = img.width / img.height;
                            if (targetWidth / targetHeight > aspectRatio) {
                                targetWidth = Math.round(targetHeight * aspectRatio);
                            } else {
                                targetHeight = Math.round(targetWidth / aspectRatio);
                            }
                        }
                    }
                    
                    // Canvas でリサイズ
                    const canvas = document.createElement('canvas');
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                    
                    // 元のファイルフォーマットを使用するか、ユーザーが選択したフォーマットを使用
                    let mimeType;
                    let fileExtension;
                    
                    if (userChangedFormat) {
                        // ユーザーが変更した場合はその選択を優先
                        mimeType = formatSelect.value === 'jpeg' ? 'image/jpeg' : 'image/png';
                        fileExtension = formatSelect.value === 'jpeg' ? '.jpg' : '.png';
                    } else {
                        // ユーザーが変更していない場合は元のファイルの形式を使用
                        if (file.type === 'image/jpeg') {
                            mimeType = 'image/jpeg';
                            fileExtension = '.jpg';
                        } else {
                            mimeType = 'image/png';
                            fileExtension = '.png';
                        }
                    }
                    
                    // 画像データの生成
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            console.error('Blob creation failed for file:', file.name);
                            
                            // エラーが発生しても次のファイルへ進む
                            processed++;
                            const progress = (processed / total) * 100;
                            batchProgressBar.style.width = progress + '%';
                            processNextBatchFile(index + 1, total, processed, newWidth, newHeight, percentage, quality);
                            return;
                        }
                        
                        // ファイル名（拡張子なし）
                        const filename = file.name.replace(/\.[^/.]+$/, "");
                        
                        // 処理済みファイル情報を保存
                        processedBatchFiles.push({
                            originalName: file.name,
                            newName: filename + fileExtension,
                            blob: blob,
                            originalSize: file.size || 0,
                            newSize: blob.size,
                            originalDimensions: `${img.width}x${img.height}`,
                            newDimensions: `${targetWidth}x${targetHeight}`
                        });
                        
                        // プレビュー関連の処理は不要
                        if (index === 0) {
                            // 単一ファイルモードの場合、処理済み画像を保存
                            if (!isBatchMode) {
                                processedImageBlob = blob;
                            }
                        }
                        
                        // リスト表示を更新
                        const fileSize = file.size || 0;
                        const compressionRate = fileSize > 0 ? Math.round((1 - (blob.size / fileSize)) * 100) : 0;
                        let badgeClass = 'badge-info';
                        if (compressionRate >= 50) {
                            badgeClass = 'badge-success';
                        } else if (compressionRate < 20) {
                            badgeClass = 'badge-warning';
                        }
                        
                        // リストの該当項目を更新
                        const items = batchList.querySelectorAll('.batch-item');
                        if (items[index]) {
                            items[index].innerHTML = `
                                <span>${file.name}</span>
                                <span>
                                    ${formatFileSize(file.size || 0)} → ${formatFileSize(blob.size)}
                                    <span class="comparison-badge ${badgeClass}" style="margin-left: 5px;">
                                        ${compressionRate > 0 ? '-' : '+'}${Math.abs(compressionRate)}%
                                    </span>
                                </span>
                            `;
                        }
                        
                        // 進捗表示更新
                        processed++;
                        const progress = (processed / total) * 100;
                        batchProgressBar.style.width = progress + '%';
                        
                        // 次のファイル処理
                        processNextBatchFile(index + 1, total, processed, newWidth, newHeight, percentage, quality);
                    }, mimeType, quality);
                };
                
                img.onerror = function() {
                    console.error('Image loading error for file:', file.name);
                    
                    // エラーが発生しても次のファイルへ進む
                    processed++;
                    const progress = (processed / total) * 100;
                    batchProgressBar.style.width = progress + '%';
                    processNextBatchFile(index + 1, total, processed, newWidth, newHeight, percentage, quality);
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                console.error('File reading error for file:', file.name);
                
                // エラーが発生しても次のファイルへ進む
                processed++;
                const progress = (processed / total) * 100;
                batchProgressBar.style.width = progress + '%';
                processNextBatchFile(index + 1, total, processed, newWidth, newHeight, percentage, quality);
            };
            
            // ファイルの読み込みを試みる
            try {
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error reading file:', error, file);
                
                // エラーが発生しても次のファイルへ進む
                processed++;
                const progress = (processed / total) * 100;
                batchProgressBar.style.width = progress + '%';
                processNextBatchFile(index + 1, total, processed, newWidth, newHeight, percentage, quality);
            }
        }
        
        // ZIP形式でダウンロード
        function downloadAsZip() {
            if (processedBatchFiles.length === 0) return;
            
            const zip = new JSZip();
            
            // 処理済みファイルをZIPに追加
            processedBatchFiles.forEach(file => {
                zip.file(file.newName, file.blob);
            });
            
            // ZIPファイルの生成とダウンロード
            zip.generateAsync({type: 'blob'}).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resized-images.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // ファイルサイズのフォーマット
        function formatFileSize(bytes) {
            if (bytes < 1024) {
                return bytes + ' B';
            } else if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            } else {
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        }

        // 処理済み画像のダウンロード
        function downloadImage() {
            if (isBatchMode && processedBatchFiles.length > 0) {
                // バッチモードで最初のファイルをダウンロード
                const file = processedBatchFiles[0];
                const url = URL.createObjectURL(file.blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = file.newName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else if (!isBatchMode && processedBatchFiles.length > 0) {
                // 単一ファイルモード
                const file = processedBatchFiles[0];
                const url = URL.createObjectURL(file.blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = file.newName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // すべてリセット
        function resetAll() {
            dropArea.style.display = 'block';
            fileListContainer.style.display = 'none';
            previewContainer.style.display = 'none';
            optionsContainer.style.display = 'block'; // オプション画面は表示したまま
            loadingIndicator.style.display = 'none';
            batchInfo.style.display = 'none';
            
            originalImage = null;
            processedImageBlob = null;
            originalAspectRatio = 0;
            batchFiles = [];
            processedBatchFiles = [];
            originalFileSize = 0;
            userChangedFormat = false;
            originalFileFormat = null;
            
            fileInput.value = '';
            folderInput.value = '';
            widthInput.value = '';
            heightInput.value = '';
            percentageInput.value = '50';
            qualityInput.value = '80';
            qualityValue.textContent = '80';
            filenameInput.value = '';
            
            resizeMethod.value = 'dimensions';
            formatSelect.value = 'jpeg';
            toggleResizeMethod();
            toggleFormatOptions();
            disableFormElements(true);
        }

        // 初期化の実行
        init();
    </script>
</body>
</html>